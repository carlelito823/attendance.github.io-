<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance Sheet</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Google Fonts - Montserrat -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to enhance Tailwind and achieve a minimalist look inspired by the provided image */
        body {
            font-family: 'Montserrat', sans-serif; /* Changed font to Montserrat */
            background-color: #f5f5f5; /* Very light gray, slightly warmer than previous f8f8f8 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); /* Softer, subtle shadow */
            width: 100%;
            max-width: 1200px;
            overflow: hidden;
        }
        .header {
            background-color: #ffffff; /* White header */
            color: #333333; /* Dark text */
            padding: 28px; /* Increased padding */
            text-align: center;
            border-bottom: 1px solid #eeeeee; /* Very subtle separator */
        }
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-weight: 700;
        }
        .header p {
            margin-top: 8px;
            font-size: 1rem;
            color: #666666; /* Muted gray for description */
        }
        .header .material-icons {
            color: #FFC107; /* Orange/Yellow accent from previous design, can be changed if a new accent is desired */
            font-size: 3.8rem; /* Slightly larger icon */
        }
        .time-display-container {
            display: flex;
            justify-content: center;
            gap: 30px; /* Space between the two clocks */
            margin-top: 15px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .time-box {
            background-color: #f0f0f0;
            padding: 10px 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 180px; /* Ensure boxes are not too small */
        }
        .time-box .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .time-box .time {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }


        .controls, .form-section {
            background-color: #ffffff; /* White background for sections */
            color: #333333; /* Dark text */
            padding: 20px 28px; /* Increased padding */
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #eeeeee; /* Subtle separator */
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* Specific styling for the new month/year picker look */
        .month-year-picker select {
            -webkit-appearance: none; /* Remove default dropdown arrow */
            -moz-appearance: none;
            appearance: none;
            background-image: none; /* No custom arrow for minimalist look */
            border: none; /* No border */
            padding: 0; /* No padding */
            font-size: 1.1em; /* Slightly larger font */
            font-weight: 600; /* Semi-bold */
            color: #333333; /* Darker text */
            text-align: center;
            outline: none;
            cursor: pointer;
            min-width: 80px; /* Ensure enough space */
        }
        .month-year-picker .picker-underline {
            border-bottom: 2px solid #FFC107; /* Accent color underline */
            padding-bottom: 2px; /* Small space between text and line */
            display: inline-block; /* To apply width to the underline */
        }
        .month-year-picker button {
            background: none;
            border: none;
            color: #666666; /* Muted gray for icons */
            font-size: 1.8em;
            cursor: pointer;
            padding: 0 5px; /* Small padding for click area */
            transition: color 0.2s ease;
        }
        .month-year-picker button:hover {
            color: #FFC107;
        }

        /* Calendar Picker Specific Styles */
        .calendar-picker {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 20px;
            width: 320px; /* Fixed width for the picker */
            position: absolute; /* Position absolutely to appear as a pop-up */
            z-index: 100;
            display: none; /* Hidden by default */
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-header .month-year-display {
            font-size: 1.2em;
            font-weight: 600;
            color: #333333;
        }
        .calendar-header button {
            background: none;
            border: none;
            color: #666666;
            font-size: 1.5em;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .calendar-header button:hover {
            color: #FFC107;
        }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: 600;
            color: #999999;
            margin-bottom: 10px;
        }
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            padding: 8px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: #333333;
        }
        .calendar-day.other-month {
            color: #cccccc; /* Faded color for days of other months */
        }
        .calendar-day:hover {
            background-color: #f0f0f0;
        }
        .calendar-day.selected {
            background-color: #6b46c1; /* Purple accent for selected date */
            color: white;
            font-weight: 700;
        }
        .calendar-day.today {
            /* Removed border for today's date */
            border: none;
        }
        /* New style for days with student attendance */
        .calendar-day.has-students {
            background-color: #d1e7dd; /* A light green background */
            font-weight: 600;
        }
        .calendar-day.has-students:hover {
            background-color: #c0e0cc; /* Slightly darker on hover */
        }
        /* Ensure selected state overrides has-students if both apply */
        .calendar-day.selected.has-students {
            background-color: #6b46c1; /* Keep selected color */
            color: white;
        }

        .calendar-footer {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .calendar-footer button {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease;
            background-color: #eeeeee;
            color: #333333;
        }
        .calendar-footer button:hover {
            background-color: #dddddd;
        }


        .summary-section {
            background-color: #f5f5f5; /* Light gray background for summary, matching body */
            padding: 20px 28px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Responsive grid, adjusted minmax for smaller boxes */
            gap: 20px;
            border-bottom: 1px solid #eeeeee; /* Subtle separator */
        }
        .summary-box {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            text-align: center; /* Center text within the summary boxes */
        }
        /* New styles for present/absent summary boxes with background colors */
        .summary-box.present-box {
            background-color: #e6ffe6; /* Very light green for present */
        }
        .summary-box.absent-box {
            background-color: #ffe6e6; /* Very light red for absent */
        }

        .summary-box h3 {
            font-weight: 600;
            color: #333333;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .summary-item {
            display: flex;
            justify-content: center; /* Center items within summary-item */
            font-size: 0.95em;
            color: #666666;
        }
        .summary-item.total {
            font-weight: 700;
            color: #333333;
            border-top: 1px solid #eeeeee;
            padding-top: 8px;
            margin-top: 5px;
        }
        .table-section {
            padding: 28px; /* Increased padding */
            background-color: #ffffff; /* White background for table */
        }
        .no-students {
            text-align: center;
            padding: 50px; /* More padding */
            color: #999999; /* Lighter muted gray */
            font-size: 1.1em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .no-students .material-icons {
            font-size: 4.5em; /* Larger icon */
            color: #dddddd; /* Even lighter gray for icon */
            margin-bottom: 20px; /* More space */
        }
        /* Input, Select, Button base styles */
        input[type="text"], input[type="date"], select {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #cccccc; /* Lighter border */
            font-size: 1em;
            outline: none;
            background-color: white;
            color: #333333;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            border-color: #FFC107; /* Accent color on focus */
            box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.2); /* Softer focus ring */
        }
        .btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:active {
            transform: translateY(1px);
        }
        .btn-primary {
            background-color: #FFC107; /* Orange/Yellow accent */
            color: #333333; /* Dark text for contrast on yellow */
        }
        .btn-primary:hover {
            background-color: #e0a800; /* Darker yellow on hover */
        }
        .btn-secondary {
            background-color: #eeeeee; /* Light gray */
            color: #333333; /* Dark text */
        }
        .btn-secondary:hover {
            background-color: #dddddd; /* Slightly darker gray on hover */
        }
        .btn-add {
            background-color: #4CAF50; /* Green for add */
            color: white;
        }
        .btn-add:hover {
            background-color: #449d48; /* Darker green on hover */
        }
        .btn-icon {
            background: none;
            border: none;
            color: #666666; /* Muted gray for icons */
            font-size: 1.8em;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }
        .btn-icon:hover {
            color: #FFC107;
        }
        .btn-icon .material-icons {
            font-size: inherit;
        }
        /* Table styles inspired by "Table UI Design (1).png" */
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 8px; /* Rounded corners for the entire table container */
            overflow: hidden; /* Ensures rounded corners apply to content */
            border: 1px solid #e0e0e0; /* Lighter, more subtle border for the whole table */
            font-size: 0.95em; /* Slightly smaller font for compactness */
        }
        th, td {
            text-align: center; /* Centered text for all table cells */
            padding: 8px 15px; /* Reduced vertical padding for smaller height */
            /* Removed individual border-bottom to rely on row styling or overall table border */
        }
        th {
            background-color: #f8f8f8; /* Very light gray for header */
            font-weight: 600;
            color: #666666; /* Muted dark gray */
            text-transform: uppercase;
            font-size: 0.85em; /* Slightly smaller font for header */
            border-bottom: 1px solid #e0e0e0; /* Separator for header row */
        }
        tbody tr {
            transition: background-color 0.2s ease;
        }
        tbody tr:hover {
            background-color: #f2f2f2; /* Subtle hover effect */
        }
        tbody tr:last-child td {
            border-bottom: none; /* No border on the last row */
        }
        tbody tr:nth-child(even) {
            background-color: #ffffff; /* White zebra striping */
        }
        tbody tr:nth-child(odd) {
            background-color: #fcfcfc; /* Very slightly off-white for odd rows */
        }
        .attendance-toggle {
            padding: 5px 10px; /* Smaller padding */
            border-radius: 5px; /* Slightly smaller border radius */
            font-weight: 500; /* Slightly lighter font weight */
            min-width: 80px; /* Adjusted min-width */
            font-size: 0.85em; /* Smaller font size */
        }
        .attendance-present {
            background-color: #e6ffe6; /* Very light green */
            color: #28a745; /* Dark green text */
        }
        .attendance-absent {
            background-color: #ffe6e6; /* Very light red */
            color: #dc3545; /* Dark red text */
        }
        .delete-btn {
            background-color: #dc3545; /* Red for delete */
            color: white;
            padding: 5px 10px; /* Smaller padding */
            border-radius: 5px; /* Slightly smaller border radius */
            font-size: 0.85em; /* Smaller font size */
        }
        .delete-btn:hover {
            background-color: #c82333;
        }

        /* New styles for student type buttons */
        .student-type-btn {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #cccccc;
            background-color: #f0f0f0; /* Grayed out default */
            color: #666666;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
            font-weight: 500;
        }
        .student-type-btn:hover {
            background-color: #e0e0e0;
        }
        .student-type-btn.active {
            background-color: #6b46c1; /* Purple, or another distinct color */
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .student-type-btn.active:hover {
            background-color: #5a3aab; /* Darker purple on hover */
        }

        /* Formatting for student type text in table */
        .student-type-regular {
            font-weight: 600;
            color: #3f51b5; /* A shade of blue for Regular */
        }
        .student-type-trial {
            font-weight: 600;
            color: #ff9800; /* A shade of orange for Trial */
        }

        /* New styles for Active/Overtime/Complete status */
        .status-active {
            font-weight: 600;
            color: #28a745; /* Green for active */
        }
        .status-overtime {
            font-weight: 600;
            color: #dc3545; /* Red for overtime status text */
        }
        .status-complete {
            font-weight: 600;
            color: #007bff; /* Blue for complete */
        }
        .status-scheduled {
            font-weight: 600;
            color: #ff9800; /* Orange for scheduled */
        }
        .status-absent {
            font-weight: 600;
            color: #dc3545; /* Red for absent */
        }
        /* NEW: Undertime Status */
        .status-undertime {
            font-weight: 600;
            color: #FFA500; /* Orange for undertime */
        }
        /* NEW: Unfinished Status for historical records */
        .status-unfinished {
            font-weight: 600;
            color: #999999; /* Grey for unfinished */
        }
        /* NEW: Rest Day Status */
        .status-rest-day {
            font-weight: 600;
            color: #6c757d; /* Muted gray for rest day */
        }


        /* --- Custom styles for Actions column --- */
        table th:last-child,
        table td:last-child {
            min-width: 220px; /* Increased minimum width for the Actions column */
        }
        table td:last-child {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px; /* Space between buttons */
        }
        /* Remove mr-2 from buttons in the actions cell to let gap handle spacing */
        .table-section .btn.mr-2 {
            margin-right: 0 !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls, .form-section {
                flex-direction: column;
                align-items: stretch;
                padding: 16px;
            }
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            .btn, input, select {
                width: 100%;
                box-sizing: border-box;
            }
            .header h1 {
                font-size: 2rem;
            }
            .header .material-icons {
                font-size: 3rem;
            }
            .summary-section {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
            /* Adjust running status display for smaller screens */
            .running-status-display {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
                gap: 10px;
            }
            .running-status-display > div {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
        }
        /* Styles for print-specific content */
        @media print {
            body > *:not(.print-only) {
                display: none; /* Hide everything except the print-only content */
            }
            .print-only {
                display: block;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            .print-only .table-container {
                border: none; /* Remove border for cleaner print */
                box-shadow: none;
            }
            .print-only table {
                width: 100%;
                border-collapse: collapse;
            }
            .print-only th, .print-only td {
                border: 1px solid #ccc; /* Add borders for print table */
                padding: 8px;
            }
            .print-only .attendance-toggle, .print-only .delete-btn {
                /* Hide buttons in print view */
                display: none;
            }
            .print-only .no-students {
                display: none !important; /* Ensure no students message is hidden */
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            max-width: 900px; /* Increased max-width for new schedule config */
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #999;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        .time-slot-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .time-slot-entry input {
            width: 120px; /* Increased width for 12-hour format */
            text-align: center;
        }

        /* New styles for the overview section */
        .overview-section {
            background-color: #f5f5f5;
            padding: 20px 28px;
            border-bottom: 1px solid #eeeeee;
        }
        .overview-section h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333333;
            margin-bottom: 20px;
            text-align: center;
        }
        .date-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Responsive grid for date boxes */
            gap: 20px;
        }
        .date-summary-box {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .date-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #333333;
            cursor: pointer;
        }
        .date-summary-header .date-text {
            font-size: 1.1em;
        }
        .date-summary-header .material-icons {
            transition: transform 0.2s ease;
        }
        .date-summary-header.expanded .material-icons {
            transform: rotate(180deg);
        }
        .date-summary-details {
            display: flex;
            justify-content: space-around;
            font-size: 0.95em;
            color: #666666;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .date-summary-details span {
            display: block;
            text-align: center;
        }
        .date-summary-details strong {
            display: block;
            font-size: 1.2em;
            color: #333;
        }
        .shift-breakdown {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            display: none; /* Hidden by default */
        }
        .shift-breakdown.open {
            display: block;
        }
        .shift-summary {
            background-color: #f8f8f8;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .shift-summary:last-child {
            margin-bottom: 0;
        }
        .shift-summary h4 {
            font-weight: 600;
            color: #444;
            margin-bottom: 5px;
            font-size: 1em;
        }
        .shift-summary ul {
            list-style: none;
            padding-left: 0;
        }
        .shift-summary ul li {
            font-size: 0.85em;
            color: #555;
            line-height: 1.4;
        }

        /* Styles for the new running time and status display */
        .running-status-display {
            background-color: #f0f8ff; /* Light blue background */
            border-radius: 8px;
            padding: 15px 25px;
            margin: 20px auto; /* Center it with some margin */
            max-width: 600px; /* Limit width */
            display: flex;
            flex-direction: column; /* Stack details vertically */
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            font-weight: 600;
            color: #333333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #cceeff; /* Light blue border */
            text-align: center;
        }
        .running-status-display .main-info {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 10px;
            flex-wrap: wrap; /* Allow wrapping for main info */
            gap: 10px;
        }
        .running-status-display .student-details {
            font-size: 0.9em;
            color: #555555;
            margin-top: 5px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            width: 100%;
        }
        .running-status-display .detail-item {
            display: flex;
            justify-content: center; /* Center details */
            gap: 5px;
        }
        .running-status-display .label {
            color: #666666;
            font-size: 0.8em;
            margin-right: 5px;
        }
        .running-status-display .value {
            color: #007bff; /* Blue for values */
        }
        .running-status-display .status-value {
            font-size: 1.1em;
            color: #28a745; /* Green for active status */
        }
        .running-status-display .status-value.on-break {
            color: #ff9800; /* Orange for on break */
        }
        .running-status-display .status-value.no-active-student {
            color: #999999; /* Grey for no active student */
        }

        /* NEW: Styles for User Shift Status */
        .user-shift-status {
            background-color: #e0f2f7; /* Lighter blue for user status */
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: 700;
            margin-top: 10px;
            display: inline-block;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .user-shift-status.on-shift {
            color: #1a73e8; /* Google Blue */
            background-color: #e8f0fe;
        }
        .user-shift-status.off-shift {
            color: #dc3545; /* Red */
            background-color: #f8d7da;
        }

        /* NEW: Schedule Management Modal - Daily/Shift Structure */
        .daily-schedule-section {
            background-color: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .daily-schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: #f0f0f0;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
        }
        .daily-schedule-header.expanded {
            border-bottom: none; /* Remove border when expanded */
        }
        .daily-schedule-header .material-icons {
            transition: transform 0.2s ease;
        }
        .daily-schedule-header.expanded .material-icons {
            transform: rotate(180deg);
        }
        .daily-schedule-content {
            padding: 15px;
            display: none; /* Hidden by default */
        }
        .daily-schedule-content.open {
            display: block;
        }
        .shift-subsection {
            background-color: #fff;
            border: 1px solid #e9e9e9;
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .shift-subsection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background-color: #f8f8f8;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
        }
        .shift-subsection-header.expanded {
            border-bottom: none;
        }
        .shift-subsection-header .material-icons {
            transition: transform 0.2s ease;
        }
        .shift-subsection-header.expanded .material-icons {
            transform: rotate(180deg);
        }
        .shift-subsection-content {
            padding: 12px;
            display: none; /* Hidden by default */
        }
        .shift-subsection-content.open {
            display: block;
        }
        /* NEW: Standby Students Display */
        .standby-students-display {
            font-size: 0.9em;
            color: #555555;
            margin-top: 10px;
            text-align: left; /* Align left within its container */
            width: 100%; /* Take full width */
            padding-left: 10px; /* Some padding for readability */
        }
        .standby-students-display .standby-item {
            display: block;
            margin-bottom: 3px;
        }
        .standby-students-display .standby-label {
            font-weight: 600;
            color: #007bff; /* Blue for the label */
        }
        .standby-students-display .standby-value {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Main Attendance Page -->
    <div id="mainAttendancePage" class="container">
        <div class="header">
            <span class="material-icons">description</span>
            <h1>Student Attendance Sheet</h1>
            <p>Track student attendance with ease - Simple, Fast, Reliable</p>
            <div class="time-display-container">
                <div class="time-box">
                    <div class="label">Philippines Time</div>
                    <div class="time" id="philippinesTime"></div>
                </div>
                <div class="time-box">
                    <div class="label">Israel Time</div>
                    <div class="time" id="israelTime"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group month-year-picker">
                <button id="prevMonthBtn"><span class="material-icons">chevron_left</span></button>
                <span class="picker-underline">
                    <select id="monthSelect">
                        <!-- Options populated by JS -->
                    </select>
                </span>
                <span class="picker-underline">
                    <select id="yearSelect">
                        <!-- Options populated by JS -->
                    </select>
                </span>
                <button id="nextMonthBtn"><span class="material-icons">chevron_right</span></button>
            </div>

            <div class="control-group">
                <span class="text-gray-700">Date:</span>
                <!-- Hidden input to store the selected date from the custom picker -->
                <input type="hidden" id="currentDate">
                <div id="datePickerTrigger" class="rounded-md bg-white text-gray-900 p-2 cursor-pointer flex items-center justify-between min-w-[150px]">
                    <span id="displaySelectedDate"></span>
                    <!-- Removed calendar icon -->
                </div>
            </div>

            <div class="control-group">
                <input type="checkbox" id="cutOffPeriod" class="rounded-sm">
                <label for="cutOffPeriod" class="text-gray-700">Cut-off Period:</label>
                <select id="cutOffPeriodSelect" class="rounded-md bg-white text-gray-900 border-none outline-none focus:ring-0 focus:border-transparent">
                    <option value="All Month">All Month</option>
                    <option value="First Half">First Half</option>
                    <option value="Second Half">Second Half</option>
                </select>
            </div>

            <div class="control-group">
                <button class="btn btn-primary" id="exportCsvBtn"><span class="material-icons text-base">download</span> Export CSV</button>
                <button class="btn btn-primary" id="printBtn"><span class="material-icons text-base">print</span> Print</button>
                <button class="btn btn-secondary" id="clearAllBtn"><span class="material-icons text-base">clear</span> Clear All</button>
                <!-- New Manage Schedules button -->
                <button class="btn btn-secondary" id="manageSchedulesBtn"><span class="material-icons text-base">schedule</span> Manage Schedules</button>
                <!-- Moved viewAllStudentsBtn to the right -->
                <button class="btn btn-secondary order-last" id="viewAllStudentsBtn"><span class="material-icons text-base">list</span> View All Students</button>
            </div>
        </div>

        <!-- Custom Calendar Picker Popup -->
        <div id="calendarPicker" class="calendar-picker">
            <div class="calendar-header">
                <button id="calendarPrevMonth"><span class="material-icons">chevron_left</span></button>
                <span class="month-year-display" id="calendarMonthYear">February 2023</span>
                <button id="calendarNextMonth"><span class="material-icons">chevron_right</span></button>
            </div>
            <div class="calendar-weekdays">
                <span>Su</span>
                <span>Mo</span>
                <span>Tu</span>
                <span>We</span>
                <span>Th</span>
                <span>Fr</span>
                <span>Sa</span>
            </div>
            <div class="calendar-days" id="calendarDaysGrid">
                <!-- Days will be generated here -->
            </div>
            <div class="calendar-footer">
                <button id="calendarPrevYear">Prev Year</button>
                <button id="calendarToday">Today</button>
                <button id="calendarNextYear">Next Year</button>
            </div>
        </div>

        <div class="form-section">
            <input type="text" placeholder="Enter student name..." id="studentNameInput" class="flex-1 rounded-md bg-white text-gray-900">
            <!-- Student ID is now required and validated -->
            <input type="text" placeholder="Student ID (e.g., #1234 or 1234)" id="studentIdInput" class="flex-1 rounded-md bg-white text-gray-900">
            <!-- New Student Type Buttons -->
            <div class="flex items-center gap-2">
                <button class="btn student-type-btn" id="regularStudentBtn">Regular Student</button>
                <button class="btn student-type-btn" id="trialStudentBtn">Trial Student</button>
            </div>
            <button class="btn btn-add" id="addStudentBtn">Add Student</button>
            <!-- New button to open manual add/edit modal -->
            <button class="btn btn-secondary" id="openManualAddModal">
                <span class="material-icons text-base">edit</span> Manual Entry
            </button>
        </div>

        <div class="summary-section">
            <div class="summary-box">
                <h3>Total Students (Cut-off Period)</h3>
                <div class="summary-item">
                    <span>AM Shift:</span> <span id="cutoffAmTotal">0</span>
                </div>
                <div class="summary-item">
                    <span>PM Shift:</span> <span id="cutoffPmTotal">0</span>
                </div>
                <div class="summary-item">
                    <span>Night Shift:</span> <span id="cutoffNightTotal">0</span>
                </div>
                <div class="summary-item total">
                    <span>Grand Total:</span> <span id="cutoffGrandTotal">0</span>
                </div>
            </div>

            <div class="summary-box present-box">
                <h3>Daily Present Students (<span id="dailyPresentDateDisplay"></span>)</h3>
                <div class="summary-item">
                    <span>AM Shift:</span> <span id="dailyAmPresent">0</span>
                </div>
                <div class="summary-item">
                    <span>PM Shift:</span> <span id="dailyPmPresent">0</span>
                </div>
                <div class="summary-item">
                    <span>Night Shift:</span> <span id="dailyNightPresent">0</span>
                </div>
                <div class="summary-item total">
                    <span>Grand Total:</span> <span id="dailyGrandPresent">0</span>
                </div>
            </div>

            <div class="summary-box absent-box">
                <h3>Daily Absent Students (<span id="dailyAbsentDateDisplay"></span>)</h3>
                <div class="summary-item">
                    <span>AM Shift:</span> <span id="dailyAmAbsent">0</span>
                </div>
                <div class="summary-item">
                    <span>PM Shift:</span> <span id="dailyPmAbsent">0</span>
                </div>
                <div class="summary-item">
                    <span>Night Shift:</span> <span id="dailyNightAbsent">0</span>
                </div>
                <div class="summary-item total">
                    <span>Grand Total:</span> <span id="dailyGrandAbsent">0</span>
                </div>
            </div>

            <div class="summary-box">
                <h3>Total Daily Students (<span id="dailyDateDisplay"></span>)</h3>
                <div class="summary-item">
                    <span>AM Shift:</span> <span id="dailyAmTotal">0</span>
                </div>
                <div class="summary-item">
                    <span>PM Shift:</span> <span id="dailyPmTotal">0</span>
                </div>
                <div class="summary-item">
                    <span>Night Shift:</span> <span id="dailyNightTotal">0</span>
                </div>
                <div class="summary-item total">
                    <span>Grand Total:</span> <span id="dailyGrandTotal">0</span>
                </div>
            </div>
            <!-- Combined Summary for Main Attendance Page - Registered Total Student for the selected year -->
            <div class="summary-box">
                <h3>Registered Total Student (Selected Year)</h3>
                <div class="summary-item total">
                    <span id="mainPageOverallAttendanceCount">0</span>
                </div>
            </div>
        </div>

        <!-- NEW: Running Time and Status Display -->
        <div class="running-status-display">
            <div class="main-info">
                <div>
                    <span class="label">RUNNING TIME:</span>
                    <span class="value" id="runningTimeDisplay">00:00</span>
                </div>
                <div>
                    <span class="label">STATUS:</span>
                    <span class="status-value no-active-student" id="statusDisplay">NO ACTIVE STUDENT</span>
                </div>
            </div>
            <!-- NEW: User's Shift Status Display -->
            <div class="user-shift-status off-shift" id="userShiftStatusDisplay">
                OFF SHIFT
            </div>
            <!-- NEW: Standby Students Display -->
            <div class="standby-students-display" id="standbyStudentsDisplay">
                <!-- Standby students will be listed here -->
            </div>
            <div class="student-details">
                <div class="detail-item">
                    <span class="label">Student Name:</span>
                    <span id="activeStudentName"></span>
                </div>
                <div class="detail-item">
                    <span class="label">Student ID:</span>
                    <span id="activeStudentId"></span>
                </div>
                <div class="detail-item">
                    <span class="label">Student Type:</span>
                    <span id="activeStudentType"></span>
                </div>
                <div class="detail-item">
                    <span class="label">Start Time:</span>
                    <span id="activeStudentStartTime"></span>
                </div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-container rounded-md border border-gray-200 overflow-hidden">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Student Type</th>
                            <th>Time Duration</th>
                            <th>Student Name</th>
                            <th>Student ID</th>
                            <th>Scheduled Time</th>
                            <th>Shift</th>
                            <th>Attendance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        <!-- Student rows will be dynamically added here by JavaScript -->
                    </tbody>
                </table>
                <div id="noStudentsMessage" class="no-students">
                    <span class="material-icons">groups</span>
                    <p>No students added yet</p>
                    <p>Add your first student using the form above</p>
                </div>
            </div>
        </div>
    </div>

    <!-- All Students List Page -->
    <div id="allStudentsPage" class="container hidden">
        <div class="header">
            <span class="material-icons">people</span>
            <h1>All Students List</h1>
            <p>Comprehensive list of all registered students, organized by shift.</p>
            <button class="btn btn-secondary mt-4" id="backToAttendanceBtn">
                <span class="material-icons text-base">arrow_back</span> Back to Attendance
            </button>
        </div>
        <div class="p-8">
            <div class="controls mb-6">
                <div class="control-group month-year-picker">
                    <button id="allStudentsPrevMonthBtn"><span class="material-icons">chevron_left</span></button>
                    <span class="picker-underline">
                        <select id="allStudentsMonthSelect">
                            <!-- Options populated by JS -->
                        </select>
                    </span>
                    <span class="picker-underline">
                        <select id="allStudentsYearSelect">
                            <!-- Options populated by JS -->
                        </select>
                    </span>
                    <button id="allStudentsNextMonthBtn"><span class="material-icons">chevron_right</span></button>
                </div>
                <div class="control-group">
                    <label for="allStudentsCutOffPeriodSelect" class="text-gray-700">Cut-off Period:</label>
                    <select id="allStudentsCutOffPeriodSelect" class="rounded-md bg-white text-gray-900 border-none outline-none focus:ring-0 focus:border-transparent">
                        <option value="All Month">All Month</option>
                        <option value="First Half">First Half</option>
                        <option value="Second Half">Second Half</option>
                    </select>
                </div>
                <!-- Search bar for All Students List -->
                <div class="control-group flex-grow">
                    <input type="text" id="allStudentsSearchInput" placeholder="Search by name or ID..." class="flex-1 rounded-md bg-white text-gray-900">
                </div>
            </div>

            <!-- New Summary for All Students Page -->
            <div class="summary-section mb-6">
                <div class="summary-box present-box">
                    <h3>Total Present (Selected Period)</h3>
                    <div class="summary-item total">
                        <span id="allStudentsTotalPresent">0</span>
                    </div>
                </div>
                <div class="summary-box absent-box">
                    <h3>Total Absent (Selected Period)</h3>
                    <div class="summary-item total">
                        <span id="allStudentsTotalAbsent">0</span>
                    </div>
                </div>
            </div>

            <!-- NEW: Overview Section for All Students Page -->
            <div class="overview-section">
                <h2>Attendance Overview by Date (Cut-off Period)</h2>
                <div id="dateSummaryGrid" class="date-summary-grid">
                    <!-- Date summary boxes will be dynamically added here -->
                </div>
                <div id="noOverviewDataMessage" class="no-students hidden">
                    <span class="material-icons">event_note</span>
                    <p>No attendance records for the selected cut-off period.</p>
                </div>
            </div>

            <h2 class="text-2xl font-bold mb-6 text-gray-800">Students by Shift</h2>
            <div id="allStudentsContent" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Shift sections will be rendered here -->
            </div>
            <div id="noAllStudentsMessage" class="no-students hidden">
                <span class="material-icons">groups</span>
                <p>No students registered yet.</p>
            </div>
        </div>
    </div>

    <!-- Schedule Management Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeScheduleModal">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Manage Your Daily Schedules</h2>

            <div id="dailySchedulesContainer" class="daily-schedules-container">
                <!-- Daily schedule sections will be dynamically added here -->
            </div>

            <div class="mt-8 flex justify-end">
                <button class="btn btn-primary" id="saveSchedulesBtn">Save Schedules</button>
            </div>
        </div>
    </div>

    <!-- Manual Student Entry/Edit Modal -->
    <div id="manualStudentModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeManualStudentModal">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-gray-800" id="manualModalTitle">Add New Student Manually</h2>

            <div class="space-y-4">
                <input type="hidden" id="manualStudentDocId">
                <div>
                    <label for="manualStudentNameInput" class="block text-sm font-medium text-gray-700">Student Name</label>
                    <input type="text" id="manualStudentNameInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div>
                    <label for="manualStudentIdInput" class="block text-sm font-medium text-gray-700">Student ID</label>
                    <input type="text" id="manualStudentIdInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="e.g., #1234 or 1234">
                </div>
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-2">Student Type</span>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="manualStudentType" value="Regular" class="form-radio text-indigo-600" id="manualRegularStudentRadio">
                            <span class="ml-2">Regular Student</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="manualStudentType" value="Trial" class="form-radio text-indigo-600" id="manualTrialStudentRadio">
                            <span class="ml-2">Trial Student</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="manualScheduledTimeInput" class="block text-sm font-medium text-gray-700">Scheduled Time (HH:MM AM/PM)</label>
                    <input type="text" id="manualScheduledTimeInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="e.g., 09:00 PM" maxlength="8">
                </div>
                <!-- Removed End Time Input -->
                <div>
                    <label for="manualShiftSelect" class="block text-sm font-medium text-gray-700">Shift</label>
                    <select id="manualShiftSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <option value="AM Shift">AM Shift</option>
                        <option value="PM Shift">PM Shift</option>
                        <option value="Night Shift">Night Shift</option>
                        <option value="Unknown Shift">Unknown Shift</option>
                    </select>
                </div>
                <div>
                    <span class="block text-sm font-medium text-gray-700 mb-2">Attendance Status for <span id="manualAttendanceDateDisplay"></span></span>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="manualAttendanceStatus" value="Present" class="form-radio text-green-600" id="manualPresentRadio">
                            <span class="ml-2">Present</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="manualAttendanceStatus" value="Absent" class="form-radio text-red-600" id="manualAbsentRadio">
                            <span class="ml-2">Absent</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <button class="btn btn-secondary" id="cancelManualStudentBtn">Cancel</button>
                <button class="btn btn-primary" id="saveManualStudentBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query, getDocs, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user ID
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous until authenticated
        let allStudentsData = []; // Store all fetched students for client-side filtering
        let datesWithAttendance = new Set(); // New Set to store dates with any student attendance
        let selectedStudentType = null; // To store "Regular" or "Trial" for quick add form
        let userSchedules = {}; // Stores fetched schedules { "Monday": { "AM Shift": [{start: "HH:MM", end: "HH:MM"}], ... }, ... }
        let remindedStudents = new Set(); // Stores student IDs for whom a reminder has been shown today

        // Timer variables (These are now only for internal logic, not for display)
        let activeTimerStudentId = null;
        let timerInterval = null; // Still used for auto-ending lessons after 30 mins
        let timerStartTimeMillis = null;
        let timerMaxDurationMillis = 0;
        let timerScheduledTimeout = null; // Still used for scheduling 'Active' status change

        // NEW: Variables for running time display
        let runningTimeDisplayInterval = null;
        let runningTimeDisplayElement = null;
        let statusDisplayElement = null;

        // NEW: Elements for detailed student info in running status box
        let activeStudentNameElement = null;
        let activeStudentIdElement = null;
        let activeStudentTypeElement = null;
        let activeStudentStartTimeElement = null;
        let userShiftStatusDisplayElement = null; // NEW: Element for user's shift status
        let standbyStudentsDisplayElement = null; // NEW: Element for standby students


        const REGULAR_DURATION_MINS = 25;
        const TRIAL_DURATION_MINS = 20;
        const REGULAR_DURATION_MS = REGULAR_DURATION_MINS * 60 * 1000;
        const TRIAL_DURATION_MS = TRIAL_DURATION_MINS * 60 * 1000;
        const SCHEDULE_SLOT_DURATION_MS = 30 * 60 * 1000; // 30 minutes for a slot
        const ABSENT_DURATION_MS = 25 * 60 * 1000; // Default duration for absent students

        const MAX_UPCOMING_SCHEDULES = 4; // Maximum number of upcoming schedules
        const UPCOMING_SCHEDULE_WINDOW_MS = 2 * 60 * 60 * 1000; // 2 hours in milliseconds

        // Firebase configuration provided by the user (hardcoded for direct use)
        const firebaseConfig = {
            apiKey: "AIzaSyDWJG8TMDuXGZc34nkUJS77jDppGEzgNew",
            authDomain: "studentlist-f3c91.firebaseapp.com",
            projectId: "studentlist-f3c91",
            storageBucket: "studentlist-f3c91.firebaseapp.com",
            messagingSenderId: "621618569209",
            appId: "1:621618569209:web:6aead4f94b262224109a728",
            measurementId: "G-1VGFV1G7TT"
        };
        const initialAuthToken = null; // Set to null as it's not provided by the user

        // Get the app ID from the Canvas environment, or use a default if not available
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // UI Element References (Main Attendance Page)
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const cutOffPeriodSelect = document.getElementById('cutOffPeriodSelect');
        const currentDateInput = document.getElementById('currentDate'); // Now a hidden input
        const displaySelectedDate = document.getElementById('displaySelectedDate'); // To show selected date
        const datePickerTrigger = document.getElementById('datePickerTrigger'); // The clickable element for the picker
        const studentNameInput = document.getElementById('studentNameInput');
        const studentIdInput = document.getElementById('studentIdInput');
        const regularStudentBtn = document.getElementById('regularStudentBtn'); // New button reference
        const trialStudentBtn = document.getElementById('trialStudentBtn'); // New button reference
        const addStudentBtn = document.getElementById('addStudentBtn');
        const openManualAddModalBtn = document.getElementById('openManualAddModal'); // New manual add button
        const studentTableBody = document.getElementById('studentTableBody');
        const noStudentsMessage = document.getElementById('noStudentsMessage');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const printBtn = document.getElementById('printBtn');
        const manageSchedulesBtn = document.getElementById('manageSchedulesBtn'); // New button

        // Summary box elements
        const cutoffAmTotal = document.getElementById('cutoffAmTotal');
        const cutoffPmTotal = document.getElementById('cutoffPmTotal');
        const cutoffNightTotal = document.getElementById('cutoffNightTotal');
        const cutoffGrandTotal = document.getElementById('cutoffGrandTotal');

        const dailyAmTotal = document.getElementById('dailyAmTotal');
        const dailyPmTotal = document.getElementById('dailyPmTotal');
        const dailyNightTotal = document.getElementById('dailyNightTotal');
        const dailyGrandTotal = document.getElementById('dailyGrandTotal');
        const dailyDateDisplay = document.getElementById('dailyDateDisplay');

        // New summary box elements for daily present/absent
        const dailyPresentDateDisplay = document.getElementById('dailyPresentDateDisplay');
        const dailyAmPresent = document.getElementById('dailyAmPresent');
        const dailyPmPresent = document.getElementById('dailyPmPresent');
        const dailyNightPresent = document.getElementById('dailyNightPresent');
        const dailyGrandPresent = document.getElementById('dailyGrandPresent');

        const dailyAbsentDateDisplay = document.getElementById('dailyAbsentDateDisplay');
        const dailyAmAbsent = document.getElementById('dailyAmAbsent');
        const dailyPmAbsent = document.getElementById('dailyPmAbsent');
        const dailyNightAbsent = document.getElementById('dailyNightAbsent');
        const dailyGrandAbsent = document.getElementById('dailyGrandAbsent');

        // New summary elements for main attendance page overall totals
        const mainPageOverallAttendanceCount = document.getElementById('mainPageOverallAttendanceCount');

        // New overview section elements (now on All Students Page)
        const dateSummaryGrid = document.getElementById('dateSummaryGrid');
        const noOverviewDataMessage = document.getElementById('noOverviewDataMessage');


        // Time display elements
        const philippinesTimeElement = document.getElementById('philippinesTime');
        const israelTimeElement = document.getElementById('israelTime');


        // Calendar Picker Elements
        const calendarPicker = document.getElementById('calendarPicker');
        const calendarMonthYear = document.getElementById('calendarMonthYear');
        const calendarPrevMonth = document.getElementById('calendarPrevMonth');
        const calendarNextMonth = document.getElementById('calendarNextMonth');
        const calendarDaysGrid = document.getElementById('calendarDaysGrid');
        const calendarPrevYear = document.getElementById('calendarPrevYear');
        const calendarNextYear = document.getElementById('calendarNextYear');

        // Page elements
        const mainAttendancePage = document.getElementById('mainAttendancePage');
        const allStudentsPage = document.getElementById('allStudentsPage');
        const viewAllStudentsBtn = document.getElementById('viewAllStudentsBtn');
        const backToAttendanceBtn = document.getElementById('backToAttendanceBtn');
        const allStudentsContent = document.getElementById('allStudentsContent');
        const noAllStudentsMessage = document.getElementById('noAllStudentsMessage');

        // UI Element References (All Students List Page)
        const allStudentsMonthSelect = document.getElementById('allStudentsMonthSelect');
        const allStudentsYearSelect = document.getElementById('allStudentsYearSelect');
        const allStudentsPrevMonthBtn = document.getElementById('allStudentsPrevMonthBtn');
        const allStudentsNextMonthBtn = document.getElementById('allStudentsNextMonthBtn');
        const allStudentsCutOffPeriodSelect = document.getElementById('allStudentsCutOffPeriodSelect');
        const allStudentsSearchInput = document.getElementById('allStudentsSearchInput');
        const allStudentsTotalPresent = document.getElementById('allStudentsTotalPresent');
        const allStudentsTotalAbsent = document.getElementById('allStudentsTotalAbsent');

        // Schedule Modal Elements
        const scheduleModal = document.getElementById('scheduleModal');
        const closeScheduleModalBtn = document.getElementById('closeScheduleModal');
        const dailySchedulesContainer = document.getElementById('dailySchedulesContainer'); // NEW container
        const saveSchedulesBtn = document.getElementById('saveSchedulesBtn');

        // Manual Student Entry/Edit Modal Elements
        const manualStudentModal = document.getElementById('manualStudentModal');
        const closeManualStudentModalBtn = document.getElementById('closeManualStudentModal');
        const manualModalTitle = document.getElementById('manualModalTitle');
        const manualStudentDocId = document.getElementById('manualStudentDocId');
        const manualStudentNameInput = document.getElementById('manualStudentNameInput');
        const manualStudentIdInput = document.getElementById('manualStudentIdInput');
        const manualRegularStudentRadio = document.getElementById('manualRegularStudentRadio');
        const manualTrialStudentRadio = document.getElementById('manualTrialStudentRadio');
        const manualScheduledTimeInput = document.getElementById('manualScheduledTimeInput');
        const manualShiftSelect = document.getElementById('manualShiftSelect');
        const manualPresentRadio = document.getElementById('manualPresentRadio');
        const manualAbsentRadio = document.getElementById('manualAbsentRadio');
        const manualAttendanceDateDisplay = document.getElementById('manualAttendanceDateDisplay');
        const saveManualStudentBtn = document.getElementById('saveManualStudentBtn');
        const cancelManualStudentBtn = document.getElementById('cancelManualStudentBtn');

        let isEditingStudent = false; // Flag to determine if modal is for edit or add


        // Calendar state variables
        let currentCalendarDate = new Date(); // Date currently displayed in the calendar picker
        let selectedDailyDate = new Date(); // The date actually selected by the user for daily attendance

        // Current viewing month and year states (for the main filter controls)
        let currentViewMonthIndex; // 0-11 for Jan-Dec
        let currentViewYear;

        // Current viewing month, year, and cut-off for the All Students List page
        let allStudentsViewMonthIndex;
        let allStudentsViewYear;
        let allStudentsCutOffType;

        // Days of the week for Schedule configuration (Sunday is 0, Saturday is 6)
        const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];


        // Function to display messages (instead of alert)
        function showMessage(message, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.textContent = message;
            messageBox.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 5px;
                color: white;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.5s ease-in-out;
            `;
            if (type === 'success') {
                messageBox.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#dc3545';
            } else {
                messageBox.style.backgroundColor = '#007bff';
            }
            document.body.appendChild(messageBox);

            setTimeout(() => {
                messageBox.style.opacity = 1;
            }, 10); // Small delay to trigger transition

            setTimeout(() => {
                messageBox.style.opacity = 0;
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            console.log("Initializing Firebase...");
            console.log("Firebase Config being used:", firebaseConfig);
            console.log("Initial Auth Token being used:", initialAuthToken ? "Provided" : "Not Provided (using anonymous sign-in)");

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase app, db, auth initialized.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        await loadSchedules(); // Load schedules first
                        listenForStudents(); // Then start listening for student data
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Signed in with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or authentication:", error);
                showMessage("Failed to initialize Firebase. Check console for details.", 'error');
            }
        }

        // Populate Month and Year Selectors (for the main filter controls AND all students page)
        function populateMonthYearSelectors(monthSelectElement, yearSelectElement, initialMonthIndex, initialYear) {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthSelectElement.innerHTML = '';
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index; // Use index as value
                option.textContent = month;
                monthSelectElement.appendChild(option);
            });

            const currentYear = new Date().getFullYear();
            yearSelectElement.innerHTML = '';
            for (let i = currentYear - 5; i <= currentYear + 5; i++) { // 5 years back, 5 years forward
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelectElement.appendChild(option);
            }

            // Set initial selected month/year
            monthSelectElement.value = initialMonthIndex;
            yearSelectElement.value = initialYear;
        }

        // Update current view month/year (for the main filter controls)
        function updateCurrentViewDate() {
            currentViewMonthIndex = parseInt(monthSelect.value);
            currentViewYear = parseInt(yearSelect.value);
            filterAndRenderStudents(); // Re-filter and render when month/year changes
        }

        // Update current view month/year/cut-off for the All Students List page
        function updateAllStudentsViewSettings() {
            allStudentsViewMonthIndex = parseInt(allStudentsMonthSelect.value);
            allStudentsViewYear = parseInt(allStudentsYearSelect.value);
            allStudentsCutOffType = allStudentsCutOffPeriodSelect.value;
            renderAllStudentsList(); // Re-render the all students list with new filters
        }

        // Handle month navigation (prev/next buttons for main filter controls)
        function navigateMonth(direction) {
            let newMonthIndex = currentViewMonthIndex + direction;
            let newYear = currentViewYear;

            if (newMonthIndex < 0) {
                newMonthIndex = 11;
                newYear--;
            } else if (newMonthIndex > 11) {
                newMonthIndex = 0;
                newYear++;
            }
            currentViewMonthIndex = newMonthIndex;
            currentViewYear = newYear;

            monthSelect.value = currentViewMonthIndex;
            yearSelect.value = newYear; // Ensure year selector updates
            filterAndRenderStudents();
        }

        // Handle month navigation for All Students List page
        function navigateAllStudentsMonth(direction) {
            let newMonthIndex = allStudentsViewMonthIndex + direction;
            let newYear = allStudentsViewYear;

            if (newMonthIndex < 0) {
                newMonthIndex = 11;
                newYear--;
            } else if (newMonthIndex > 11) {
                newMonthIndex = 0;
                newYear++;
            }
            allStudentsViewMonthIndex = newMonthIndex;
            allStudentsViewYear = newYear;

            allStudentsMonthSelect.value = allStudentsViewMonthIndex;
            allStudentsYearSelect.value = newYear;
            renderAllStudentsList();
        }

        /**
         * Determines the shift (AM/PM/Night) for a given time based on user's configured schedules.
         * This function *only* checks if the time falls within a defined slot for any of the main shifts.
         * It does *not* consider "Rest Day" status directly, as "Rest Day" is now implied by the *absence* of a schedule.
         * @param {Date} inputDate - The Date object to determine the shift for.
         * @returns {string} The determined shift name (e.g., "AM Shift", "PM Shift", "Night Shift", "Unknown Shift").
         */
        function determineShift(inputDate) {
            const currentHour = inputDate.getHours();
            const currentMinute = inputDate.getMinutes();
            const dayOfWeekName = daysOfWeek[inputDate.getDay()]; // Get day name (e.g., "Monday")

            // Convert inputDate to minutes from midnight for comparison
            const inputMinutesFromMidnight = currentHour * 60 + currentMinute;

            // Iterate through shifts in a consistent order (AM -> PM -> Night)
            const shiftsToConsider = ["AM Shift", "PM Shift", "Night Shift"];

            let determinedShift = "Unknown Shift"; // Default if no schedule matches

            // Get schedules for the specific day of the week
            const dailySchedules = userSchedules[dayOfWeekName];
            if (!dailySchedules) {
                return "Unknown Shift"; // No schedules defined for this day
            }

            for (const shiftName of shiftsToConsider) {
                const slots = dailySchedules[shiftName];
                if (!slots) continue; // Skip if no slots defined for this shift on this day

                for (const slot of slots) {
                    const [startHour, startMinute] = slot.startTime.split(':').map(Number);
                    const [endHour, endMinute] = slot.endTime.split(':').map(Number);

                    let slotStartMinutes = startHour * 60 + startMinute;
                    let slotEndMinutes = endHour * 60 + endMinute;

                    // Handle overnight shifts: if end time is numerically smaller than start time, it means it's on the next day
                    if (slotEndMinutes < slotStartMinutes) {
                        slotEndMinutes += (24 * 60); // Add 24 hours to end time for comparison
                    }

                    // Adjust inputMinutesFromMidnight if it's for the "next day" part of an overnight shift
                    let adjustedInputMinutes = inputMinutesFromMidnight;
                    // If the input time is before the start of an overnight shift (e.g., 2 AM),
                    // but the shift ends on the next day (e.g., 10 PM to 6 AM),
                    // then add 24 hours to the input time for correct comparison within the overnight range.
                    if (inputMinutesFromMidnight < slotStartMinutes && slotEndMinutes > (24 * 60)) {
                        adjustedInputMinutes += (24 * 60);
                    }

                    if (adjustedInputMinutes >= slotStartMinutes && adjustedInputMinutes < slotEndMinutes) {
                        determinedShift = shiftName; // Found a matching shift
                        break; // Exit inner loop
                    }
                }
                if (determinedShift !== "Unknown Shift") break; // Exit outer loop if a shift is found
            }
            return determinedShift;
        }

        /**
         * Checks if the user is currently "ON SHIFT" based on their configured schedules for the current day and time.
         * This is used for the main overview display.
         * @param {Date} checkDate - The current Date object to check against.
         * @returns {boolean} True if the user is on shift, false otherwise.
         */
        function isUserCurrentlyOnShift(checkDate) {
            const dayOfWeekName = daysOfWeek[checkDate.getDay()];
            const currentHour = checkDate.getHours();
            const currentMinute = checkDate.getMinutes();
            const currentMinutesFromMidnight = currentHour * 60 + currentMinute;

            const dailySchedules = userSchedules[dayOfWeekName];
            if (!dailySchedules) {
                return false; // No schedules for this day
            }

            const shiftsToConsider = ["AM Shift", "PM Shift", "Night Shift"];
            for (const shiftName of shiftsToConsider) {
                const slots = dailySchedules[shiftName];
                if (!slots) continue;

                for (const slot of slots) {
                    const [startHour, startMinute] = slot.startTime.split(':').map(Number);
                    const [endHour, endMinute] = slot.endTime.split(':').map(Number);

                    let slotStartMinutes = startHour * 60 + startMinute;
                    let slotEndMinutes = endHour * 60 + endMinute;

                    if (slotEndMinutes < slotStartMinutes) {
                        slotEndMinutes += (24 * 60);
                    }

                    let adjustedCurrentMinutes = currentMinutesFromMidnight;
                    if (currentMinutesFromMidnight < slotStartMinutes && slotEndMinutes > (24 * 60)) {
                        adjustedCurrentMinutes += (24 * 60);
                    }

                    if (adjustedCurrentMinutes >= slotStartMinutes && adjustedCurrentMinutes < slotEndMinutes) {
                        return true; // Found a matching schedule slot for the current time
                    }
                }
            }
            return false; // No matching schedule slot found
        }


        /**
         * Finds the next valid 30-minute slot start time for a lesson.
         * If current time is 9:21, next slot is 9:30. If 9:51, next slot is 10:00.
         * If current time is within a slot (e.g., 9:05 for a 9:00 slot), it returns the current slot's start time.
         * @param {Date} currentTime - The current Date object.
         * @param {string} studentType - "Regular" or "Trial".
         * @returns {number} Timestamp in milliseconds for the scheduled start, or null if no valid future slot.
         */
        function getScheduledOrCurrentSlotStartTime(currentTime, studentType) {
            const currentHour = currentTime.getHours();
            const currentMinute = currentTime.getMinutes();
            const currentSeconds = currentTime.getSeconds();
            const currentMillis = currentTime.getMilliseconds();

            let targetMinute;
            if (currentMinute < 30) {
                targetMinute = 0;
            } else {
                targetMinute = 30;
            }

            let scheduledStart = new Date(currentTime);
            scheduledStart.setSeconds(0, 0); // Reset seconds and milliseconds

            // If current time is after the target minute for the current half-hour, move to next half-hour
            if (currentMinute > targetMinute || (currentMinute === targetMinute && (currentSeconds > 0 || currentMillis > 0))) {
                scheduledStart.setMinutes(targetMinute + 30);
            } else {
                scheduledStart.setMinutes(targetMinute);
            }

            // Calculate the actual end time of the lesson based on its duration
            const lessonDurationMs = (studentType === 'Regular' ? REGULAR_DURATION_MS : TRIAL_DURATION_MS);
            const lessonEndTime = scheduledStart.getTime() + lessonDurationMs;

            // Calculate the end of the 30-minute slot
            const slotEndTime = new Date(scheduledStart);
            slotEndTime.setMinutes(slotEndTime.getMinutes() + 30);

            // If the lesson would extend beyond the 30-minute slot, adjust the lesson end time
            // to be the end of the slot. This means the actual lesson duration will be capped.
            const actualLessonEndTime = Math.min(lessonEndTime, slotEndTime.getTime());

            // If the current time is past the calculated end of the lesson slot, it means we missed the slot.
            // This check needs to be careful. If the current time is 9:35, and the slot is 9:30-10:00,
            // the lessonEndTime for a 25min lesson is 9:55. So actualLessonEndTime is 9:55.
            // If now (9:35) is >= 9:55, then return null. This is correct.
            if (currentTime.getTime() >= actualLessonEndTime) {
                return null; // Lesson cannot start, it's already past its scheduled end for this slot
            }

            return scheduledStart.getTime(); // Return the start time of the slot
        }


        // Function to handle student type button clicks for quick add form
        function selectStudentType(type) {
            selectedStudentType = type;
            // Remove 'active' class from both buttons
            regularStudentBtn.classList.remove('active');
            trialStudentBtn.classList.remove('active');
            // Add 'active' class to the clicked button
            if (type === 'Regular') {
                regularStudentBtn.classList.add('active');
            } else if (type === 'Trial') {
                trialStudentBtn.classList.add('active');
            }
        }


        // Add a new student to Firestore (Quick Add)
        async function addStudent() {
            console.log("Quick Add Student button clicked!");
            console.log("Current userId:", userId);

            const name = studentNameInput.value.trim();
            let studentId = studentIdInput.value.trim(); // Get student ID
            const now = Date.now();
            
            const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);

            if (!name) {
                showMessage("Student name cannot be empty.", 'error');
                console.log("Student name is empty.");
                return;
            }

            // Student ID Validation
            if (!studentId) {
                showMessage("Student ID is required.", 'error');
                return;
            }
            // Remove '#' if present for validation and storage, but keep original for display if needed
            const cleanStudentId = studentId.startsWith('#') ? studentId.substring(1) : studentId;
            const studentIdRegex = /^\d+$/; // Only digits allowed after optional '#'
            if (!studentIdRegex.test(cleanStudentId)) {
                showMessage("Student ID must be numeric, optionally starting with '#'.", 'error');
                return;
            }
            studentId = cleanStudentId; // Use the cleaned ID for storage and uniqueness check

            // Check for unique Student ID
            const existingStudents = allStudentsData; // Use the globally available allStudentsData
            const isIdUnique = !existingStudents.some(student => student.studentId === studentId);

            if (!isIdUnique) {
                showMessage(`Student ID "${studentId}" already exists. Please use a unique ID.`, 'error');
                return;
            }

            if (!selectedStudentType) {
                showMessage("Please select student type (Regular or Trial).", 'error');
                return;
            }


            if (!db || !auth.currentUser || auth.currentUser.isAnonymous && userId === 'anonymous') {
                showMessage("Firebase not ready or user not authenticated. Please wait.", 'error');
                console.error("Firebase not ready for addDoc. db:", db, "auth.currentUser:", auth.currentUser, "userId:", userId);
                return;
            }

            try {
                let proposedScheduledTime = getScheduledOrCurrentSlotStartTime(new Date(now), selectedStudentType);

                if (proposedScheduledTime === null) {
                    showMessage("No valid schedule slot found for the current time. Cannot add student.", 'info');
                    return;
                }

                // NEW: Find the next available slot if the proposed one is already taken
                let foundAvailableSlot = false;
                let attempts = 0;
                const MAX_ATTEMPTS = 48; // Try up to 24 hours (48 half-hour slots)

                while (!foundAvailableSlot && attempts < MAX_ATTEMPTS) {
                    const isSlotTaken = allStudentsData.some(student => {
                        const record = student.attendance?.[currentDateFormatted];
                        return record && record.present === true && record.startTime === proposedScheduledTime;
                    });

                    if (isSlotTaken) {
                        // If slot is taken, advance to the next 30-minute slot
                        const nextSlotDate = new Date(proposedScheduledTime);
                        nextSlotDate.setMinutes(nextSlotDate.getMinutes() + 30);
                        proposedScheduledTime = nextSlotDate.getTime();
                        attempts++;
                    } else {
                        foundAvailableSlot = true;
                    }
                }

                if (!foundAvailableSlot) {
                    showMessage("Could not find an available time slot within the next 24 hours. Please try again later or use manual entry.", 'info');
                    return;
                }

                // NEW: Plotting Constraint Check (after finding an available slot)
                const twoHoursFromNow = now + UPCOMING_SCHEDULE_WINDOW_MS;
                const scheduledStudentsInWindow = allStudentsData.filter(student => {
                    const record = student.attendance?.[currentDateFormatted];
                    return record && record.status === 'Scheduled' &&
                           record.startTime > now && record.startTime <= twoHoursFromNow;
                });

                if (proposedScheduledTime > twoHoursFromNow) {
                     showMessage(`Cannot schedule a lesson more than 2 hours in advance (latest: ${formatTimestampTo12Hour(twoHoursFromNow)}).`, 'info');
                     return;
                }

                if (scheduledStudentsInWindow.length >= MAX_UPCOMING_SCHEDULES) {
                    showMessage(`Maximum of ${MAX_UPCOMING_SCHEDULES} upcoming lessons already scheduled within the next 2 hours.`, 'info');
                    return;
                }


                // Determine shift based on the scheduled start time for the student
                const assignedShift = determineShift(new Date(proposedScheduledTime)); 
                
                // NEW: Check if the user is ON SHIFT for this student's scheduled time and shift
                // If the user has NO schedule configured for this specific day and shift, then it's implicitly OFF SHIFT
                const userShiftForStudentTime = determineShift(new Date(proposedScheduledTime));
                const isUserAvailableForShift = userShiftForStudentTime !== "Unknown Shift"; // User is available if a schedule exists for that time/shift

                let initialAttendance = {};
                if (isUserAvailableForShift) {
                    initialAttendance[currentDateFormatted] = {
                        present: true,
                        startTime: proposedScheduledTime, // Store scheduled start time
                        endTime: null,
                        durationMs: 0,
                        status: proposedScheduledTime > now ? 'Scheduled' : 'Active', // Initial status
                        shift: assignedShift // Use determined shift here
                    };
                } else {
                    // If user is OFF SHIFT for this time, mark student Absent with Rest Day status
                    showMessage(`Cannot mark student present. You are OFF SHIFT for the ${assignedShift} on ${daysOfWeek[new Date(proposedScheduledTime).getDay()]}. Student marked as Absent (Rest Day).`, 'info');
                    initialAttendance[currentDateFormatted] = {
                        present: false,
                        startTime: proposedScheduledTime, // Still record scheduled time
                        endTime: null,
                        durationMs: (selectedStudentType === 'Regular' ? REGULAR_DURATION_MS : TRIAL_DURATION_MS), // Default duration for absent
                        status: 'Rest Day', // Explicitly mark as Rest Day
                        shift: assignedShift // Still record the intended shift
                    };
                }

                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/students`), {
                    name: name,
                    studentId: studentId, // Store the cleaned ID
                    studentType: selectedStudentType, // Store the selected student type
                    defaultShift: assignedShift, // Store as default for this student
                    defaultScheduledTime: convert24to12Hour(new Date(proposedScheduledTime).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: false})), // Store 24-hour HH:MM
                    attendance: initialAttendance,
                    createdAt: new Date()
                });
                console.log("Document written with ID: ", docRef.id);
                showMessage("Student added successfully!", 'success');
                
                // Clear form fields
                studentNameInput.value = '';
                studentIdInput.value = '';
                // Reset selected student type and button styles
                selectedStudentType = null;
                regularStudentBtn.classList.remove('active');
                trialStudentBtn.classList.remove('active');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error adding student. Check console for details.", 'error');
            }
        }

        // Filter and Render Students based on selected month/year/cut-off
        function filterAndRenderStudents() {
            console.log("filterAndRenderStudents: Called.");
            const cutOffType = cutOffPeriodSelect.value;
            const viewMonth = currentViewMonthIndex;
            const viewYear = currentViewYear;

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const daysInMonth = getDaysInMonth(viewYear, viewMonth);

            let cutoffStartDate, cutoffEndDate;

            if (cutOffType === 'All Month') {
                cutoffStartDate = new Date(viewYear, viewMonth, 1);
                cutoffEndDate = new Date(viewYear, viewMonth, daysInMonth);
            } else if (cutOffType === 'First Half') {
                cutoffStartDate = new Date(viewYear, viewMonth, 1);
                cutoffEndDate = new Date(viewYear, viewMonth, Math.floor(daysInMonth / 2));
            } else if (cutOffType === 'Second Half') {
                cutoffStartDate = new Date(viewYear, viewMonth, Math.floor(daysInMonth / 2) + 1);
                cutoffEndDate = new Date(viewYear, viewMonth, daysInMonth);
            }

            // Filter students for the TABLE: only show students with attendance for the selected DAILY date
            const dailyStudentsForTable = allStudentsData.filter(student => {
                const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
                // A student is included in the table if they have an attendance record (present or absent) for the selected daily date
                return student.attendance && student.attendance[currentDateFormatted] !== undefined;
            });

            // Sort students for the table
            dailyStudentsForTable.sort((a, b) => {
                const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
                const aRecord = a.attendance ? a.attendance[currentDateFormatted] : null;
                const bRecord = b.attendance ? b.attendance[currentDateFormatted] : null;

                // Get the effective time for sorting for student A
                let timeA = null;
                if (aRecord && aRecord.startTime !== null) { // If there's a start time (present)
                    timeA = aRecord.startTime;
                } else if (a.defaultScheduledTime) { // Otherwise, use default scheduled time (for absent or not-yet-present)
                    timeA = convert12toTimestamp(a.defaultScheduledTime, selectedDailyDate);
                }

                // Get the effective time for sorting for student B
                let timeB = null;
                if (bRecord && bRecord.startTime !== null) { // If there's a start time (present)
                    timeB = bRecord.startTime;
                } else if (b.defaultScheduledTime) { // Otherwise, use default scheduled time (for absent or not-yet-present)
                    timeB = convert12toTimestamp(b.defaultScheduledTime, selectedDailyDate);
                }

                // Handle cases where times might be null/NaN, pushing them to the end of the list
                const finalTimeA = (timeA === null || isNaN(timeA)) ? Infinity : timeA;
                const finalTimeB = (timeB === null || isNaN(timeB)) ? Infinity : timeB;

                // Sort by time in ASCENDING order (earliest first)
                return finalTimeA - finalTimeB;
            });

            renderStudentsTable(dailyStudentsForTable); // Render the table with daily-filtered and sorted students

            // Filter students for the CUT-OFF SUMMARY: students who have *any* attendance within the cut-off period
            const studentsForCutoffSummary = allStudentsData.filter(student => {
                if (student.attendance && typeof student.attendance === 'object') {
                    for (const dateString in student.attendance) {
                        const [year, month, day] = dateString.split('-').map(Number);
                        const attendanceDate = new Date(year, month - 1, day); // month - 1 because JS months are 0-indexed
                        if (attendanceDate >= cutoffStartDate && attendanceDate <= cutoffEndDate) {
                            return true; // Student has attendance in this period, include them
                        }
                    }
                }
                return false; // No attendance in this period
            });

            // Update summary boxes with both daily and cut-off data
            updateSummaryBoxes(allStudentsData, studentsForCutoffSummary, cutoffStartDate, cutoffEndDate);

            // Removed call to renderOverviewSection from here
        }

        // Helper function to format milliseconds to MM:SS
        function formatDuration(ms) {
            // Ensure non-negative duration for formatting MM:SS
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // NEW: Helper function to format milliseconds to "X minutes Y seconds"
        function formatDurationVerbose(ms) {
            const totalSeconds = Math.floor(Math.abs(ms) / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} minutes ${seconds} seconds`;
        }

        // Helper function to format timestamp to 12-hour time string with AM/PM
        function formatTimestampTo12Hour(timestamp) {
            if (timestamp === null || timestamp === undefined) {
                return ''; // Changed from 'N/A' to empty string
            }
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        // Helper to convert 12-hour string to timestamp for a given date
        function convert12toTimestamp(time12, dateObj) {
            console.log(`convert12toTimestamp: Converting "${time12}" for date ${dateObj.toDateString()}`);
            if (!time12) {
                console.log("convert12toTimestamp: time12 is empty, returning null.");
                return null;
            }
            const parts = time12.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!parts) {
                console.log("convert12toTimestamp: time12 format invalid, returning null.");
                return null;
            }

            let hour = parseInt(parts[1], 10);
            const minute = parseInt(parts[2], 10);
            const ampm = parts[3].toUpperCase();

            if (ampm === 'PM' && hour < 12) {
                hour += 12;
            } else if (ampm === 'AM' && hour === 12) {
                hour = 0; // 12 AM (midnight) is 00 in 24-hour format
            }

            const newDate = new Date(dateObj); // Create a new Date object based on the selected day
            newDate.setHours(hour, minute, 0, 0);
            console.log(`convert12toTimestamp: Converted to Date: ${newDate.toString()}, Timestamp: ${newDate.getTime()}`);
            return newDate.getTime();
        }


        // Render students in the table (renamed to distinguish from filter function)
        function renderStudentsTable(studentsToRender) {
            console.log("Rendering students table. Count:", studentsToRender.length);
            studentTableBody.innerHTML = ''; // Clear existing rows
            if (studentsToRender.length === 0) {
                noStudentsMessage.style.display = 'flex'; // Show message
            } else {
                noStudentsMessage.style.display = 'none'; // Hide message
                studentsToRender.forEach((student, index) => {
                    const row = studentTableBody.insertRow();
                    row.insertCell(0).textContent = index + 1; // #

                    // Student Type Cell
                    const studentTypeCell = row.insertCell(1);
                    studentTypeCell.textContent = student.studentType || ''; // Changed from 'N/A'
                    studentTypeCell.classList.add(student.studentType === 'Regular' ? 'student-type-regular' : 'student-type-trial');

                    // Time Duration Cell (fixed duration)
                    const timeDurationCell = row.insertCell(2);
                    timeDurationCell.textContent = `${student.studentType === 'Regular' ? REGULAR_DURATION_MINS : TRIAL_DURATION_MINS} mins`;

                    // Student Name Cell
                    row.insertCell(3).textContent = student.name; // Adjusted index

                    // Student ID Cell
                    row.insertCell(4).textContent = student.studentId || ''; // Changed from 'N/A'
                    
                    // Display the scheduled start time for the current day
                    const scheduledTimeCell = row.insertCell(5); // Adjusted index
                    let displayScheduledTime = ''; // Changed from 'N/A'
                    const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
                    const attendanceRecord = student.attendance ? student.attendance[currentDateFormatted] : null;

                    if (attendanceRecord && attendanceRecord.present === false) {
                        // If student is absent, show their default scheduled time
                        displayScheduledTime = student.defaultScheduledTime || ''; // Changed from 'N/A'
                    } else if (attendanceRecord && attendanceRecord.startTime !== null) {
                        // If student is present (active, scheduled, complete, overtime, undertime), show their actual start time
                        displayScheduledTime = formatTimestampTo12Hour(attendanceRecord.startTime);
                    } else if (student.defaultScheduledTime) {
                        // If no attendance record for today, but a default is set, show that
                        displayScheduledTime = student.defaultScheduledTime;
                    }
                    scheduledTimeCell.textContent = displayScheduledTime;

                    // Shift Cell
                    const shiftCell = row.insertCell(6); // Adjusted index
                    const shiftText = attendanceRecord ? attendanceRecord.shift || student.defaultShift || '' : student.defaultShift || ''; // Changed from 'N/A'
                    shiftCell.textContent = shiftText;
                    if (shiftText === 'Rest Day') {
                        shiftCell.classList.add('status-rest-day');
                    }


                    // Attendance cell with toggle button
                    const attendanceCell = row.insertCell(7); // Adjusted index
                    const attendanceStatus = (attendanceRecord && attendanceRecord.present === true) ? 'Present' : 'Absent';
                    const attendanceBtn = document.createElement('button');
                    attendanceBtn.textContent = attendanceStatus;
                    attendanceBtn.className = `attendance-toggle ${attendanceStatus === 'Present' ? 'attendance-present' : 'attendance-absent'}`;
                    // Pass studentType to toggleAttendance
                    attendanceBtn.onclick = () => toggleAttendance(student.id, student.studentType, attendanceStatus === 'Absent');
                    attendanceCell.appendChild(attendanceBtn);

                    // Actions cell with delete and End Lesson buttons
                    const actionsCell = row.insertCell(8); // Adjusted index
                    const endLessonBtn = document.createElement('button');
                    endLessonBtn.textContent = 'End Lesson';
                    endLessonBtn.className = 'btn btn-secondary';
                    endLessonBtn.onclick = () => endLesson(student.id);
                    // Only show End Lesson button if the lesson is currently active (present, has start time, and no end time)
                    if (attendanceRecord && attendanceRecord.present === true && attendanceRecord.startTime !== null && attendanceRecord.endTime === null) {
                        endLessonBtn.style.display = 'inline-flex';
                    } else {
                        endLessonBtn.style.display = 'none';
                    }
                    actionsCell.appendChild(endLessonBtn);

                    // New Edit button
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<span class="material-icons text-base">edit</span>';
                    editBtn.className = 'btn btn-secondary';
                    editBtn.onclick = () => openManualStudentModal(student); // Pass student data for editing
                    actionsCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.onclick = () => deleteStudent(student.id);
                    actionsCell.appendChild(deleteBtn);
                });
            }
        }

        // Update summary boxes with total students (present + absent)
        function updateSummaryBoxes(allStudents, studentsForCutoffSummary, cutoffStartDate, cutoffEndDate) {
            // Simplified shift names for summary display
            const shifts = ["AM Shift", "PM Shift", "Night Shift", "Unknown Shift"]; // Removed Rest Day from this list
            const dailyTotalCounts = { "AM Shift": 0, "PM Shift": 0, "Night Shift": 0, "Unknown Shift": 0, total: 0 };
            const dailyPresentCounts = { "AM Shift": 0, "PM Shift": 0, "Night Shift": 0, "Unknown Shift": 0, total: 0 };
            const dailyAbsentCounts = { "AM Shift": 0, "PM Shift": 0, "Night Shift": 0, "Unknown Shift": 0, total: 0 };

            const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);

            // Calculate daily totals (Present, Absent, and combined Total for the specific selectedDailyDate)
            allStudents.forEach(student => {
                // Use the shift from the daily attendance record if available, otherwise defaultShift
                const attendanceRecord = student.attendance ? student.attendance[currentDateFormatted] : undefined;
                let studentShift = attendanceRecord ? (attendanceRecord.shift || student.defaultShift) : student.defaultShift;

                // Ensure shift is one of the recognized shifts, default to "Unknown Shift" if not
                if (!shifts.includes(studentShift)) {
                    studentShift = "Unknown Shift";
                }

                const attendanceStatus = attendanceRecord ? attendanceRecord.present : undefined;

                if (attendanceStatus === true) {
                    dailyPresentCounts[studentShift]++;
                    dailyPresentCounts.total++;
                    dailyTotalCounts[studentShift]++; // Also count in total if present
                    dailyTotalCounts.total++;
                } else if (attendanceStatus === false) {
                    dailyAbsentCounts[studentShift]++;
                    dailyAbsentCounts.total++;
                    dailyTotalCounts[studentShift]++; // Also count in total if absent
                    dailyTotalCounts.total++;
                }
            });

            // Calculate cut-off totals (Present + Absent for the entire cut-off period)
            const cutoffTotalCounts = { "AM Shift": 0, "PM Shift": 0, "Night Shift": 0, "Unknown Shift": 0, total: 0 };
            studentsForCutoffSummary.forEach(student => {
                // Use the student's defaultShift for categorization in the All Students list
                let studentShift = student.defaultShift || "Unknown Shift";
                if (!shifts.includes(studentShift)) {
                    studentShift = "Unknown Shift";
                }

                cutoffTotalCounts[studentShift]++;
                cutoffTotalCounts.total++;
            });

            // Calculate overall registered students for the selected year (main page)
            let uniqueStudentsInYear = new Set();
            const selectedYear = currentViewYear; // Use the year from the main filter controls

            allStudents.forEach(student => {
                if (student.attendance && typeof student.attendance === 'object') {
                    for (const dateString in student.attendance) {
                        const [year, month, day] = dateString.split('-').map(Number);
                        const attendanceDate = new Date(year, month - 1, day);

                        // Check if the attendance date falls within the selected year
                        if (attendanceDate.getFullYear() === selectedYear) {
                            uniqueStudentsInYear.add(student.id); // Add student's unique ID to the set
                        }
                    }
                }
            });


            // Update UI for Cut-off totals
            cutoffAmTotal.textContent = cutoffTotalCounts["AM Shift"];
            cutoffPmTotal.textContent = cutoffTotalCounts["PM Shift"];
            cutoffNightTotal.textContent = cutoffTotalCounts["Night Shift"];
            cutoffGrandTotal.textContent = cutoffTotalCounts.total;

            // Update UI for Daily Present totals
            dailyPresentDateDisplay.textContent = formatDateToDisplay(selectedDailyDate);
            dailyAmPresent.textContent = dailyPresentCounts["AM Shift"];
            dailyPmPresent.textContent = dailyPmPresent.textContent = dailyPresentCounts["PM Shift"];
            dailyNightPresent.textContent = dailyPresentCounts["Night Shift"];
            dailyGrandPresent.textContent = dailyPresentCounts.total;

            // Update UI for Daily Absent totals
            dailyAbsentDateDisplay.textContent = formatDateToDisplay(selectedDailyDate);
            dailyAmAbsent.textContent = dailyAbsentCounts["AM Shift"];
            dailyPmAbsent.textContent = dailyAbsentCounts["PM Shift"];
            dailyNightAbsent.textContent = dailyAbsentCounts["Night Shift"];
            dailyGrandAbsent.textContent = dailyAbsentCounts.total;

            // Update UI for original Total Daily Students
            dailyDateDisplay.textContent = formatDateToDisplay(selectedDailyDate);
            dailyAmTotal.textContent = dailyTotalCounts["AM Shift"];
            dailyPmTotal.textContent = dailyTotalCounts["PM Shift"];
            dailyNightTotal.textContent = dailyTotalCounts["Night Shift"];
            dailyGrandTotal.textContent = dailyTotalCounts.total;

            // Update new overall summary for main page (Registered Total Student)
            mainPageOverallAttendanceCount.textContent = uniqueStudentsInYear.size;
        }


        // Toggle student attendance for the current date
        async function toggleAttendance(studentId, studentType, isPresent) {
            console.group(`toggleAttendance: Toggling attendance for ${studentId} to ${isPresent ? 'Present' : 'Absent'}`);
            const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, studentId);
            const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
            const now = Date.now();

            try {
                // Find the student to get their defaultShift and defaultScheduledTime
                const studentData = allStudentsData.find(s => s.id === studentId);
                if (!studentData) {
                    showMessage("Student data not found for toggling attendance.", 'error');
                    console.error("toggleAttendance: Student data not found for ID:", studentId);
                    console.groupEnd();
                    return;
                }
                console.log("toggleAttendance: Student Data found:", studentData);

                // Get the existing attendance record for the current date
                const existingAttendanceRecord = studentData.attendance ? studentData.attendance[currentDateFormatted] : null;
                console.log("toggleAttendance: Existing Attendance Record for today:", existingAttendanceRecord);

                const scheduledDurationMs = studentType === 'Regular' ? REGULAR_DURATION_MS : TRIAL_DURATION_MS;

                if (isPresent) { // Marking student as Present
                    console.log(`toggleAttendance: Marking student ${studentId} as PRESENT.`);
                    // Stop any active internal timer for this student if present
                    if (activeTimerStudentId === studentId) {
                        stopInternalTimer(); // Stop the internal timer logic
                    }
                    stopRunningTimeDisplay(); // Stop the running time display immediately

                    let startTimeToSet = null;
                    let endTimeToSet = null; // Always null when marking 'Present' to start a new session
                    let durationToSet = 0;   // Always 0 when marking 'Present' to start a new session
                    let statusToSet = 'Active'; // Default for a new active lesson

                    // Determine the shift for the student based on their default scheduled time
                    const studentDefaultShift = determineShift(new Date(convert12toTimestamp(studentData.defaultScheduledTime, selectedDailyDate)));
                    console.log(`toggleAttendance: Student's default shift determined as: ${studentDefaultShift}`);

                    // When toggling to 'Present', always treat it as starting a new active session
                    // (or scheduling it if the default time is in the future).
                    // This overrides any previous completed/overtime/undertime state for this day.
                    startTimeToSet = convert12toTimestamp(studentData.defaultScheduledTime, selectedDailyDate);
                    console.log(`toggleAttendance: Attempted startTime from defaultScheduledTime (${studentData.defaultScheduledTime}): ${startTimeToSet}`);

                    if (startTimeToSet === null || isNaN(startTimeToSet)) { // Added isNaN check for robustness
                        console.log(`toggleAttendance: DefaultScheduledTime was invalid or not set. Falling back to current slot.`);
                        // Fallback to current slot if defaultScheduledTime is invalid or not set
                        startTimeToSet = getScheduledOrCurrentSlotStartTime(new Date(now), studentType);
                    }

                    if (startTimeToSet === null || isNaN(startTimeToSet)) { // Final check after fallback
                        showMessage("Could not determine a valid start time. Student marked as Absent.", 'info');
                        console.log(`toggleAttendance: No valid start time could be determined for ${studentId}. Forcing 'Absent'.`);
                        // If no valid start time can be determined, force absent
                        await updateDoc(studentDocRef, {
                            [`attendance.${currentDateFormatted}.present`]: false,
                            [`attendance.${currentDateFormatted}.startTime`]: null, // Explicitly null for truly absent
                            [`attendance.${currentDateFormatted}.endTime`]: null,
                            [`attendance.${currentDateFormatted}.durationMs`]: scheduledDurationMs, // Default duration for absent
                            [`attendance.${currentDateFormatted}.status`]: 'Absent',
                            [`attendance.${currentDateFormatted}.shift`]: studentDefaultShift // Use determined shift here
                        });
                        console.groupEnd();
                        return;
                    }

                    // NEW: Check if the user is ON SHIFT for this student's scheduled time and shift
                    const userShiftForStudentTime = determineShift(new Date(startTimeToSet));
                    const isUserAvailableForShift = userShiftForStudentTime !== "Unknown Shift";

                    if (!isUserAvailableForShift) {
                        showMessage(`Cannot mark student present. You are OFF SHIFT for the ${studentDefaultShift} on ${daysOfWeek[new Date(startTimeToSet).getDay()]}. Student marked as Absent (Rest Day).`, 'info');
                        await updateDoc(studentDocRef, {
                            [`attendance.${currentDateFormatted}.present`]: false,
                            [`attendance.${currentDateFormatted}.startTime`]: startTimeToSet, // Still record scheduled time
                            [`attendance.${currentDateFormatted}.endTime`]: null,
                            [`attendance.${currentDateFormatted}.durationMs`]: scheduledDurationMs, // Default duration for absent
                            [`attendance.${currentDateFormatted}.status`]: 'Rest Day', // Explicitly mark as Rest Day
                            [`attendance.${currentDateFormatted}.shift`]: studentDefaultShift // Still record the intended shift
                        });
                        console.groupEnd();
                        return;
                    }


                    statusToSet = (startTimeToSet > now) ? 'Scheduled' : 'Active';
                    console.log(`toggleAttendance: New 'Present' entry for ${studentId}. Determined StartTime: ${new Date(startTimeToSet).toLocaleString()}, Status: ${statusToSet}`);

                    console.log(`toggleAttendance: Preparing to update Firestore for ${studentId} to Present with:`);
                    console.log(`  present: true`);
                    console.log(`  startTime: ${startTimeToSet} (${new Date(startTimeToSet).toLocaleString()})`);
                    console.log(`  endTime: ${endTimeToSet} (${endTimeToSet ? new Date(endTimeToSet).toLocaleString() : ''})`); // This will be null
                    console.log(`  durationMs: ${durationToSet}`); // This will be 0
                    console.log(`  status: ${statusToSet}`);
                    console.log(`  shift: ${studentDefaultShift}`); // Use determined shift

                    await updateDoc(studentDocRef, {
                        [`attendance.${currentDateFormatted}.present`]: true,
                        [`attendance.${currentDateFormatted}.startTime`]: startTimeToSet,
                        [`attendance.${currentDateFormatted}.endTime`]: endTimeToSet, // Always null
                        [`attendance.${currentDateFormatted}.durationMs`]: durationToSet, // Always 0
                        [`attendance.${currentDateFormatted}.status`]: statusToSet,
                        [`attendance.${currentDateFormatted}.shift`]: studentDefaultShift // Use determined shift
                    });
                    console.log(`toggleAttendance: Firestore updated for ${studentId} to Present.`);
                    showMessage(`Attendance updated for student ID: ${studentId}`, 'success');

                    // If setting to Present and it's an active/scheduled lesson, start the internal timer
                    if (statusToSet === 'Active' || statusToSet === 'Scheduled') {
                        startInternalTimer(studentId, studentType, startTimeToSet);
                        startRunningTimeDisplay(studentId, startTimeToSet); // Start running display
                    }

                } else { // Marking student as Absent
                    console.log(`toggleAttendance: Marking student ${studentId} as ABSENT.`);
                    // Stop the internal timer if this student was active
                    if (activeTimerStudentId === studentId) {
                        stopInternalTimer();
                    }
                    stopRunningTimeDisplay(); // Stop the running time display immediately


                    // Use the student's default shift for the attendance record
                    const studentDefaultShift = determineShift(new Date(convert12toTimestamp(studentData.defaultScheduledTime, selectedDailyDate)));
                    console.log(`toggleAttendance: Student's default shift determined as: ${studentDefaultShift}`);


                    // When marking absent, we want to preserve the startTime and endTime if they exist,
                    // but set 'present' to false and status to 'Absent'.
                    // This allows restoring the previous state if toggled back to 'Present'.
                    let startTimeToPreserve = existingAttendanceRecord?.startTime || null;
                    let endTimeToPreserve = existingAttendanceRecord?.endTime || null;
                    let durationToPreserve = existingAttendanceRecord?.durationMs || scheduledDurationMs; // Use existing or default
                    // Note: The status is explicitly set to 'Absent' here.

                    console.log(`toggleAttendance: Preparing to update Firestore for ${studentId} to Absent with:`);
                    console.log(`  present: false`);
                    console.log(`  startTime: ${startTimeToPreserve} (${startTimeToPreserve ? new Date(startTimeToPreserve).toLocaleString() : ''})`);
                    console.log(`  endTime: ${endTimeToPreserve} (${endTimeToPreserve ? new Date(endTimeToPreserve).toLocaleString() : ''})`);
                    console.log(`  durationMs: ${durationToPreserve}`);
                    console.log(`  status: Absent`);
                    console.log(`  shift: ${studentDefaultShift}`); // Use determined shift

                    await updateDoc(studentDocRef, {
                        [`attendance.${currentDateFormatted}.present`]: false,
                        [`attendance.${currentDateFormatted}.startTime`]: startTimeToPreserve, // Preserve start time
                        [`attendance.${currentDateFormatted}.endTime`]: endTimeToPreserve,   // Preserve end time
                        [`attendance.${currentDateFormatted}.durationMs`]: durationToPreserve, // Preserve duration
                        [`attendance.${currentDateFormatted}.status`]: 'Absent',
                        [`attendance.${currentDateFormatted}.shift`]: studentDefaultShift // Use determined shift
                    });
                    console.log(`toggleAttendance: Firestore updated for ${studentId} to Absent.`);
                    showMessage(`Attendance updated for student ID: ${studentId}`, 'success');
                }
            } catch (e) {
                console.error("toggleAttendance: Error updating attendance: ", e);
                showMessage("Error updating attendance. Check console for details.", 'error');
            } finally {
                console.groupEnd();
            }
        }

        // Manually end a lesson
        async function endLesson(studentId) {
            console.group(`endLesson: Attempting to end lesson for student: ${studentId}`);
            const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
            const studentData = allStudentsData.find(s => s.id === studentId);

            if (!studentData) {
                showMessage("Student data not found.", 'error');
                console.error("endLesson: Student data not found for ID:", studentId);
                console.groupEnd();
                return;
            }

            const attendanceRecord = studentData.attendance?.[currentDateFormatted];
            console.log("endLesson: Current attendance record:", attendanceRecord);

            // Check if the lesson is actually ongoing (present, has start time, and no end time)
            if (!attendanceRecord || attendanceRecord.present === false || attendanceRecord.startTime === null || attendanceRecord.endTime !== null) {
                showMessage("This lesson is not currently active or has already ended.", 'info');
                console.log("endLesson: Lesson not active or already ended. No action taken.");
                console.groupEnd();
                return;
            }

            // If the lesson is indeed ongoing (active or overtime), then stop and save.
            console.log("endLesson: Lesson is active. Calling stopAndSaveTimer.");
            await stopAndSaveTimer(studentId);
            showMessage("Lesson ended.", 'success');
            console.groupEnd();
        }

        // Function to stop the internal timer for a specific student and save its duration to Firestore
        async function stopAndSaveTimer(studentIdToStop) {
            console.group(`stopAndSaveTimer: Stopping and saving timer for student: ${studentIdToStop}`);
            // Only clear the global active timer if it's the one we're stopping
            if (activeTimerStudentId === studentIdToStop) {
                stopInternalTimer(); // Stop the internal timer logic
            } else {
                console.log(`stopAndSaveTimer: Student ${studentIdToStop} is not the globally active timer. Only saving its state.`);
            }
            stopRunningTimeDisplay(); // Stop the running time display immediately


            const now = Date.now();
            const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
            const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, studentIdToStop);

            // Fetch the current attendance record to get the original startTime
            const studentData = allStudentsData.find(s => s.id === studentIdToStop);
            if (!studentData) {
                console.error("stopAndSaveTimer: Student data not found for ID:", studentIdToStop);
                console.groupEnd();
                return;
            }
            const attendanceRecord = studentData?.attendance?.[currentDateFormatted];
            console.log("stopAndSaveTimer: Attendance record for saving:", attendanceRecord);

            let elapsedMillis = 0;
            let finalStatus = 'Complete'; // Default status
            const scheduledDurationMs = studentData.studentType === 'Regular' ? REGULAR_DURATION_MS : TRIAL_DURATION_MS;

            if (attendanceRecord && attendanceRecord.startTime !== null) {
                // If the timer was scheduled but not yet started, duration is 0
                if (now < attendanceRecord.startTime) {
                    elapsedMillis = 0;
                    finalStatus = 'Scheduled'; // This case should ideally not be triggered by 'End Lesson'
                    console.log(`stopAndSaveTimer: Lesson for ${studentIdToStop} was scheduled but not started. Duration 0, status Scheduled.`);
                } else {
                    elapsedMillis = now - attendanceRecord.startTime;
                    if (elapsedMillis < scheduledDurationMs) {
                        finalStatus = 'Undertime';
                    } else if (elapsedMillis > scheduledDurationMs) {
                        finalStatus = 'Overtime'; // Overtime status is still tracked internally, just not a top sort priority
                    } else { // elapsedMillis === scheduledDurationMs
                        finalStatus = 'Complete';
                    }
                    console.log(`stopAndSaveTimer: Lesson for ${studentIdToStop} was active. Elapsed: ${formatDuration(elapsedMillis)}, status: ${finalStatus}.`);
                }
            } else {
                console.log(`stopAndSaveTimer: No valid startTime found for ${studentIdToStop} to calculate elapsed time. Setting duration to 0.`);
                elapsedMillis = 0; // If no start time, duration is 0
                finalStatus = ''; // Changed from 'N/A'
            }

            console.log(`stopAndSaveTimer: Preparing to update Firestore for ${studentIdToStop} with:`);
            console.log(`  endTime: ${now} (${new Date(now).toLocaleString()})`);
            console.log(`  durationMs: ${elapsedMillis}`);
            console.log(`  status: ${finalStatus}`);

            try {
                await updateDoc(studentDocRef, {
                    [`attendance.${currentDateFormatted}.endTime`]: now,
                    [`attendance.${currentDateFormatted}.durationMs`]: elapsedMillis,
                    [`attendance.${currentDateFormatted}.status`]: finalStatus
                });
                console.log(`stopAndSaveTimer: Firestore updated for ${studentIdToStop}.`);
            } catch (e) {
                console.error(`stopAndSaveTimer: Error saving timer duration for ${studentIdToStop}:`, e);
            } finally {
                // Trigger a re-render to update the UI (hide the button, update status)
                filterAndRenderStudents();
                console.groupEnd();
            }
        }


        // Delete a student from Firestore with confirmation
        async function deleteStudent(studentId) {
            // Using a custom modal instead of confirm()
            const confirmDelete = new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    text-align: center;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                `;
                modalContent.innerHTML = `
                    <p class="text-lg font-bold mb-4 text-gray-800">Are you sure you want to delete this student?</p>
                    <p class="text-sm text-gray-600 mb-6">This action cannot be undone.</p>
                    <button id="confirmYes" class="btn btn-primary mr-4">Yes</button>
                    <button id="confirmNo" class="btn btn-secondary">No</button>
                `;
                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                document.getElementById('confirmYes').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                document.getElementById('confirmNo').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
            });

            const confirmation = await confirmDelete;
            if (!confirmation) {
                return;
            }

            console.log("Deleting student:", studentId);
            const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, studentId);
            try {
                await deleteDoc(studentDocRef);
                showMessage("Student deleted successfully!", 'success');
                if (activeTimerStudentId === studentId) {
                    stopInternalTimer(); // Stop and reset internal timer if the deleted student was active
                    stopRunningTimeDisplay(); // Stop running display
                }
            }
            catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("Error deleting student.", 'error');
            }
        }

        // Clear all students
        async function clearAllStudents() {
            // Using a custom modal instead of confirm()
            const confirmClear = new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    text-align: center;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                `;
                modalContent.innerHTML = `
                    <p class="text-lg font-bold mb-4 text-gray-800">Are you sure you want to clear all students?</p>
                    <p class="text-sm text-gray-600 mb-6">This action cannot be undone.</p>
                    <button id="confirmYes" class="btn btn-primary mr-4">Yes</button>
                    <button id="confirmNo" class="btn btn-secondary">No</button>
                `;
                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                document.getElementById('confirmYes').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                document.getElementById('confirmNo').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
            });

            const confirmation = await confirmClear;
            if (!confirmation) {
                return;
            }
            console.log("Clearing all students...");

            try {
                const studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
                const q = query(studentsCollectionRef);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessage("No students to clear.", 'info');
                    console.log("No students found to clear.");
                    return;
                }

                const deletePromises = [];
                querySnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });

                await Promise.all(deletePromises);
                showMessage("All students cleared successfully!", 'success');
                console.log("All students cleared.");
                stopInternalTimer(); // Stop any running internal timer when all students are cleared
                stopRunningTimeDisplay(); // Stop running display
            } catch (e) {
                console.error("Error clearing all students: ", e);
                showMessage("Error clearing all students.", 'error');
            }
        }

        // Listen for real-time updates to the students collection
        function listenForStudents() {
            console.log("listenForStudents: Setting up real-time listener for students...");
            if (!userId || userId === 'anonymous') {
                console.warn("listenForStudents: User ID not available yet for Firestore listener. Waiting for authentication.");
                return;
            }
            const studentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/students`);
            const q = query(studentsCollectionRef);

            onSnapshot(q, (snapshot) => {
                console.log("listenForStudents: Received new snapshot from Firestore.");
                allStudentsData = []; // Clear previous data
                snapshot.forEach((doc) => {
                    allStudentsData.push({ id: doc.id, ...doc.data() });
                });
                // Sort students by creation date in memory for consistent display
                allStudentsData.sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));

                // --- START: Simulate Maor's time fix for July 21, 2025 ---
                const maorId = "1589627";
                const maorDate = "2025-07-21";
                const maorStudent = allStudentsData.find(s => s.studentId === maorId);

                if (maorStudent && maorStudent.attendance && maorStudent.attendance[maorDate]) {
                    const maorAttendance = maorStudent.attendance[maorDate];
                    // Create a Date object for 04:27 AM on July 21, 2025
                    const dateObj = new Date(maorDate);
                    dateObj.setHours(4, 27, 0, 0); // Set to 4:27 AM

                    const newEndTime = dateObj.getTime();
                    const newDuration = newEndTime - (maorAttendance.startTime || 0); // Calculate duration from existing start time
                    
                    // Determine new status based on new duration
                    let newStatus = 'Complete'; // Default
                    const scheduledDurationMs = maorStudent.studentType === 'Regular' ? REGULAR_DURATION_MS : TRIAL_DURATION_MS;
                    if (newDuration < scheduledDurationMs) {
                        newStatus = 'Undertime';
                    } else if (newDuration > scheduledDurationMs) {
                        newStatus = 'Overtime';
                    }

                    maorAttendance.endTime = newEndTime;
                    maorAttendance.durationMs = newDuration;
                    maorAttendance.status = newStatus;
                    console.log(`Simulated fix for Maor Best on ${maorDate}: EndTime set to ${new Date(newEndTime).toLocaleTimeString()}, Duration: ${formatDurationVerbose(newDuration)}, Status: ${newStatus}`);
                }
                // --- END: Simulate Maor's time fix ---


                updateDatesWithAttendance(); // Update the set of dates with attendance
                filterAndRenderStudents(); // Filter and render the new data, which also updates summary boxes

                // After fetching data, check for any active/scheduled lesson to manage the internal timer
                const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
                let studentForInternalTimer = null;

                // Find the first active or scheduled student for the current day
                const activeOrScheduledStudent = allStudentsData.find(student => {
                    const record = student.attendance ? student.attendance[currentDateFormatted] : null;
                    return record && record.present === true && record.startTime !== null && record.endTime === null && (record.status === 'Active' || record.status === 'Scheduled');
                });

                if (activeOrScheduledStudent) {
                    studentForInternalTimer = activeOrScheduledStudent;
                }

                if (studentForInternalTimer) {
                    console.log("listenForStudents: Managing internal timer for student:", studentForInternalTimer.id, "with status:", studentForInternalTimer.attendance[currentDateFormatted].status);
                    // Clear any existing internal timer to prevent duplicates
                    stopInternalTimer();
                    // Set up the internal timer based on the fetched data
                    startInternalTimer(studentForInternalTimer.id, studentForInternalTimer.studentType, studentForInternalTimer.attendance[currentDateFormatted].startTime);
                    startRunningTimeDisplay(studentForInternalTimer.id, studentForInternalTimer.attendance[currentDateFormatted].startTime); // Start running display
                } else {
                    console.log("listenForStudents: No active/scheduled student found. Ensuring internal timer is stopped.");
                    stopInternalTimer(); // Ensure no internal timer is running if no relevant student is found
                    stopRunningTimeDisplay(); // Stop running display
                }

                if (!allStudentsPage.classList.contains('hidden')) { // Only re-render if the all students page is currently visible
                    renderAllStudentsList();
                }
            }, (error) => {
                console.error("Error listening for students:", error);
                showMessage("Failed to load students. Check console for details.", 'error');
            });
        }

        // Function to populate the datesWithAttendance Set
        function updateDatesWithAttendance() {
            datesWithAttendance.clear();
            allStudentsData.forEach(student => {
                if (student.attendance && typeof student.attendance === 'object') {
                    for (const dateString in student.attendance) {
                        // Check if the attendance value is explicitly true or false (meaning a record exists)
                        if (student.attendance[dateString] !== undefined) {
                            datesWithAttendance.add(dateString);
                        }
                    }
                }
            });
            console.log("Dates with attendance updated:", datesWithAttendance);
        }

        // --- Calendar Picker Functions ---
        function renderCalendar() {
            calendarDaysGrid.innerHTML = '';
            calendarMonthYear.textContent = currentCalendarDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth(); // 0-indexed month

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            // Calculate days from previous month to display
            const prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.classList.add('calendar-day', 'other-month');
                day.textContent = prevMonthDays - i;
                calendarDaysGrid.appendChild(day);
            }

            // Render days of the current month
            for (let i = 1; i <= daysInMonth; i++) {
                const day = document.createElement('div');
                day.classList.add('calendar-day');
                day.textContent = i;

                const currentDay = new Date(year, month, i);
                const today = new Date();
                today.setHours(0,0,0,0); // Normalize today's date

                // Format the current day for lookup in the Set
                const formattedDayForCheck = formatDateToYYYYMMDD(currentDay);

                // Add 'has-students' class if there's attendance for this day
                if (datesWithAttendance.has(formattedDayForCheck)) {
                    day.classList.add('has-students');
                }

                // Add 'today' class if it's today's date
                if (currentDay.toDateString() === today.toDateString()) {
                    day.classList.add('today');
                }

                // Add 'selected' class if it's the currently selected daily date
                if (currentDay.toDateString() === selectedDailyDate.toDateString()) {
                    day.classList.add('selected');
                }

                day.addEventListener('click', () => {
                    selectedDailyDate = currentDay;
                    currentDateInput.value = formatDateToYYYYMMDD(selectedDailyDate);
                    displaySelectedDate.textContent = formatDateToDisplay(selectedDailyDate);
                    remindedStudents.clear(); // Clear reminders for new day
                    filterAndRenderStudents(); // Re-filter and render based on new daily date
                });
                calendarDaysGrid.appendChild(day);
            }

            // Calculate days from next month to display
            const totalCells = firstDayOfWeek + daysInMonth;
            const remainingCells = 42 - totalCells; // Max 6 rows * 7 days = 42 cells
            for (let i = 1; i <= remainingCells; i++) {
                const day = document.createElement('div');
                day.classList.add('calendar-day', 'other-month');
                day.textContent = i;
                calendarDaysGrid.appendChild(day);
            }
        }

        function navigateCalendar(unit, direction) {
            if (unit === 'month') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            } else if (unit === 'year') {
                currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() + direction);
            }
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            selectedDailyDate = new Date(); // Also set selected date to today
            currentDateInput.value = formatDateToYYYYMMDD(selectedDailyDate);
            displaySelectedDate.textContent = formatDateToDisplay(selectedDailyDate);
            remindedStudents.clear(); // Clear reminders for today
            renderCalendar();
            filterAndRenderStudents(); // Re-filter and render
        }

        function formatDateToYYYYMMDD(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function formatDateToDisplay(date) {
            const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Function to update digital clocks
        function updateDigitalClocks() {
            const now = new Date();

            // Philippines Time (Asia/Manila)
            const philippinesTime = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'Asia/Manila'
            });
            philippinesTimeElement.textContent = philippinesTime;

            // Israel Time (Asia/Jerusalem)
            const israelTime = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'Asia/Jerusalem'
            });
            israelTimeElement.textContent = israelTime;

            // NEW: Update user's shift status display
            updateUserShiftStatusDisplay();
        }

        // Functions to switch between pages
        function showMainAttendancePage() {
            mainAttendancePage.classList.remove('hidden');
            allStudentsPage.classList.add('hidden');
            filterAndRenderStudents(); // Re-render main page content when returning
        }

        function showAllStudentsPage() {
            mainAttendancePage.classList.add('hidden');
            allStudentsPage.classList.remove('hidden');
            // Initialize allStudents page pickers to current month/year if not already set
            if (allStudentsViewMonthIndex === undefined) {
                const now = new Date();
                allStudentsViewMonthIndex = now.getMonth();
                allStudentsViewYear = now.getFullYear();
                allStudentsCutOffType = 'All Month'; // Default
                populateMonthYearSelectors(allStudentsMonthSelect, allStudentsYearSelect, allStudentsViewMonthIndex, allStudentsViewYear);
                allStudentsCutOffPeriodSelect.value = allStudentsCutOffType;
            }
            renderAllStudentsList(); // Render the list when showing the page
        }

        // Function to render all students grouped by shift with attendance history
        function renderAllStudentsList() {
            allStudentsContent.innerHTML = '';
            if (allStudentsData.length === 0) {
                noAllStudentsMessage.classList.remove('hidden');
                allStudentsTotalPresent.textContent = '0';
                allStudentsTotalAbsent.textContent = '0';
                // Also hide the overview message if no students at all
                noOverviewDataMessage.classList.remove('hidden');
                return;
            } else {
                noAllStudentsMessage.classList.add('hidden');
            }

            const shifts = ["AM Shift", "PM Shift", "Night Shift", "Unknown Shift"];
            const studentsByShift = {
                "AM Shift": [],
                "PM Shift": [],
                "Night Shift": [],
                "Unknown Shift": []
            };

            // Determine cut-off dates for filtering
            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const daysInMonth = getDaysInMonth(allStudentsViewYear, allStudentsViewMonthIndex);

            let cutoffStartDate, cutoffEndDate;

            if (allStudentsCutOffType === 'All Month') {
                cutoffStartDate = new Date(allStudentsViewYear, allStudentsViewMonthIndex, 1);
                cutoffEndDate = new Date(allStudentsViewYear, allStudentsViewMonthIndex, daysInMonth);
            } else if (allStudentsCutOffType === 'First Half') {
                cutoffStartDate = new Date(allStudentsViewYear, allStudentsViewMonthIndex, 1);
                cutoffEndDate = new Date(allStudentsViewYear, allStudentsViewMonthIndex, Math.floor(daysInMonth / 2));
            } else if (allStudentsCutOffType === 'Second Half') {
                cutoffStartDate = new Date(allStudentsViewYear, allStudentsViewMonthIndex, Math.floor(daysInMonth / 2) + 1);
                cutoffEndDate = new Date(allStudentsViewYear, allStudentsViewMonthIndex, daysInMonth);
            }

            // Get search query and convert to lowercase for case-insensitive search
            const searchQuery = allStudentsSearchInput.value.toLowerCase();

            let totalPresentForPeriod = 0;
            let totalAbsentForPeriod = 0;

            allStudentsData.forEach(student => {
                // Apply search filter first
                const studentNameLower = student.name.toLowerCase();
                const studentIdLower = student.studentId ? student.studentId.toLowerCase() : '';

                const matchesSearch = searchQuery === '' ||
                                      studentNameLower.includes(searchQuery) ||
                                      studentIdLower.includes(searchQuery);

                if (!matchesSearch) {
                    return; // Skip this student if they don't match the search query
                }

                // Use the student's default shift for categorization in the All Students list
                const shift = student.defaultShift || "Unknown Shift";
                
                // Filter attendance records for the selected cut-off period
                const filteredAttendance = {};
                if (student.attendance && typeof student.attendance === 'object') {
                    for (const dateString in student.attendance) {
                        const [year, month, day] = dateString.split('-').map(Number);
                        const attendanceDate = new Date(year, month - 1, day); // month - 1 because JS months are 0-indexed
                        if (attendanceDate >= cutoffStartDate && attendanceDate <= cutoffEndDate) {
                            filteredAttendance[dateString] = student.attendance[dateString];
                            // Accumulate total present/absent for the summary
                            const attendanceRecord = student.attendance[dateString];
                            if (attendanceRecord && attendanceRecord.present === true) {
                                totalPresentForPeriod++;
                            } else if (attendanceRecord && attendanceRecord.present === false) {
                                totalAbsentForPeriod++;
                            }
                        }
                    }
                }
                // Only add student to the list if they have attendance within the filtered period
                if (Object.keys(filteredAttendance).length > 0) {
                    studentsByShift[shift].push({ ...student, filteredAttendance });
                }
            });

            shifts.forEach(shiftName => {
                const studentsInShift = studentsByShift[shiftName];
                if (studentsInShift.length > 0) {
                    const shiftSection = document.createElement('div');
                    shiftSection.className = 'bg-white p-6 rounded-lg shadow-md';
                    shiftSection.innerHTML = `
                        <h4 class="text-xl font-semibold mb-4 text-gray-700">${shiftName} (${studentsInShift.length} Students)</h4>
                        <ul class="space-y-2">
                            ${studentsInShift.map(student => {
                                let attendanceEntries = '';
                                if (student.filteredAttendance && typeof student.filteredAttendance === 'object') {
                                    // Get dates and sort them chronologically
                                    const dates = Object.keys(student.filteredAttendance).sort((a, b) => new Date(a) - new Date(b));
                                    dates.forEach(dateString => {
                                        const attendanceRecord = student.filteredAttendance[dateString];
                                        const displayDate = new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                        
                                        let displayStatusClass = '';
                                        let displayedStatusText = attendanceRecord.status || ''; // Changed from 'N/A'
                                        let durationDisplay = '';

                                        // Determine overall status (Present/Absent)
                                        const overallStatusText = attendanceRecord.present === true ? 'Present' : 'Absent';

                                        const scheduledDurationMs = student.studentType === 'Regular' ? REGULAR_DURATION_MINS : TRIAL_DURATION_MINS;

                                        if (attendanceRecord && attendanceRecord.present === true) {
                                            if (attendanceRecord.endTime !== null) {
                                                // Lesson was completed
                                                const actualDurationMs = attendanceRecord.endTime - attendanceRecord.startTime;

                                                if (attendanceRecord.status === 'Overtime') {
                                                    displayedStatusText = 'Complete'; // Change 'Overtime' to 'Complete' for display
                                                    displayStatusClass = 'text-green-600'; // Green for complete
                                                    durationDisplay = ` - End: ${formatTimestampTo12Hour(attendanceRecord.endTime)} | Total: ${formatDurationVerbose(actualDurationMs)} (Scheduled: ${formatDurationVerbose(scheduledDurationMs)})`;
                                                } else if (attendanceRecord.status === 'Undertime') {
                                                    displayedStatusText = 'Undertime'; // Keep Undertime
                                                    displayStatusClass = 'text-orange-500';
                                                    durationDisplay = ` - End: ${formatTimestampTo12Hour(attendanceRecord.endTime)} | Total: ${formatDurationVerbose(actualDurationMs)} (Scheduled: ${formatDurationVerbose(scheduledDurationMs)})`;
                                                } else { // Complete
                                                    displayedStatusText = 'Complete'; // Explicitly set to Complete
                                                    displayStatusClass = 'text-green-600';
                                                    // If actual duration is exactly scheduled duration, don't show "Scheduled" part
                                                    if (actualDurationMs === scheduledDurationMs) {
                                                        durationDisplay = ` - End: ${formatTimestampTo12Hour(attendanceRecord.endTime)} | Total: ${formatDurationVerbose(actualDurationMs)}`;
                                                    } else {
                                                        durationDisplay = ` - End: ${formatTimestampTo12Hour(attendanceRecord.endTime)} | Total: ${formatDurationVerbose(actualDurationMs)} (Scheduled: ${formatDurationVerbose(scheduledDurationMs)})`;
                                                    }
                                                }
                                            } else {
                                                // Lesson was never officially ended (endTime is null)
                                                const recordDate = new Date(dateString);
                                                const today = new Date();
                                                today.setHours(0,0,0,0); // Normalize today's date

                                                if (recordDate.toDateString() === today.toDateString() && attendanceRecord.startTime <= Date.now()) {
                                                    // It's today and lesson started: show current running time
                                                    // For currently active lessons, regardless of internal 'Overtime' status, display 'Active'
                                                    if (attendanceRecord.status === 'Overtime' || attendanceRecord.status === 'Active') {
                                                        displayedStatusText = 'Active';
                                                        displayStatusClass = 'text-green-600';
                                                    } else if (attendanceRecord.status === 'Scheduled') {
                                                        displayedStatusText = 'Scheduled';
                                                        displayStatusClass = 'text-blue-600';
                                                    } else if (attendanceRecord.status === 'Undertime') {
                                                        displayedStatusText = 'Undertime';
                                                        displayStatusClass = 'text-orange-500';
                                                    }
                                                } else {
                                                    // It's a past date and lesson was never ended, or a future scheduled lesson
                                                    displayedStatusText = 'Unfinished'; // Indicate it was not properly ended
                                                    displayStatusClass = 'text-gray-500 status-unfinished'; // Muted color for unfinished past lessons
                                                }
                                            }
                                        } else if (attendanceRecord && attendanceRecord.present === false) {
                                            // Absent student
                                            displayedStatusText = 'Absent';
                                            displayStatusClass = 'text-red-600';
                                            // NEW: Display default duration for absent students
                                            durationDisplay = ` | Total: ${formatDurationVerbose(scheduledDurationMs)}`;
                                        } else if (attendanceRecord && attendanceRecord.status === 'Rest Day') { // Check status for Rest Day
                                            displayedStatusText = 'Rest Day';
                                            displayStatusClass = 'status-rest-day';
                                            // NEW: Display default duration for absent/rest day students
                                            durationDisplay = ` | Total: ${formatDurationVerbose(scheduledDurationMs)}`;
                                        }
                                        
                                        // Display scheduled start time for the attendance entry
                                        const scheduledTimeDisplay = formatTimestampTo12Hour(attendanceRecord ? attendanceRecord.startTime : null);

                                        attendanceEntries += `
                                            <li class="text-gray-700 text-sm">
                                                <span class="font-semibold">${displayDate}</span> |
                                                <span class="${displayStatusClass} font-bold">${overallStatusText} - ${displayedStatusText}</span> |
                                                <span>Scheduled: ${scheduledTimeDisplay}${durationDisplay}</span>
                                            </li>
                                        `;
                                    });
                                } else {
                                    attendanceEntries = `<li class="text-gray-600 text-sm">No attendance records for this period.</li>`;
                                }
                                return `
                                    <li class="p-2 bg-gray-50 rounded-md">
                                        <div class="font-bold text-gray-800">${student.name} (${student.studentId || ''})</div>
                                        <div class="text-xs text-gray-500 mb-2">Type: ${student.studentType || ''}</div>
                                        <ul class="list-disc list-inside space-y-1 pl-4">
                                            ${attendanceEntries}
                                        </ul>
                                    </li>
                                `;
                            }).join('')}
                        </ul>
                    `;
                    allStudentsContent.appendChild(shiftSection);
                }
            });
            // If no students are found after filtering (either by search or date range)
            if (allStudentsContent.children.length === 0) {
                noAllStudentsMessage.classList.remove('hidden');
            } else {
                noAllStudentsMessage.classList.add('hidden');
            }

            // Update the new summary totals
            allStudentsTotalPresent.textContent = totalPresentForPeriod;
            allStudentsTotalAbsent.textContent = totalAbsentForPeriod;

            // NEW: Render the overview section for this page
            renderOverviewSection(cutoffStartDate, cutoffEndDate);
        }

        // --- Export CSV Function ---
        function exportTableToCsv(filename = 'student_attendance.csv') {
            const table = document.querySelector('#studentTableBody').closest('table');
            if (!table) {
                showMessage("Table not found for export.", 'error');
                return;
            }

            let csv = [];
            // Get table headers
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
            // Filter out 'Actions' header if it exists
            const filteredHeaders = headers.filter(header => header !== 'Actions');
            csv.push(filteredHeaders.join(','));

            // Get table rows
            table.querySelectorAll('tbody tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach((cell, index) => {
                    // Skip the 'Actions' column (last column)
                    // The number of columns has changed, so recalculate the index to skip
                    const numCells = row.cells.length;
                    if (index < numCells - 1) { // Skip the last column (Actions)
                        let cellText = cell.innerText.trim();
                        // Handle comma in data by enclosing in quotes
                        if (cellText.includes(',')) {
                            cellText = `"${cellText}"`;
                        }
                        rowData.push(cellText);
                    }
                });
                csv.push(rowData.join(','));
            });

            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("CSV exported successfully!", 'success');
            } else {
                showMessage("Your browser does not support downloading files directly.", 'error');
            }
        }

        // --- Print Function ---
        function printTable() {
            const tableSection = document.querySelector('.table-section');
            if (!tableSection) {
                showMessage("Table section not found for printing.", 'error');
                return;
            }

            // Create a temporary div to hold the content for printing
            const printContent = document.createElement('div');
            printContent.classList.add('print-only'); // Add a class for print-specific CSS

            // Clone the table and its contents
            const tableToPrint = tableSection.cloneNode(true);
            printContent.appendChild(tableToPrint);

            // Append to body, trigger print, then remove
            document.body.appendChild(printContent);
            window.print();
            document.body.removeChild(printContent);
        }

        // --- Internal Timer Functions (No longer for display, only for auto-ending lessons) ---
        function stopInternalTimer() {
            console.log("stopInternalTimer called. activeTimerStudentId was:", activeTimerStudentId);
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                console.log("stopInternalTimer: Cleared timerInterval.");
            }
            if (timerScheduledTimeout) {
                clearTimeout(timerScheduledTimeout);
                timerScheduledTimeout = null;
                console.log("stopInternalTimer: Cleared timerScheduledTimeout.");
            }
            activeTimerStudentId = null;
            timerStartTimeMillis = null;
            timerMaxDurationMillis = 0;
            remindedStudents.clear(); // Clear reminders when timer stops
            console.log(`stopInternalTimer: Internal timer cleared.`);
        }

        // Starts or schedules a new internal timer for auto-ending lessons
        function startInternalTimer(studentId, studentType, scheduledStartTime) {
            console.group(`startInternalTimer: Attempting to start internal timer for ${studentId}. Scheduled Start: ${new Date(scheduledStartTime).toLocaleString()}`);
            stopInternalTimer(); // Ensure any previous timer/timeout is cleared

            activeTimerStudentId = studentId;
            timerStartTimeMillis = scheduledStartTime;
            timerMaxDurationMillis = (studentType === 'Regular' ? REGULAR_DURATION_MS : TRIAL_DURATION_MS);

            const now = Date.now();
            let delay = scheduledStartTime - now;

            if (delay < 0) {
                delay = 0; // Start immediately if already past due
            }

            // Set up interval to check for auto-end and reminders
            if (!timerInterval) {
                timerInterval = setInterval(checkInternalTimerStatus, 1000);
                console.log("startInternalTimer: Started new timerInterval for internal checks.");
            }
            checkInternalTimerStatus(); // Initial check

            if (delay > 0) {
                console.log(`startInternalTimer: Lesson for ${studentId} scheduled to start in ${delay / 1000} seconds. Setting timeout to update status to 'Active'.`);
                timerScheduledTimeout = setTimeout(() => {
                    console.log(`startInternalTimer: Scheduled timeout triggered for ${studentId}. Updating status to 'Active'.`);
                    const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, studentId);
                    const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
                    updateDoc(studentDocRef, {
                        [`attendance.${currentDateFormatted}.status`]: 'Active'
                    }).catch(e => console.error("Error updating status to Active:", e));
                }, delay);
            } else {
                console.log(`startInternalTimer: Lesson for ${studentId} starting immediately (delay <= 0).`);
            }
            console.groupEnd();
        }

        // Function to check and manage the internal timer status (reminders, auto-end)
        function checkInternalTimerStatus() {
            if (!activeTimerStudentId || timerStartTimeMillis === null) {
                return;
            }

            const now = Date.now();
            let timeDifference = timerStartTimeMillis - now; // Positive if future, negative if past (elapsed)

            const studentData = allStudentsData.find(s => s.id === activeTimerStudentId);
            if (!studentData) {
                console.log("checkInternalTimerStatus: Student data not found for active internal timer. Stopping timer.");
                stopInternalTimer();
                stopRunningTimeDisplay(); // Also stop running display
                return;
            }

            const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
            const attendanceRecord = studentData.attendance ? studentData.attendance[currentDateFormatted] : null;

            if (!attendanceRecord || attendanceRecord.present === false || attendanceRecord.endTime !== null) {
                console.log("checkInternalTimerStatus: Condition met to stop internal timer (absent, ended, or no record). Stopping.");
                stopInternalTimer();
                stopRunningTimeDisplay(); // Also stop running display
                filterAndRenderStudents(); // Re-render to update UI
                return;
            }

            const maxDuration = timerMaxDurationMillis; // Use the global timerMaxDurationMillis

            if (timeDifference > 0) { // Lesson is scheduled for the future
                // Reminder logic: 1 minute before
                if (timeDifference <= 60 * 1000 && !remindedStudents.has(activeTimerStudentId)) {
                    showMessage(`Reminder: ${studentData.name}'s lesson starts in less than 1 minute!`, 'info');
                    remindedStudents.add(activeTimerStudentId);
                }
            } else { // Lesson is active or overtime (timeDifference is 0 or negative, representing elapsed time)
                // Check if lesson should automatically end (e.g., reached 30 min slot end)
                if (attendanceRecord.startTime) {
                    const slotEndTime = new Date(attendanceRecord.startTime);
                    slotEndTime.setMinutes(slotEndTime.getMinutes() + SCHEDULE_SLOT_DURATION_MS / (60 * 1000)); // Add 30 minutes from start time

                    // If current time is past the end of the allowed 30-minute slot
                    if (now >= slotEndTime.getTime()) {
                        console.log(`checkInternalTimerStatus: Auto-stopping internal timer for ${activeTimerStudentId} due to slot end.`);
                        stopAndSaveTimer(activeTimerStudentId); // This will update Firestore and re-render
                    }
                }
            }
            // Update the running time display regardless of auto-end logic
            updateRunningTimeDisplay();
        }


        // --- Running Time Display Functions ---
        function startRunningTimeDisplay(studentId, startTimeMillis) {
            console.log(`startRunningTimeDisplay: Starting display for ${studentId} from ${new Date(startTimeMillis).toLocaleString()}`);
            // Ensure elements are initialized
            if (!runningTimeDisplayElement) runningTimeDisplayElement = document.getElementById('runningTimeDisplay');
            if (!statusDisplayElement) statusDisplayElement = document.getElementById('statusDisplay');
            if (!activeStudentNameElement) activeStudentNameElement = document.getElementById('activeStudentName');
            if (!activeStudentIdElement) activeStudentIdElement = document.getElementById('activeStudentId');
            if (!activeStudentTypeElement) activeStudentTypeElement = document.getElementById('activeStudentType');
            if (!activeStudentStartTimeElement) activeStudentStartTimeElement = document.getElementById('activeStudentStartTime');
            if (!userShiftStatusDisplayElement) userShiftStatusDisplayElement = document.getElementById('userShiftStatusDisplay');
            if (!standbyStudentsDisplayElement) standbyStudentsDisplayElement = document.getElementById('standbyStudentsDisplay');


            // Clear any existing interval
            if (runningTimeDisplayInterval) {
                clearInterval(runningTimeDisplayInterval);
            }

            // Set the active student for display
            activeTimerStudentId = studentId;
            timerStartTimeMillis = startTimeMillis; // Reuse the timerStartTimeMillis for display calculation

            // Start updating the display every second
            runningTimeDisplayInterval = setInterval(updateRunningTimeDisplay, 1000);
            updateRunningTimeDisplay(); // Initial update
        }

        function stopRunningTimeDisplay() {
            console.log("stopRunningTimeDisplay: Stopping display.");
            if (runningTimeDisplayInterval) {
                clearInterval(runningTimeDisplayInterval);
                runningTimeDisplayInterval = null;
            }
            if (runningTimeDisplayElement) runningTimeDisplayElement.textContent = '00:00';
            if (statusDisplayElement) {
                statusDisplayElement.textContent = 'NO ACTIVE STUDENT';
                statusDisplayElement.className = 'status-value no-active-student';
            }
            // Clear student details (changed from 'N/A' to empty string)
            if (activeStudentNameElement) activeStudentNameElement.textContent = '';
            if (activeStudentIdElement) activeStudentIdElement.textContent = '';
            if (activeStudentTypeElement) activeStudentTypeElement.textContent = '';
            if (activeStudentStartTimeElement) activeStudentStartTimeElement.textContent = '';
            if (standbyStudentsDisplayElement) standbyStudentsDisplayElement.innerHTML = ''; // Clear standby display

            activeTimerStudentId = null; // Clear the active student for display
            timerStartTimeMillis = null; // Clear start time for display
        }

        function updateRunningTimeDisplay() {
            const now = Date.now();
            const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);

            // --- Update Active Student Display ---
            if (!activeTimerStudentId || timerStartTimeMillis === null) {
                stopRunningTimeDisplay(); // Ensure display is cleared if no active student
            } else {
                const studentData = allStudentsData.find(s => s.id === activeTimerStudentId);

                if (!studentData) {
                    console.warn("updateRunningTimeDisplay: Student data not found for active display. Stopping display.");
                    stopRunningTimeDisplay();
                    return;
                }

                const attendanceRecord = studentData.attendance ? studentData.attendance[currentDateFormatted] : null;

                if (!attendanceRecord || attendanceRecord.present === false || attendanceRecord.endTime !== null) {
                    console.log("updateRunningTimeDisplay: Active student is no longer active (absent or ended). Stopping display.");
                    stopRunningTimeDisplay();
                    // After stopping, re-run filterAndRenderStudents to potentially pick up a new active student
                    filterAndRenderStudents();
                    return;
                }

                let elapsedMillis = 0;
                if (now >= timerStartTimeMillis) {
                    elapsedMillis = now - timerStartTimeMillis;
                }

                runningTimeDisplayElement.textContent = formatDuration(elapsedMillis);

                let currentStatusText = attendanceRecord.status;
                let statusClasses = 'status-value';

                // Determine current shift based on actual current time for the student
                const userCurrentShift = determineShift(new Date(now));

                if (userCurrentShift === "Unknown Shift") {
                    currentStatusText = 'REST DAY'; // User is OFF SHIFT, so student is on rest day
                    statusClasses += ' status-rest-day';
                } else {
                    // If they are in their assigned shift, use the status from Firestore
                    if (attendanceRecord.status === 'Active') {
                        statusClasses += ' status-active';
                    } else if (attendanceRecord.status === 'Scheduled') {
                        statusClasses += ' status-scheduled';
                    } else if (attendanceRecord.status === 'Overtime') {
                        statusClasses += ' status-overtime';
                    } else if (attendanceRecord.status === 'Undertime') {
                        statusClasses += ' status-undertime';
                    } else if (attendanceRecord.status === 'Complete') {
                        statusClasses += ' status-complete';
                    }
                }

                statusDisplayElement.textContent = currentStatusText;
                statusDisplayElement.className = statusClasses; // Apply determined classes

                // Update student details in the display box (changed from 'N/A' to empty string)
                activeStudentNameElement.textContent = studentData.name || '';
                activeStudentIdElement.textContent = studentData.studentId || '';
                activeStudentTypeElement.textContent = studentData.studentType || '';
                activeStudentStartTimeElement.textContent = formatTimestampTo12Hour(attendanceRecord?.startTime);
            }

            // --- Update Standby Students Display ---
            const standbyStudents = allStudentsData.filter(student => {
                const record = student.attendance?.[currentDateFormatted];
                // A student is standby if they are scheduled, not the active student, and their start time is in the future
                return record && record.present === true && record.status === 'Scheduled' &&
                       record.startTime > now && student.id !== activeTimerStudentId;
            }).sort((a, b) => {
                // Sort by earliest scheduled time
                const aTime = a.attendance[currentDateFormatted].startTime;
                const bTime = b.attendance[currentDateFormatted].startTime;
                return aTime - bTime;
            }).slice(0, MAX_UPCOMING_SCHEDULES); // Limit to MAX_UPCOMING_SCHEDULES

            standbyStudentsDisplayElement.innerHTML = ''; // Clear previous standby list

            if (standbyStudents.length > 0) {
                standbyStudents.forEach(student => {
                    const scheduledTime = formatTimestampTo12Hour(student.attendance[currentDateFormatted].startTime);
                    const standbyItem = document.createElement('div');
                    standbyItem.classList.add('standby-item');
                    standbyItem.innerHTML = `<span class="standby-label">Standby:</span> <span class="standby-value">${student.name} | ${scheduledTime}</span>`;
                    standbyStudentsDisplayElement.appendChild(standbyItem);
                });
            }
        }


        // NEW: Function to update the user's shift status display (ON SHIFT / OFF SHIFT)
        function updateUserShiftStatusDisplay() {
            if (!userShiftStatusDisplayElement) {
                userShiftStatusDisplayElement = document.getElementById('userShiftStatusDisplay');
            }
            if (!userShiftStatusDisplayElement) return; // Exit if element not found

            const now = new Date();
            const userIsOnShift = isUserCurrentlyOnShift(now);

            if (userIsOnShift) {
                userShiftStatusDisplayElement.textContent = 'ON SHIFT';
                userShiftStatusDisplayElement.className = 'user-shift-status on-shift';
            } else {
                userShiftStatusDisplayElement.textContent = 'OFF SHIFT';
                userShiftStatusDisplayElement.className = 'user-shift-status off-shift';
            }
        }


        // --- Schedule Management Functions ---
        async function loadSchedules() {
            console.log("Loading schedules...");
            if (!userId || userId === 'anonymous') {
                console.warn("User ID not available for schedule loading.");
                return;
            }
            try {
                // Fetch the single schedules config document
                const schedulesDocRef = doc(db, `artifacts/${appId}/users/${userId}/schedules`, 'config');
                const docSnap = await getDoc(schedulesDocRef);

                if (docSnap.exists()) {
                    userSchedules = docSnap.data();
                    console.log("Schedules loaded:", userSchedules);
                } else {
                    console.log("No schedule configuration found. Initializing default empty schedules.");
                    userSchedules = {};
                    daysOfWeek.forEach(day => {
                        userSchedules[day] = {
                            "AM Shift": [],
                            "PM Shift": [],
                            "Night Shift": []
                        };
                    });
                }
            } catch (e) {
                console.error("Error loading schedules:", e);
                showMessage("Error loading schedules.", 'error');
            }
        }

        async function saveSchedules() {
            console.log("Saving schedules...");
            if (!userId || userId === 'anonymous') {
                showMessage("User not authenticated. Cannot save schedules.", 'error');
                return;
            }
            try {
                // Save the entire userSchedules object as a single document
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/schedules`, 'config'), userSchedules);
                showMessage("Schedules saved successfully!", 'success');
                scheduleModal.classList.remove('open');
                // Re-render main page to ensure new shifts and rest days are considered
                filterAndRenderStudents();
            }
            catch (e) {
                console.error("Error saving schedules:", e);
                showMessage("Error saving schedules. Check console for details.", 'error');
            }
        }

        // Converts 24-hour time string (HH:MM) to 12-hour time string (HH:MM AM/PM)
        function convert24to12Hour(time24) {
            if (!time24) return '';
            const [hourStr, minuteStr] = time24.split(':');
            let hour = parseInt(hourStr, 10);
            const minute = parseInt(minuteStr, 10);

            const ampm = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12;
            hour = hour === 0 ? 12 : hour; // The hour '0' (midnight) should be '12' in 12-hour format

            return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')} ${ampm}`;
        }

        // Converts 12-hour time string (HH:MM AM/PM) to 24-hour time string (HH:MM)
        function convert12to24Hour(time12) {
            if (!time12) return '00:00';
            const parts = time12.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!parts) return '00:00'; // Invalid format, default to 00:00

            let hour = parseInt(parts[1], 10);
            const minute = parseInt(parts[2], 10);
            const ampm = parts[3].toUpperCase();

            if (ampm === 'PM' && hour < 12) {
                hour += 12;
            } else if (ampm === 'AM' && hour === 12) {
                hour = 0; // 12 AM (midnight) is 00 in 24-hour format
            }

            return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        }


        function renderSchedulesInModal() {
            dailySchedulesContainer.innerHTML = ''; // Clear existing entries

            daysOfWeek.forEach(dayName => {
                const dailySection = document.createElement('div');
                dailySection.classList.add('daily-schedule-section');
                dailySection.innerHTML = `
                    <div class="daily-schedule-header" data-day="${dayName}">
                        <span>${dayName}</span>
                        <span class="material-icons">expand_more</span>
                    </div>
                    <div class="daily-schedule-content">
                        <!-- Shift subsections will go here -->
                    </div>
                `;
                dailySchedulesContainer.appendChild(dailySection);

                const dailyContent = dailySection.querySelector('.daily-schedule-content');
                const shifts = ["AM Shift", "PM Shift", "Night Shift"];

                shifts.forEach(shiftName => {
                    const shiftSubsection = document.createElement('div');
                    shiftSubsection.classList.add('shift-subsection');
                    shiftSubsection.innerHTML = `
                        <div class="shift-subsection-header" data-day="${dayName}" data-shift="${shiftName}">
                            <span>${shiftName}</span>
                            <span class="material-icons">expand_more</span>
                        </div>
                        <div class="shift-subsection-content">
                            <div id="slots-${dayName.replace(/\s/g, '')}-${shiftName.replace(/\s/g, '')}" class="space-y-3 mb-4">
                                <!-- Time slots will go here -->
                            </div>
                            <button class="btn btn-secondary add-slot-btn" data-day="${dayName}" data-shift="${shiftName}">+ Add Time Slot</button>
                        </div>
                    `;
                    dailyContent.appendChild(shiftSubsection);

                    const slotsContainer = shiftSubsection.querySelector(`#slots-${dayName.replace(/\s/g, '')}-${shiftName.replace(/\s/g, '')}`);
                    const currentSlots = (userSchedules[dayName] && userSchedules[dayName][shiftName]) || [];
                    currentSlots.forEach(slot => {
                        // Convert 24-hour stored time to 12-hour for display
                        addTimeSlotInput(slotsContainer, dayName, shiftName, convert24to12Hour(slot.startTime), convert24to12Hour(slot.endTime));
                    });
                });
            });

            // Add event listeners for daily and shift headers
            document.querySelectorAll('.daily-schedule-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('expanded');
                    header.nextElementSibling.classList.toggle('open');
                });
            });

            document.querySelectorAll('.shift-subsection-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('expanded');
                    header.nextElementSibling.classList.toggle('open');
                });
            });

            // Add event listeners for new "Add Time Slot" buttons
            document.querySelectorAll('.add-slot-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const dayName = event.target.dataset.day;
                    const shiftName = event.target.dataset.shift;
                    const slotsContainer = document.getElementById(`slots-${dayName.replace(/\s/g, '')}-${shiftName.replace(/\s/g, '')}`);
                    addTimeSlotInput(slotsContainer, dayName, shiftName, '12:00 AM', '12:00 AM'); // Default to 12:00 AM
                });
            });
        }

        function addTimeSlotInput(container, dayName, shiftName, startTime = '12:00 AM', endTime = '12:00 AM') {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'time-slot-entry';
            slotDiv.innerHTML = `
                <input type="text" class="start-time-input p-2 border rounded-md" value="${startTime}" placeholder="HH:MM AM/PM" maxlength="8">
                <span>-</span>
                <input type="text" class="end-time-input p-2 border rounded-md" value="${endTime}" placeholder="HH:MM AM/PM" maxlength="8">
                <button class="btn btn-secondary delete-slot-btn"><span class="material-icons text-base">delete</span></button>
            `;
            container.appendChild(slotDiv);

            // Add event listeners for new inputs and delete button
            const startTimeInput = slotDiv.querySelector('.start-time-input');
            const endTimeInput = slotDiv.querySelector('.end-time-input');
            const deleteButton = slotDiv.querySelector('.delete-slot-btn');

            // Input formatting and validation for 12-hour format
            [startTimeInput, endTimeInput].forEach(input => {
                input.addEventListener('input', (e) => {
                    let value = e.target.value.toUpperCase().replace(/[^0-9:APM\s]/g, ''); // Allow digits, :, A, P, M, space
                    // Basic auto-add colon
                    if (value.length === 2 && !value.includes(':') && !value.includes(' ')) {
                        value += ':';
                    }
                    e.target.value = value;
                });
                input.addEventListener('blur', (e) => {
                    let value = e.target.value.toUpperCase().trim();
                    const parts = value.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/);

                    if (!parts) {
                        e.target.value = '12:00 AM'; // Default invalid to 12:00 AM
                        return;
                    }

                    let hour = parseInt(parts[1], 10);
                    let minute = parseInt(parts[2], 10);
                    let ampm = parts[3];

                    // Validate hour
                    if (isNaN(hour) || hour < 1 || hour > 12) hour = 12;
                    // Validate minute to be 00-59
                    if (isNaN(minute) || minute < 0 || minute > 59) minute = 0;

                    // If AM/PM is missing, try to infer or default
                    if (ampm === undefined) { // Check for undefined specifically
                        // Simple inference: if hour is 12, assume PM unless it's 12:00 AM
                        if (hour === 12 && minute === 0) {
                            ampm = 'AM'; // Default 12:00 to AM if no AM/PM specified
                        } else if (hour >= 1 && hour <= 11) {
                            ampm = 'AM'; // Default to AM
                        } else {
                            ampm = 'PM'; // Default to PM for other hours
                        }
                    }

                    e.target.value = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')} ${ampm}`;
                });
            });

            deleteButton.addEventListener('click', () => {
                slotDiv.remove();
                // No need to update userSchedules directly here, it will be rebuilt on save
            });
        }

        // Collects current schedule data from modal and updates userSchedules
        function collectAndSaveSchedules() {
            const newSchedules = {};
            let hasInvalidSlot = false; 

            daysOfWeek.forEach(dayName => {
                newSchedules[dayName] = {
                    "AM Shift": [],
                    "PM Shift": [],
                    "Night Shift": []
                };

                const dailySection = document.querySelector(`.daily-schedule-section .daily-schedule-header[data-day="${dayName}"]`).closest('.daily-schedule-section');
                const shifts = ["AM Shift", "PM Shift", "Night Shift"];

                shifts.forEach(shiftName => {
                    const slotsContainer = dailySection.querySelector(`#slots-${dayName.replace(/\s/g, '')}-${shiftName.replace(/\s/g, '')}`);
                    if (slotsContainer) {
                        slotsContainer.querySelectorAll('.time-slot-entry').forEach(slotDiv => {
                            const startTime12 = slotDiv.querySelector('.start-time-input').value;
                            const endTime12 = slotDiv.querySelector('.end-time-input').value;

                            // Validate 12-hour format and minutes (00-59)
                            const isValid12HourTime = (time12Str) => {
                                const parts = time12Str.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                                if (!parts) return false;
                                const h = parseInt(parts[1], 10);
                                const m = parseInt(parts[2], 10);
                                return (h >= 1 && h <= 12) && (m >= 0 && m <= 59);
                            };

                            if (isValid12HourTime(startTime12) && isValid12HourTime(endTime12)) {
                                // Convert to 24-hour format for storage
                                newSchedules[dayName][shiftName].push({
                                    startTime: convert12to24Hour(startTime12),
                                    endTime: convert12to24Hour(endTime12)
                                });
                            } else {
                                showMessage(`Invalid time format or minutes for ${dayName} ${shiftName} slot: "${startTime12}" - "${endTime12}". Must be HH:MM AM/PM.`, 'error');
                                hasInvalidSlot = true;
                                return; // Skip this invalid slot
                            }
                        });
                    }
                });
            });

            if (!hasInvalidSlot) { // Only save if no invalid slots were found across all sections
                userSchedules = newSchedules; // Update global variable
                saveSchedules(); // Save to Firebase
            }
        }


        // --- Manual Student Entry/Edit Modal Functions ---
        function openManualStudentModal(studentData = null) {
            manualStudentModal.classList.add('open');
            manualAttendanceDateDisplay.textContent = formatDateToDisplay(selectedDailyDate);

            // Reset form fields
            manualStudentDocId.value = '';
            manualStudentNameInput.value = '';
            manualStudentIdInput.value = '';
            manualRegularStudentRadio.checked = false;
            manualTrialStudentRadio.checked = false;
            manualScheduledTimeInput.value = '';
            manualShiftSelect.value = 'Unknown Shift';
            manualPresentRadio.checked = false;
            manualAbsentRadio.checked = false;

            if (studentData) {
                isEditingStudent = true;
                manualModalTitle.textContent = 'Edit Student Details';
                manualStudentDocId.value = studentData.id;
                manualStudentNameInput.value = studentData.name || '';
                manualStudentIdInput.value = studentData.studentId || '';
                if (studentData.studentType === 'Regular') {
                    manualRegularStudentRadio.checked = true;
                } else if (studentData.studentType === 'Trial') {
                    manualTrialStudentRadio.checked = true;
                }

                // Pre-populate scheduled time and shift from default values
                manualScheduledTimeInput.value = studentData.defaultScheduledTime || '';
                manualShiftSelect.value = studentData.defaultShift || 'Unknown Shift';

                // Pre-populate attendance for the selected daily date
                const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
                const attendanceRecord = studentData.attendance ? studentData.attendance[currentDateFormatted] : null;
                if (attendanceRecord) {
                    if (attendanceRecord.present === true) {
                        manualPresentRadio.checked = true;
                    } else if (attendanceRecord.present === false) {
                        manualAbsentRadio.checked = true;
                    }
                }
            } else {
                isEditingStudent = false;
                manualModalTitle.textContent = 'Add New Student Manually';
                // Default new student to Regular and Present for the current day
                manualRegularStudentRadio.checked = true; 
                manualPresentRadio.checked = true;
            }
        }

        async function saveManualStudent() {
            const name = manualStudentNameInput.value.trim();
            let studentId = manualStudentIdInput.value.trim();
            const studentType = document.querySelector('input[name="manualStudentType"]:checked')?.value;
            const scheduledTime12Hour = manualScheduledTimeInput.value.trim();
            const selectedShift = manualShiftSelect.value;
            const attendanceStatus = document.querySelector('input[name="manualAttendanceStatus"]:checked')?.value;

            if (!name) {
                showMessage("Student name cannot be empty.", 'error');
                return;
            }
            if (!studentId) {
                showMessage("Student ID is required.", 'error');
                return;
            }
            const cleanStudentId = studentId.startsWith('#') ? studentId.substring(1) : studentId;
            const studentIdRegex = /^\d+$/;
            if (!studentIdRegex.test(cleanStudentId)) {
                showMessage("Student ID must be numeric, optionally starting with '#'.", 'error');
                return;
            }
            studentId = cleanStudentId; // Use cleaned ID

            if (!studentType) {
                showMessage("Please select student type (Regular or Trial).", 'error');
                return;
            }

            // Validate 12-hour time format
            const isValid12HourTime = (time12Str) => {
                if (!time12Str) return true; // Allow empty
                const parts = time12Str.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (!parts) return false;
                const h = parseInt(parts[1], 10);
                const m = parseInt(parts[2], 10);
                return (h >= 1 && h <= 12) && (m >= 0 && m <= 59); // Allow minutes from 00 to 59
            };

            if (!isValid12HourTime(scheduledTime12Hour)) {
                showMessage("Scheduled Time must be in HH:MM AM/PM format (e.g., 09:00 AM, 01:30 PM).", 'error');
                return;
            }
            
            if (!attendanceStatus) {
                showMessage("Please select attendance status for today.", 'error');
                return;
            }

            const currentDateFormatted = formatDateToYYYYMMDD(selectedDailyDate);
            const now = Date.now();

            try {
                // Convert scheduled time to a timestamp for the selectedDailyDate
                const [hour24, minute24] = convert12to24Hour(scheduledTime12Hour).split(':').map(Number);
                const scheduledTimeDate = new Date(selectedDailyDate);
                scheduledTimeDate.setHours(hour24, minute24, 0, 0);
                const scheduledTimeMillis = scheduledTimeDate.getTime();

                let attendanceUpdate = {};
                let docId = manualStudentDocId.value;

                const scheduledDurationMs = studentType === 'Regular' ? REGULAR_DURATION_MS : TRIAL_DURATION_MS;

                // NEW: Check plotting constraints for manual entry too
                const twoHoursFromNow = now + UPCOMING_SCHEDULE_WINDOW_MS;
                const scheduledStudentsInWindow = allStudentsData.filter(student => {
                    const record = student.attendance?.[currentDateFormatted];
                    // Exclude the current student if editing
                    return student.id !== docId && record && record.status === 'Scheduled' &&
                           record.startTime > now && record.startTime <= twoHoursFromNow;
                });

                if (scheduledTimeMillis > twoHoursFromNow) {
                    showMessage(`Cannot schedule a lesson more than 2 hours in advance (latest: ${formatTimestampTo12Hour(twoHoursFromNow)}).`, 'info');
                    return;
                }

                if (!isEditingStudent && scheduledStudentsInWindow.length >= MAX_UPCOMING_SCHEDULES && scheduledTimeMillis > now) {
                    // Only apply max schedules if adding a new student AND it's a future schedule
                    showMessage(`Maximum of ${MAX_UPCOMING_SCHEDULES} upcoming lessons already scheduled within the next 2 hours.`, 'info');
                    return;
                }

                // NEW: Check if the manually entered time slot is already taken by another student
                const isManualSlotTaken = allStudentsData.some(student => {
                    // Only consider other students, not the one being edited
                    if (isEditingStudent && student.id === docId) return false;
                    const record = student.attendance?.[currentDateFormatted];
                    return record && record.present === true && record.startTime === scheduledTimeMillis;
                });

                if (isManualSlotTaken) {
                    showMessage(`The selected scheduled time (${scheduledTime12Hour}) is already occupied by another student. Please choose a different time.`, 'error');
                    return;
                }


                // Check user's schedule for the selected time and shift
                const userShiftForStudentTime = determineShift(new Date(scheduledTimeMillis));
                const isUserAvailableForShift = userShiftForStudentTime !== "Unknown Shift";

                if (attendanceStatus === 'Present') {
                    if (!isUserAvailableForShift) {
                        showMessage(`Cannot mark student present. You are OFF SHIFT for the ${selectedShift} on ${daysOfWeek[new Date(scheduledTimeMillis).getDay()]}. Student marked as Absent (Rest Day).`, 'info');
                        attendanceUpdate = {
                            present: false,
                            startTime: scheduledTimeMillis,
                            endTime: null,
                            durationMs: scheduledDurationMs,
                            status: 'Rest Day',
                            shift: selectedShift
                        };
                    } else {
                        // For manual "Present" entries, calculate endTime and duration based on fixed duration
                        const finalEndTimeMillis = scheduledTimeMillis + scheduledDurationMs;
                        const finalDurationMs = scheduledDurationMs;
                        const finalStatus = 'Complete'; // Manually marked present with fixed duration implies completion
                        
                        attendanceUpdate = {
                            present: true,
                            startTime: scheduledTimeMillis,
                            endTime: finalEndTimeMillis,
                            durationMs: finalDurationMs,
                            status: finalStatus,
                            shift: selectedShift
                        };
                        console.log("Lesson is being updated/re-scheduled as Complete with fixed duration.");
                    }

                } else { // Manual status is 'Absent'
                    // When marking absent via manual entry, we want to preserve the startTime and endTime if they exist,
                    // but set 'present' to false and status to 'Absent'.
                    // This allows restoring the previous state if toggled back to 'Present'.
                    const currentStudentData = allStudentsData.find(s => s.id === docId);
                    const existingAttendanceRecord = currentStudentData?.attendance?.[currentDateFormatted];
                    let startTimeToPreserve = existingAttendanceRecord?.startTime || scheduledTimeMillis; // Use existing or the manually entered scheduled time
                    let endTimeToPreserve = existingAttendanceRecord?.endTime || null;
                    let durationToPreserve = existingAttendanceRecord?.durationMs || scheduledDurationMs; // Use existing or default

                    attendanceUpdate = {
                        present: false,
                        startTime: startTimeToPreserve, // Preserve start time
                        endTime: endTimeToPreserve,   // Preserve end time
                        durationMs: durationToPreserve, // Preserve duration
                        status: 'Absent',
                        shift: selectedShift
                    };
                    console.log("Student marked as Absent. Preserving previous attendance record.");
                }

                if (isEditingStudent) {
                    const studentDocRef = doc(db, `artifacts/${appId}/users/${userId}/students`, docId);
                    await updateDoc(studentDocRef, {
                        name: name,
                        studentId: studentId,
                        studentType: studentType,
                        defaultScheduledTime: scheduledTime12Hour,
                        defaultShift: selectedShift,
                        [`attendance.${currentDateFormatted}`]: attendanceUpdate // Update specific day's attendance
                    });
                    showMessage("Student updated successfully!", 'success');

                } else { // Adding a new student
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/students`), {
                        name: name,
                        studentId: studentId,
                        studentType: studentType,
                        defaultScheduledTime: scheduledTime12Hour,
                        defaultShift: selectedShift,
                        attendance: {
                            [currentDateFormatted]: attendanceUpdate
                        },
                        createdAt: new Date()
                    });
                    showMessage("New student added successfully!", 'success');
                }
                manualStudentModal.classList.remove('open');
            } catch (e) {
                console.error("Error saving student:", e);
                showMessage("Error saving student. Check console for details.", 'error');
            }
        }


        // Event Listeners
        addStudentBtn.addEventListener('click', addStudent);
        clearAllBtn.addEventListener('click', clearAllStudents);
        monthSelect.addEventListener('change', updateCurrentViewDate);
        yearSelect.addEventListener('change', updateCurrentViewDate);
        cutOffPeriodSelect.addEventListener('change', filterAndRenderStudents);
        prevMonthBtn.addEventListener('click', () => navigateMonth(-1));
        nextMonthBtn.addEventListener('click', () => navigateMonth(1));
        exportCsvBtn.addEventListener('click', exportTableToCsv);
        printBtn.addEventListener('click', printTable);

        // New Student Type Button Listeners for quick add form
        regularStudentBtn.addEventListener('click', () => selectStudentType('Regular'));
        trialStudentBtn.addEventListener('click', () => selectStudentType('Trial'));

        // Calendar Picker Event Listeners
        datePickerTrigger.addEventListener('click', (event) => {
            // Position the calendar picker below the trigger
            const rect = datePickerTrigger.getBoundingClientRect();
            calendarPicker.style.top = `${rect.bottom + 10}px`;
            calendarPicker.style.left = `${rect.left}px`;
            calendarPicker.style.display = calendarPicker.style.display === 'block' ? 'none' : 'block';
            renderCalendar(); // Render calendar when shown
            event.stopPropagation(); // Prevent click from propagating to document
        });

        // Hide calendar when clicking outside
        document.addEventListener('click', (event) => {
            if (calendarPicker.style.display === 'block' && !calendarPicker.contains(event.target) && !datePickerTrigger.contains(event.target)) {
                calendarPicker.style.display = 'none';
            }
        });

        calendarPrevMonth.addEventListener('click', () => navigateCalendar('month', -1));
        calendarNextMonth.addEventListener('click', () => navigateCalendar('month', 1));
        calendarPrevYear.addEventListener('click', () => navigateCalendar('year', -1));
        calendarNextYear.addEventListener('click', () => navigateCalendar('year', 1));
        calendarToday.addEventListener('click', goToToday);

        // Page navigation event listeners
        viewAllStudentsBtn.addEventListener('click', showAllStudentsPage);
        backToAttendanceBtn.addEventListener('click', showMainAttendancePage);

        // All Students Page picker and search event listeners
        allStudentsMonthSelect.addEventListener('change', updateAllStudentsViewSettings);
        allStudentsYearSelect.addEventListener('change', updateAllStudentsViewSettings);
        allStudentsCutOffPeriodSelect.addEventListener('change', updateAllStudentsViewSettings);
        allStudentsPrevMonthBtn.addEventListener('click', () => navigateAllStudentsMonth(-1));
        allStudentsNextMonthBtn.addEventListener('click', () => navigateAllStudentsMonth(1));
        allStudentsSearchInput.addEventListener('input', renderAllStudentsList); // Trigger re-render on search input

        // Schedule Modal Event Listeners
        manageSchedulesBtn.addEventListener('click', () => {
            scheduleModal.classList.add('open');
            renderSchedulesInModal();
        });
        closeScheduleModalBtn.addEventListener('click', () => {
            scheduleModal.classList.remove('open');
        });
        saveSchedulesBtn.addEventListener('click', collectAndSaveSchedules);

        // Manual Student Entry/Edit Modal Event Listeners
        openManualAddModalBtn.addEventListener('click', () => openManualStudentModal());
        closeManualStudentModalBtn.addEventListener('click', () => manualStudentModal.classList.remove('open'));
        cancelManualStudentBtn.addEventListener('click', () => manualStudentModal.classList.remove('open'));
        saveManualStudentBtn.addEventListener('click', saveManualStudent);

        // Input formatting for manualScheduledTimeInput
        manualScheduledTimeInput.addEventListener('input', (e) => {
            let value = e.target.value.toUpperCase().replace(/[^0-9:APM\s]/g, ''); // Allow digits, :, A, P, M, space
            // Basic auto-add colon
            if (value.length === 2 && !value.includes(':') && !value.includes(' ')) {
                value += ':';
            }
            e.target.value = value;
        });
        manualScheduledTimeInput.addEventListener('blur', (e) => {
            let value = e.target.value.toUpperCase().trim();
            const parts = value.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/);

            if (!parts) {
                e.target.value = ''; // Keep empty if invalid, or default to 12:00 AM if you prefer
                return;
            }

            let hour = parseInt(parts[1], 10);
            let minute = parseInt(parts[2], 10);
            let ampm = parts[3];

            // Validate hour
            if (isNaN(hour) || hour < 1 || hour > 12) hour = 12;
            // Validate minute to be 00-59
            if (isNaN(minute) || minute < 0 || minute > 59) minute = 0;

            // If AM/PM is missing, try to infer or default
            if (ampm === undefined) {
                if (hour === 12 && minute === 0) {
                    ampm = 'AM';
                } else if (hour >= 1 && hour <= 11) {
                    ampm = 'AM';
                } else {
                    ampm = 'PM';
                }
            }
            e.target.value = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')} ${ampm}`;
        });

        // NEW: Function to render the overview section
        function renderOverviewSection(cutoffStartDate, cutoffEndDate) {
            dateSummaryGrid.innerHTML = ''; // Clear existing content
            const shifts = ["AM Shift", "PM Shift", "Night Shift", "Unknown Shift"];

            // Group attendance by date within the cutoff period
            const attendanceByDate = {}; // { 'YYYY-MM-DD': { total: 0, present: 0, absent: 0, studentsByShift: { 'AM Shift': [], ... } } }

            allStudentsData.forEach(student => {
                if (student.attendance && typeof student.attendance === 'object') {
                    for (const dateString in student.attendance) {
                        const [year, month, day] = dateString.split('-').map(Number);
                        const attendanceDate = new Date(year, month - 1, day);

                        if (attendanceDate >= cutoffStartDate && attendanceDate <= cutoffEndDate) {
                            if (!attendanceByDate[dateString]) {
                                attendanceByDate[dateString] = {
                                    total: 0,
                                    present: 0,
                                    absent: 0,
                                    studentsByShift: {
                                        "AM Shift": [],
                                        "PM Shift": [],
                                        "Night Shift": [],
                                        "Unknown Shift": []
                                    }
                                };
                            }

                            const record = student.attendance[dateString];
                            attendanceByDate[dateString].total++;
                            if (record.present === true) {
                                attendanceByDate[dateString].present++;
                            } else if (record.present === false) {
                                attendanceByDate[dateString].absent++;
                            }

                            const studentShift = record.shift || student.defaultShift || 'Unknown Shift';
                            if (shifts.includes(studentShift)) {
                                attendanceByDate[dateString].studentsByShift[studentShift].push({
                                    name: student.name,
                                    studentId: student.studentId,
                                    type: student.studentType,
                                    status: record.status,
                                    startTime: record.startTime,
                                    endTime: record.endTime, // Include endTime for duration calculation
                                    durationMs: record.durationMs // Keep for reference, but recalculate for display
                                });
                            } else {
                                attendanceByDate[dateString].studentsByShift['Unknown Shift'].push({
                                    name: student.name,
                                    studentId: student.studentId,
                                    type: student.studentType,
                                    status: record.status,
                                    startTime: record.startTime,
                                    endTime: record.endTime, // Include endTime for duration calculation
                                    durationMs: record.durationMs // Keep for reference, but recalculate for display
                                });
                            }
                        }
                    }
                }
            });

            const sortedDates = Object.keys(attendanceByDate).sort((a, b) => new Date(a) - new Date(b));

            if (sortedDates.length === 0) {
                noOverviewDataMessage.classList.remove('hidden');
                return;
            } else {
                noOverviewDataMessage.classList.add('hidden');
            }

            sortedDates.forEach(dateString => {
                const data = attendanceByDate[dateString];
                const displayDate = formatDateToDisplay(new Date(dateString));

                const dateBox = document.createElement('div');
                dateBox.classList.add('date-summary-box');

                dateBox.innerHTML = `
                    <div class="date-summary-header" data-date="${dateString}">
                        <span class="date-text">DATE: ${displayDate}</span>
                        <span class="material-icons">expand_more</span>
                    </div>
                    <div class="date-summary-details">
                        <span>TOTAL STUDENTS: <strong>${data.total}</strong></span>
                        <span>PRESENT: <strong class="text-green-600">${data.present}</strong></span>
                        <span>ABSENT: <strong class="text-red-600">${data.absent}</strong></span>
                    </div>
                    <div class="shift-breakdown" id="shiftBreakdown-${dateString}">
                        <!-- Shift details will be inserted here -->
                    </div>
                `;
                dateSummaryGrid.appendChild(dateBox);

                const shiftBreakdownDiv = dateBox.querySelector(`#shiftBreakdown-${dateString}`);
                shifts.forEach(shiftName => {
                    const studentsInShift = data.studentsByShift[shiftName];
                    if (studentsInShift && studentsInShift.length > 0) {
                        const shiftSummaryDiv = document.createElement('div');
                        shiftSummaryDiv.classList.add('shift-summary');
                        shiftSummaryDiv.innerHTML = `
                            <h4>${shiftName} (${studentsInShift.length} Students)</h4>
                            <ul>
                                ${studentsInShift.map(s => {
                                    let displayStatus = s.status;
                                    let displayStatusClass = '';
                                    let durationDisplay = '';
                                    
                                    const scheduledDurationMs = s.type === 'Regular' ? REGULAR_DURATION_MINS : TRIAL_DURATION_MINS;

                                    if (s.status === 'Absent') {
                                        displayStatus = 'Absent'; // Explicitly set to Absent
                                        displayStatusClass = 'text-red-600';
                                        durationDisplay = ` | Total: ${formatDurationVerbose(scheduledDurationMs)}`; // Default duration for absent
                                    } else if (s.endTime !== null) {
                                        // Lesson was completed
                                        const actualDurationMs = s.endTime - s.startTime;
                                        if (s.status === 'Overtime') {
                                            displayStatus = 'Complete'; // Display Overtime as Complete
                                            displayStatusClass = 'text-green-600'; // Green for complete
                                            durationDisplay = ` - End: ${formatTimestampTo12Hour(s.endTime)} | Total: ${formatDurationVerbose(actualDurationMs)} (Scheduled: ${formatDurationVerbose(scheduledDurationMs)})`;
                                        } else if (s.status === 'Undertime') {
                                            displayStatus = 'Undertime'; // Keep Undertime
                                            displayStatusClass = 'text-orange-500';
                                            durationDisplay = ` - End: ${formatTimestampTo12Hour(s.endTime)} | Total: ${formatDurationVerbose(actualDurationMs)} (Scheduled: ${formatDurationVerbose(scheduledDurationMs)})`;
                                        } else { // Complete
                                            displayStatus = 'Complete'; // Explicitly set to Complete
                                            displayStatusClass = 'text-green-600';
                                            // If actual duration is exactly scheduled duration, don't show "Scheduled" part
                                            if (actualDurationMs === scheduledDurationMs) {
                                                durationDisplay = ` - End: ${formatTimestampTo12Hour(s.endTime)} | Total: ${formatDurationVerbose(actualDurationMs)}`;
                                            } else {
                                                durationDisplay = ` - End: ${formatTimestampTo12Hour(s.endTime)} | Total: ${formatDurationVerbose(actualDurationMs)} (Scheduled: ${formatDurationVerbose(scheduledDurationMs)})`;
                                            }
                                        }
                                    } else {
                                        // Lesson was never officially ended (endTime is null)
                                        const recordDate = new Date(dateString);
                                        const today = new Date();
                                        today.setHours(0,0,0,0); // Normalize today's date

                                        if (recordDate.toDateString() === today.toDateString() && s.startTime <= Date.now()) {
                                            // It's today and lesson started: show current running time
                                            displayStatus = s.status; // Keep Active/Scheduled/Overtime etc.
                                            if (displayStatus === 'Active') {
                                                displayStatusClass = 'text-green-600';
                                            } else if (displayStatus === 'Scheduled') {
                                                displayStatusClass = 'text-blue-600';
                                            } else if (displayStatus === 'Overtime') {
                                                displayStatusClass = 'text-red-600';
                                            } else if (displayStatus === 'Undertime') {
                                                displayStatusClass = 'text-orange-500';
                                            }
                                        } else {
                                            // It's a past date and lesson was never ended, or a future scheduled lesson
                                            displayStatus = 'Unfinished'; // Or 'Incomplete'
                                            displayStatusClass = 'text-gray-500 status-unfinished'; // Muted color for unfinished past lessons
                                        }
                                    }
                                    // Handle Rest Day status in overview
                                    if (s.status === 'Rest Day') {
                                        displayStatus = 'Rest Day';
                                        displayStatusClass = 'status-rest-day';
                                        durationDisplay = ` | Total: ${formatDurationVerbose(scheduledDurationMs)}`; // Default duration for rest day
                                    }

                                    return `
                                        <li>${s.name} (${s.studentId || ''}) - Status: <span class="font-semibold ${displayStatusClass}">${displayStatus}</span>
                                            ${s.startTime ? ` - Start: ${formatTimestampTo12Hour(s.startTime)}` : ''} ${durationDisplay}
                                        </li>
                                    `;
                                }).join('')}
                            </ul>
                        `;
                        shiftBreakdownDiv.appendChild(shiftSummaryDiv);
                    }
                });

                // Add toggle functionality
                const header = dateBox.querySelector('.date-summary-header');
                header.addEventListener('click', () => {
                    header.classList.toggle('expanded');
                    shiftBreakdownDiv.classList.toggle('open');
                });
            });
        }


        // Initial setup on window load
        window.onload = () => {
            // Set initial selected daily date to today
            selectedDailyDate = new Date();
            currentDateInput.value = formatDateToYYYYMMDD(selectedDailyDate);
            displaySelectedDate.textContent = formatDateToDisplay(selectedDailyDate);

            // Initialize running time display elements
            runningTimeDisplayElement = document.getElementById('runningTimeDisplay');
            statusDisplayElement = document.getElementById('statusDisplay');
            activeStudentNameElement = document.getElementById('activeStudentName');
            activeStudentIdElement = document.getElementById('activeStudentId');
            activeStudentTypeElement = document.getElementById('activeStudentType');
            activeStudentStartTimeElement = document.getElementById('activeStudentStartTime');
            userShiftStatusDisplayElement = document.getElementById('userShiftStatusDisplay'); // NEW: Initialize user shift status element
            standbyStudentsDisplayElement = document.getElementById('standbyStudentsDisplay'); // NEW: Initialize standby students element


            const today = new Date();
            // Populate month and year selectors and set initial selected values
            populateMonthYearSelectors(monthSelect, yearSelect, today.getMonth(), today.getFullYear());
            populateMonthYearSelectors(allStudentsMonthSelect, allStudentsYearSelect, today.getMonth(), today.getFullYear());

            // Initialize current view month and year based on today's date
            currentViewMonthIndex = today.getMonth();
            currentViewYear = today.getFullYear();

            // Auto-set cut-off period based on current date
            const currentDayOfMonth = today.getDate();
            const daysInCurrentMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            if (currentDayOfMonth >= Math.floor(daysInCurrentMonth / 2) + 1) { // If today is in the second half
                cutOffPeriodSelect.value = 'Second Half';
            } else {
                cutOffPeriodSelect.value = 'First Half';
            }

            // Initialize allStudents page default view settings
            allStudentsViewMonthIndex = today.getMonth();
            allStudentsViewYear = today.getFullYear();
            allStudentsCutOffType = allStudentsCutOffPeriodSelect.value; // Use the auto-selected value

            initializeFirebase(); // Initialize Firebase, which will trigger loadSchedules() and listenForStudents()

            // Start updating clocks every second
            updateDigitalClocks();
            setInterval(updateDigitalClocks, 1000);
        };

    </script>
</body>
</html>
