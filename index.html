<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFAL Attendance</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Montserrat Font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif; /* Changed font to Montserrat */
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #333;
        }
        /* Custom table styling for better appearance */
        .attendance-table th, .attendance-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0; /* Light gray border */
            text-align: center; /* Ensures all cell content is centered */
        }
        .attendance-table th {
            background-color: #edf2f7; /* Lighter gray for header */
            font-weight: 600;
            color: #4a5568;
            position: sticky; /* Make header sticky for vertical scrolling */
            top: 0;
            z-index: 20; /* Ensure header is above content */
        }
        .attendance-table tbody tr:hover {
            background-color: #f7fafc; /* Very light gray on hover */
        }
        .rest-day {
            background-color: #ffebeb; /* Light red for rest days */
            color: #c53030;
            font-weight: 600;
        }
        .rest-day-cell {
            background-color: #f7f7f7; /* Lighter background for non-interactive rest day cells */
            color: #a0aec0; /* Greyer text */
            pointer-events: none; /* Disable interaction */
        }

        /* Sticky Date Column Styles */
        .sticky-column {
            position: sticky;
            left: 0;
            background-color: #ffffff; /* White background for sticky column cells */
            z-index: 15; /* Ensure sticky column is above other cells but below sticky header */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); /* Subtle shadow for separation */
        }
        .sticky-column-header {
            position: sticky;
            left: 0;
            background-color: #edf2f7; /* Header background for sticky column */
            z-index: 25; /* Ensure sticky header is on top */
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); /* Subtle shadow for separation */
        }
        /* Hide pages by default */
        .page-content {
            display: none;
        }
        /* Show active page */
        .page-content.active {
            display: block;
        }
        .delete-time-slot-btn {
            background: none;
            border: none;
            color: #ef4444; /* Red color for delete */
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 5px;
            padding: 0;
            line-height: 1;
        }
        .delete-time-slot-btn:hover {
            color: #dc2626;
        }
        /* Styling for the clickable status cells */
        .status-cell-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            min-width: 60px; /* Ensure some minimum width for visibility */
            min-height: 38px; /* Ensure consistent height with other cells */
            cursor: pointer;
            border: 1px solid transparent; /* To prevent layout shift on hover/focus */
            border-radius: 0.25rem; /* rounded-md */
            transition: background-color 0.1s ease-in-out, color 0.1s ease-in-out;
        }
        .status-cell-content:hover {
            border-color: #a0aec0; /* gray-400 */
        }
        .status-cell-content:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5); /* blue-500 with opacity */
        }
        /* New styles for Lessons tab highlighting */
        .current-date-row {
            background-color: #e0f2fe !important; /* Lighter blue, more prominent */
            border-left: 8px solid #2563eb !important; /* Stronger blue border */
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3) !important; /* Added subtle glow */
            transition: all 0.3s ease-in-out;
        }
        .current-time-slot {
            background-color: #fff7ed !important; /* Light orange, more prominent */
            border: 4px solid #f97316 !important; /* Stronger orange border */
            font-weight: bold !important;
            box-shadow: 0 0 12px rgba(249, 115, 22, 0.4) !important; /* Added stronger glow */
            transition: all 0.3s ease-in-out;
        }
        /* Styles for penalty time slot buttons */
        .penalty-time-slot-btn {
            @apply bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm cursor-pointer transition-colors duration-200;
        }
        .penalty-time-slot-btn.selected {
            @apply bg-red-500 text-white;
        }

        /* Styles for the new data display boxes */
        .data-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: #ffffff;
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
            color: #4a5568;
        }
        .data-list-item .delete-icon {
            color: #ef4444; /* red-500 */
            cursor: pointer;
            font-weight: bold;
            margin-left: 1rem;
            font-size: 1.2em;
        }
        .data-list-item .delete-icon:hover {
            color: #dc2626; /* red-600 */
        }
        .penalty-status {
            color: #ef4444; /* red-500 */
            font-weight: 600;
        }
        /* New style for red penalty rate */
        .penalty-rate-red {
            color: #ef4444; /* red-500 */
            font-weight: 600;
        }
        .perfect-attendance-checkmark {
            color: #10b981; /* green-500 */
            font-weight: bold;
            font-size: 1.2em;
        }
        /* Task column specific styles */
        .task-penalty { color: #dc2626; font-weight: 600; } /* red-600 */
        .task-holiday { color: #2563eb; font-weight: 600; } /* blue-600 */
        .task-sick-leave { color: #f97316; font-weight: 600; } /* orange-500 */
        .task-vacation-leave { color: #eab308; font-weight: 600; } /* yellow-500 */
        .task-duty { color: #16a34a; font-weight: 600; } /* green-600 */
        .task-closed { color: #6b7280; font-weight: 600; } /* gray-500 */

        /* Styles for closed lesson cells */
        .closed-lesson-cell {
            background-color: #e5e7eb; /* Light gray */
            color: #6b7280; /* Darker gray text */
            /* Removed pointer-events: none; so it remains clickable */
            font-style: italic;
        }
        /* Quick attendance box styling */
        .quick-attendance-box {
            border: 2px dashed #a0aec0; /* Gray dashed border */
            background-color: #f8fafc; /* Very light background */
        }
        .quick-attendance-box button {
            @apply px-4 py-2 rounded-md font-semibold transition-colors duration-200;
        }
        .quick-attendance-box button.present {
            @apply bg-green-500 hover:bg-green-600 text-white;
        }
        .quick-attendance-box button.missed {
            @apply bg-red-500 hover:bg-red-600 text-white;
        }
        .quick-attendance-box button.closed {
            @apply bg-gray-500 hover:bg-gray-600 text-white;
        }
        .quick-attendance-box button:disabled {
            @apply opacity-50 cursor-not-allowed;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header Section -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-700 text-white p-6 shadow-lg rounded-b-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-4xl font-bold">IFAL Attendance</h1>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="#overview" class="nav-link hover:text-blue-200 transition duration-300 active" data-page="overview">Overview</a></li>
                    <li><a href="#lessons" class="nav-link hover:text-blue-200 transition duration-300" data-page="lessons">Lessons</a></li>
                    <li><a href="#input-data" class="nav-link hover:text-blue-200 transition duration-300" data-page="input-data">Input Data</a></li>
                    <li><a href="#list-of-date-of-year" class="nav-link hover:text-blue-200 transition duration-300" data-page="list-of-date-of-year">List of date of year</a></li>
                </ul>
            </nav>
        </div>
        <!-- User ID Display and Clocks -->
        <div class="container mx-auto flex justify-between items-center text-sm mt-2">
            <div class="flex flex-col sm:flex-row sm:space-x-4">
                <div class="flex items-center">
                    <span class="font-semibold mr-1">PH Time:</span>
                    <span id="ph-clock" class="font-mono text-lg">Loading...</span>
                </div>
                <div class="flex items-center mt-1 sm:mt-0">
                    <span class="font-semibold mr-1">IL Time:</span>
                    <span id="il-clock" class="font-mono text-lg">Loading...</span>
                </div>
            </div>
            <div>
                User ID: <span id="user-id" class="font-semibold">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Main Content Section -->
    <main class="container mx-auto p-8 flex-grow">
        <!-- Overview Page Content -->
        <section id="overview" class="page-content bg-white p-8 rounded-lg shadow-md mb-8 active">
            <h2 class="text-3xl font-semibold text-gray-800 mb-4">Welcome to Our Site!</h2>
            <p class="text-gray-700 leading-relaxed">
                This is a simple, responsive website built with HTML and styled using Tailwind CSS.
                It's designed to look great on all devices, from mobile phones to large desktop screens.
                You can easily customize this content to fit your needs.
            </p>
            <p class="text-gray-700 leading-relaxed mt-4">
                Explore the navigation links above to see different sections, or simply enjoy the clean and modern design.
                We're excited to have you here!
            </p>
            <button class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Learn More
            </button>

            <!-- Upcoming Events Box -->
            <section class="bg-blue-50 p-6 rounded-lg shadow-md mt-8">
                <h3 class="text-2xl font-semibold text-blue-800 mb-4">Upcoming Holidays & Leaves</h3>
                <div id="upcoming-events-list" class="flex flex-col gap-3">
                    <p class="text-gray-600">No upcoming events found.</p>
                </div>
            </section>

            <!-- Original Attendance Tracking Section for Overview -->
            <section class="bg-white p-8 rounded-lg shadow-md mt-8">
                <h2 class="text-3xl font-semibold text-gray-800 mb-6">Attendance Tracking (Overview)</h2>

                <!-- Date Selection Controls and Rest Day Selector -->
                <div class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <div class="flex flex-col">
                        <label for="month-select-overview" class="text-sm font-medium text-gray-700 mb-1">Month</label>
                        <select id="month-select-overview" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <!-- Options populated by JavaScript -->
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="year-select-overview" class="text-sm font-medium text-gray-700 mb-1">Year</label>
                        <select id="year-select-overview" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <!-- Options populated by JavaScript -->
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="cutoff-select-overview" class="text-sm font-medium text-gray-700 mb-1">Cutoff</label>
                        <select id="cutoff-select-overview" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="1-15">1 - 15</option>
                            <option value="16-end">16 - End of Month</option>
                        </select>
                    </div>

                    <!-- Rest Day Selection Checkboxes -->
                    <div class="flex flex-col flex-grow md:flex-grow-0">
                        <label class="text-sm font-medium text-gray-700 mb-1">Rest Days</label>
                        <div id="rest-day-checkboxes-overview" class="flex flex-wrap gap-2">
                            <!-- Checkboxes will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-lg border border-gray-200 mx-auto">
                    <table class="min-w-full divide-y divide-gray-200 attendance-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap sticky-column-header">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap w-64">Task</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Progress Indicator</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">AM Shift</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">PM Shift</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">GY Shift</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">AM RATE</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">PM RATE</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">GY RATE</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Total</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Total Earn</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Holiday</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Holiday %</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Holiday Rate</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Perfect Attendance</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Subscription</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Subscription Rate</th> <!-- New Column -->
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Session Report</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Penalty</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Percentage</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Penalty Rate</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">TOTAL DAILY RATE</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body-overview" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </section>

        <!-- Lessons Page Content (now contains its own Attendance Tracking with fewer columns) -->
        <section id="lessons" class="page-content bg-white p-8 rounded-lg shadow-md mb-8">
            <h2 class="text-3xl font-semibold text-gray-800 mb-6">Attendance Tracking (Lessons)</h2>

            <!-- Date Selection Controls and Rest Day Selector -->
            <div class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="flex flex-col">
                    <label for="month-select-lessons" class="text-sm font-medium text-gray-700 mb-1">Month</label>
                    <select id="month-select-lessons" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="year-select-lessons" class="text-sm font-medium text-gray-700 mb-1">Year</label>
                    <select id="year-select-lessons" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="cutoff-select-lessons" class="text-sm font-medium text-gray-700 mb-1">Cutoff</label>
                    <select id="cutoff-select-lessons" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="1-15">1 - 15</option>
                        <option value="16-end">16 - End of Month</option>
                    </select>
                </div>

                <!-- Rest Day Selection Checkboxes -->
                <div class="flex flex-col flex-grow md:flex-grow-0">
                    <label class="text-sm font-medium text-gray-700 mb-1">Rest Days</label>
                    <div id="rest-day-checkboxes-lessons" class="flex flex-wrap gap-2">
                        <!-- Checkboxes will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Rate Input Fields for Lessons Tab -->
            <div class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="flex flex-col">
                    <label for="am-rate-input" class="text-sm font-medium text-gray-700 mb-1">AM Rate (PHP)</label>
                    <input type="number" id="am-rate-input" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-24 text-right" value="0" step="0.01" min="0">
                </div>
                <div class="flex flex-col">
                    <label for="pm-rate-input" class="text-sm font-medium text-gray-700 mb-1">PM Rate (PHP)</label>
                    <input type="number" id="pm-rate-input" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-24 text-right" value="0" step="0.01" min="0">
                </div>
                <div class="flex flex-col">
                    <label for="gy-rate-input" class="text-sm font-medium text-gray-700 mb-1">GY Rate (PHP)</label>
                    <input type="number" id="gy-rate-input" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-24 text-right" value="0" step="0.01" min="0">
                </div>
            </div>

            <!-- Time Slot Management for Lessons Tab -->
            <div class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="flex flex-col">
                    <label for="hour-select" class="text-sm font-medium text-gray-700 mb-1">Hour</label>
                    <select id="hour-select" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options 1-12 populated by JS -->
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="minute-select" class="text-sm font-medium text-gray-700 mb-1">Minute</label>
                    <select id="minute-select" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="00">00</option>
                        <option value="30">30</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="ampm-select" class="text-sm font-medium text-gray-700 mb-1">AM/PM</label>
                    <select id="ampm-select" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="AM">AM</option>
                        <option value="PM">PM</option>
                    </select>
                </div>
                <button id="add-time-slot-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Add Slot
                </button>
                <button id="delete-time-slot-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    Delete Slot
                </button>
            </div>

            <!-- Quick Attendance Box -->
            <div class="flex flex-wrap items-center gap-4 mb-6 p-4 bg-white rounded-lg shadow-md quick-attendance-box">
                <span class="text-lg font-semibold text-gray-700">Current Time Slot:</span>
                <span id="current-active-slot-display" class="text-2xl font-bold text-blue-700 mr-4">--:-- --</span>
                <button id="quick-present-btn" class="present">Present</button>
                <button id="quick-missed-btn" class="missed">Missed</button>
                <button id="quick-closed-btn" class="closed">Closed</button>
            </div>

            <!-- Total Earned for Cutoff Box and Perfect Attendance Bonus Box -->
            <div class="flex flex-col md:flex-row gap-4 mt-6 mb-6">
                <div class="bg-blue-100 p-4 rounded-lg shadow-md flex-1">
                    <h3 class="text-xl font-semibold text-blue-800">Total Earned for Cutoff:</h3>
                    <p id="lessons-total-salary" class="text-3xl font-bold text-blue-700 mt-2">PHP 0.00</p>
                </div>
                <div id="perfect-attendance-bonus-box" class="bg-green-100 p-4 rounded-lg shadow-md flex-1 hidden">
                    <h3 class="text-xl font-semibold text-green-800">Perfect Attendance Bonus!</h3>
                    <p class="text-3xl font-bold text-green-700 mt-2">You are entitled to a Perfect attendance of 250 pesos!</p>
                </div>
            </div>

            <!-- Loading Indicator for Lessons Table -->
            <div id="loading-indicator" class="hidden text-center py-4 text-blue-600 font-semibold">
                Loading attendance data...
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200 mx-auto">
                <table class="min-w-full divide-y divide-gray-200 attendance-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap sticky-column-header">Date</th>
                            <!-- Time Columns for Lessons Tab - Dynamically generated by JS -->
                            <!-- These will be dynamically added by JavaScript -->
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">AM Shift</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">PM Shift</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">GY Shift</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">AM RATE</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">PM RATE</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">GY RATE</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Total</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Total Earn</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Session Report</th>
                            <!-- Removed Actions column header -->
                        </tr>
                    </thead>
                    <tbody id="attendance-table-body-lessons" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be dynamically generated here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Input Data Page Content -->
        <section id="input-data" class="page-content bg-white p-8 rounded-lg shadow-md mb-8">
            <h2 class="text-3xl font-semibold text-gray-800 mb-4">Input Data</h2>
            <p class="text-gray-700 leading-relaxed">
                Use this section to input various data.
                You can add forms, data entry fields, or upload functionalities here.
            </p>

            <div class="flex flex-col gap-4 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                <label for="data-category-select" class="text-sm font-medium text-gray-700">Select Category:</label>
                <select id="data-category-select" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <option value="">-- Select --</option>
                    <option value="holiday">Holiday</option>
                    <option value="leave">Leave</option>
                    <option value="penalty">Penalty</option>
                    <option value="subscriber">Subscriber</option>
                </select>
            </div>

            <!-- Holiday Form -->
            <div id="holiday-form" class="data-input-form hidden bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Holiday Details</h3>
                <form id="holiday-data-form" class="space-y-4">
                    <div>
                        <label for="holiday-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="holiday-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="holiday-name" class="block text-sm font-medium text-gray-700">Name of the Holiday</label>
                        <input type="text" id="holiday-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="holiday-rate" class="block text-sm font-medium text-gray-700">Holiday Rate (%)</label>
                        <input type="number" id="holiday-rate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" min="0" max="100" step="0.01" value="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Which Lesson (Check to select/deselect)</label>
                        <div id="holiday-lesson-slots" class="flex flex-col gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                            <!-- Checkboxes for time slots will be dynamically populated here -->
                            <p class="text-gray-500">No time slots available. Please add in Lessons tab.</p>
                        </div>
                    </div>
                    <div>
                        <label for="holiday-total" class="block text-sm font-medium text-gray-700">Total Holiday Amount (PHP)</label>
                        <input type="text" id="holiday-total" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly value="0.00">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Submit Holiday
                    </button>
                </form>
                <!-- Holiday List Box -->
                <div id="holiday-list-box" class="bg-blue-50 p-4 rounded-lg shadow-inner mt-6">
                    <h4 class="text-xl font-semibold text-blue-800 mb-3">Plotted Holidays</h4>
                    <div id="holiday-list-container" class="flex flex-col gap-2">
                        <p class="text-gray-500">No holidays recorded yet.</p>
                    </div>
                </div>
            </div>

            <!-- Leave Form -->
            <div id="leave-form" class="data-input-form hidden bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Leave Details</h3>
                <form id="leave-data-form" class="space-y-4">
                    <div>
                        <label for="leave-date" class="block text-sm font-medium text-gray-700">Date of Leave</label>
                        <input type="date" id="leave-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="leave-type" class="block text-sm font-medium text-gray-700">Type of Leave</label>
                        <select id="leave-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Select --</option>
                            <option value="vacation">Vacation Leave</option>
                            <option value="sick">Sick Leave</option>
                        </select>
                    </div>

                    <div id="vacation-leave-questions" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Is it within 7 Days?</label>
                        <div class="flex items-center space-x-4">
                            <input type="radio" id="vacation-7-days-yes" name="vacation-7-days" value="yes" class="form-radio h-4 w-4 text-blue-600">
                            <label for="vacation-7-days-yes" class="text-gray-700">Yes (PENALTY)</label>
                            <input type="radio" id="vacation-7-days-no" name="vacation-7-days" value="no" class="form-radio h-4 w-4 text-blue-600">
                            <label for="vacation-7-days-no" class="text-gray-700">No (EXCUSED)</label>
                        </div>
                    </div>

                    <div id="sick-leave-questions" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Have you submitted Medical Certificate?</label>
                        <div class="flex items-center space-x-4">
                            <input type="radio" id="sick-leave-medcert-yes" name="sick-leave-medcert" value="yes" class="form-radio h-4 w-4 text-blue-600">
                            <label for="sick-leave-medcert-yes" class="text-gray-700">Yes (EXCUSED)</label>
                            <input type="radio" id="sick-leave-medcert-no" name="sick-leave-medcert" value="no" class="form-radio h-4 w-4 text-blue-600">
                            <label for="sick-leave-medcert-no" class="text-gray-700">No (PENALTY)</label>
                        </div>
                    </div>

                    <div id="leave-penalty-details" class="hidden space-y-4 p-4 bg-red-50 rounded-lg border border-red-200">
                        <h4 class="text-lg font-semibold text-red-800">Leave Penalty Details</h4>
                        <div>
                            <label for="leave-penalty-percentage" class="block text-sm font-medium text-gray-700">Leave Penalty Percentage (%)</label>
                            <input type="number" id="leave-penalty-percentage" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="0" min="0" max="100" step="0.01">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Which Lesson (Check to select/deselect)</label>
                            <div id="leave-lesson-slots" class="flex flex-col gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                                <!-- Checkboxes for time slots will be dynamically populated here -->
                                <p class="text-gray-500">No time slots available. Please add in Lessons tab.</p>
                            </div>
                        </div>
                        <div>
                            <label for="leave-total-penalty" class="block text-sm font-medium text-gray-700">Total Leave Penalty (PHP)</label>
                            <input type="text" id="leave-total-penalty" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly value="0.00">
                        </div>
                    </div>

                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Submit Leave
                    </button>
                </form>
                <!-- Leave List Box -->
                <div id="leave-list-box" class="bg-blue-50 p-4 rounded-lg shadow-inner mt-6">
                    <h4 class="text-xl font-semibold text-blue-800 mb-3">Filed Leaves</h4>
                    <div id="leave-list-container" class="flex flex-col gap-2">
                        <p class="text-gray-500">No leaves recorded yet.</p>
                    </div>
                </div>
            </div>

            <!-- Penalty Form -->
            <div id="penalty-form" class="data-input-form hidden bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Penalty Details</h3>
                <form id="penalty-data-form" class="space-y-4">
                    <div>
                        <label for="penalty-date" class="block text-sm font-medium text-gray-700">Date of Penalty</label>
                        <input type="date" id="penalty-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="penalty-type" class="block text-sm font-medium text-gray-700">Type of Penalty</label>
                        <select id="penalty-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Select --</option>
                            <option value="skipped">Skipped</option>
                            <option value="canceled">Canceled</option>
                        </select>
                    </div>
                    <div>
                        <label for="penalty-percentage" class="block text-sm font-medium text-gray-700">Penalty Percentage (%)</label>
                        <input type="number" id="penalty-percentage" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" value="0" min="0" step="0.01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Which Lesson (Check to select/deselect)</label>
                        <div id="penalty-lesson-slots" class="flex flex-col gap-2 p-2 border border-gray-300 rounded-md bg-gray-50">
                            <!-- Checkboxes for time slots will be dynamically populated here -->
                            <p class="text-gray-500">No time slots available. Please add in Lessons tab.</p>
                        </div>
                    </div>
                    <div>
                        <label for="penalty-total" class="block text-sm font-medium text-gray-700">Total Penalty (PHP)</label>
                        <input type="text" id="penalty-total" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly value="0.00">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Submit Penalty
                    </button>
                </form>
                <!-- Penalty List Box -->
                <div id="penalty-list-box" class="bg-blue-50 p-4 rounded-lg shadow-inner mt-6">
                    <h4 class="text-xl font-semibold text-blue-800 mb-3">Recorded Penalties</h4>
                    <div id="penalty-list-container" class="flex flex-col gap-2">
                        <p class="text-gray-500">No penalties recorded yet.</p>
                    </div>
                </div>
            </div>

            <!-- Subscriber Form -->
            <div id="subscriber-form" class="data-input-form hidden bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Subscriber Details</h3>
                <form id="subscriber-data-form" class="space-y-4">
                    <div>
                        <label for="subscriber-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="subscriber-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="free-trial-lessons" class="block text-sm font-medium text-gray-700">How many free trial lessons were subscribed?</label>
                        <input type="number" id="free-trial-lessons" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" min="0">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Submit Subscriber Data
                    </button>
                </form>
                <!-- Subscriber List Box -->
                <div id="subscriber-list-box" class="bg-blue-50 p-4 rounded-lg shadow-inner mt-6">
                    <h4 class="text-xl font-semibold text-blue-800 mb-3">Recorded Subscriptions</h4>
                    <div id="subscriber-list-container" class="flex flex-col gap-2">
                        <p class="text-gray-500">No subscriptions recorded yet.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="list-of-date-of-year" class="page-content bg-white p-8 rounded-lg shadow-md mb-8">
            <h2 class="text-3xl font-semibold text-gray-800 mb-4">List of Dates of the Year</h2>
            <p class="text-gray-700 leading-relaxed">
                This section displays a comprehensive list of all dates for the selected year,
                along with attendance and calculated data.
            </p>

            <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="flex flex-col">
                    <label for="year-select-list" class="text-sm font-medium text-gray-700 mb-1">Select Year:</label>
                    <select id="year-select-list" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="month-select-list" class="text-sm font-medium text-gray-700 mb-1">Select Month:</label>
                    <select id="month-select-list" class="p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- All Months --</option>
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-200 mx-auto">
                <table id="all-dates-table" class="min-w-full divide-y divide-gray-200 attendance-table">
                    <thead>
                        <!-- Table headers will be dynamically generated here by JavaScript -->
                    </thead>
                    <tbody id="all-dates-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Table rows will be dynamically generated here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Feature Card 1 -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Responsive Design</h3>
                <p class="text-gray-700">
                    Our website adapts seamlessly to any screen size, providing an optimal viewing experience on desktops, tablets, and mobile devices.
                </p>
            </div>

            <!-- Feature Card 2 -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Easy Customization</h3>
                <p class="text-gray-700">
                    With Tailwind CSS, modifying styles and layouts is straightforward, allowing for quick and efficient updates.
                </p>
            </div>

            <!-- Feature Card 3 -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-semibold text-gray-800 mb-3">Modern Aesthetics</h3>
                <p class="text-gray-700">
                    Enjoy a clean, modern, and visually appealing design that enhances user engagement and readability.
                </p>
            </div>
        </section>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-white p-6 mt-8 rounded-t-lg">
        <div class="container mx-auto text-center">
            <p>&copy; 2025 IFAL Attendance. All rights reserved.</p>
            <div class="flex justify-center space-x-4 mt-2">
                <a href="#" class="hover:text-blue-400 transition duration-300">Privacy Policy</a>
                <a href="#" class="hover:text-blue-400 transition duration-300">Terms of Service</a>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDoc, addDoc, deleteDoc, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'loading'; // Default until authenticated
        let isAuthReady = false;
        let restDaysArray = []; // Stores the selected rest days (e.g., ['Friday', 'Saturday'])
        // Initial default time slots for Lessons tab
        let lessonsTimeSlotsArray = [
            '8:00 PM', '8:30 PM', '9:00 PM', '9:30 PM',
            '12:00 AM', '12:30 AM', '1:00 AM', '1:30 AM',
            '2:00 AM', '2:30 AM', '3:00 AM', '3:30 AM', '4:00 AM'
        ];

        // Global variable for shift rates
        let shiftRates = { am: 0, pm: 0, gy: 0 };
        // Global cache for holiday data
        let holidaysCache = {}; // Stores holidays by date: { 'YYYY-MM-DD': { id: 'docId', date: '...', name: '...', percentage: ..., selectedLessons: [], totalAmount: ... } }
        let penaltiesCache = {}; // Stores penalties by date: { 'YYYY-MM-DD': { id: 'docId', date: '...', type: '...', percentage: ..., selectedLessons: [], totalAmount: ... } }
        let leavesCache = {}; // Stores leaves by date: { 'YYYY-MM-DD': { id: 'docId', date: '...', type: '...', status: '...', selectedLessons: [], totalAmount: ..., percentage: ... } }
        let subscribersCache = {}; // Stores subscribers by date: { 'YYYY-MM-DD': { id: 'docId', date: '...', freeTrialLessons: ... } }

        // Define table configurations globally (declared once)
        const overviewTableConfig = {
            monthSelectId: 'month-select-overview',
            yearSelectId: 'year-select-overview',
            cutoffSelectId: 'cutoff-select-overview',
            attendanceTableBodyId: 'attendance-table-body-overview',
            restDayCheckboxesDivId: 'rest-day-checkboxes-overview',
            idPrefix: 'overview-',
            columnOrder: [
                'Task', 'Progress Indicator', 'AM Shift', 'PM Shift', 'GY Shift',
                'AM RATE', 'PM RATE', 'GY RATE',
                'Total', 'Total Earn',
                'Holiday', 'Holiday %', 'Holiday Rate', 'Perfect Attendance',
                'Subscription', 'Subscription Rate', 'Session Report', 'Penalty', 'Percentage',
                'Penalty Rate', 'TOTAL DAILY RATE'
            ]
        };

        const lessonsTableConfig = {
            monthSelectId: 'month-select-lessons',
            yearSelectId: 'year-select-lessons',
            cutoffSelectId: 'cutoff-select-lessons',
            attendanceTableBodyId: 'attendance-table-body-lessons',
            restDayCheckboxesDivId: 'rest-day-checkboxes-lessons',
            idPrefix: 'lessons-',
            columnOrder: [] // Column order is dynamically generated
        };


        // Firebase configuration provided by the user (UPDATED)
        const firebaseConfig = {
            apiKey: "AIzaSyARTvVKhALpVXMHf_22WvEbWVtayp_3Hck",
            authDomain: "phifalattendance.firebaseapp.com",
            projectId: "phifalattendance",
            storageBucket: "phifalattendance.firebasestorage.app",
            messagingSenderId: "488050301785",
            appId: "1:488050301785:web:89c1aa1fcb53b72db6ca48",
            measurementId: "G-MJ5BL372TL"
        };

        // Define appId using projectId from firebaseConfig
        const appId = firebaseConfig.projectId;

        // Initialize Firebase directly with the provided config
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in with custom token if available, otherwise anonymously
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken)
                .then(() => {
                    console.log(" Custom token sign-in successful");
                })
                .catch((error) => {
                    console.error(" Custom token sign-in failed:", error);
                    // Fallback to anonymous sign-in if custom token fails
                    signInAnonymously(auth)
                        .then(() => console.log(" Anonymous sign-in successful (fallback)"))
                        .catch((err) => console.error(" Anonymous sign-in failed (fallback):", err));
                });
        } else {
            signInAnonymously(auth)
                .then(() => {
                    console.log(" Anonymous sign-in successful");
                })
                .catch((error) => {
                    console.error(" Anonymous sign-in failed:", error);
                });
        }

        // Function for displaying messages (replaces alert/confirm)
        function displayMessage(message, type = 'info') {
            console.log(`Message (${type}): ${message}`);
            // This is where you would implement a custom modal or toast notification
            // For now, it's logged to the console.
            // NOTE: For production, replace `alert` and `confirm` with custom UI modals.
        }

        // Helper function to get the number of days in a month
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        // Helper function to format date as "DayOfWeek, MonthName Day, Year"
        function formatDate(dateString) {
            // Ensure the Date object is created in UTC to avoid timezone issues for display
            const parts = dateString.split('-');
            const date = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Function to update checkbox states based on restDaysArray (now takes the specific div)
        function updateRestDayCheckboxes(restDayCheckboxesDiv) {
            if (restDayCheckboxesDiv) { // Ensure the div exists before querying
                restDayCheckboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = restDaysArray.includes(checkbox.value);
                });
            }
        }

        // Function to load rest days from Firestore
        async function loadRestDays() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to load rest days.", "warning");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'restDays');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    restDaysArray = docSnap.data().days || ['Saturday', 'Sunday'];
                    displayMessage("Rest days loaded successfully.", "success");
                } else {
                    displayMessage("No custom rest days found. Using default.", "info");
                    restDaysArray = ['Saturday', 'Sunday'];
                    await saveRestDays(); // Save default if none exist
                }
            } catch (error) {
                console.error("Error loading rest days:", error);
                displayMessage("Error loading rest days. Using default.", "error");
                restDaysArray = ['Saturday', 'Sunday'];
            }
            console.log("Current rest days:", restDaysArray);
        }

        // Function to save rest days to Firestore
        async function saveRestDays() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to save rest days.", "warning");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'restDays');
                await setDoc(docRef, { days: restDaysArray }, { merge: true });
                displayMessage("Rest days saved successfully!", "success");
            } catch (error) {
                console.error("Error saving rest days:", error);
                displayMessage("Error saving rest days.", "error");
            }
        }

        // Function to load lessons time slots from Firestore
        async function loadLessonsTimeSlots() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to load lessons time slots.", "warning");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'lessonsTimeSlots');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const loadedTimes = docSnap.data().times || [];
                    if (loadedTimes.length > 0) {
                        lessonsTimeSlotsArray = loadedTimes;
                        displayMessage("Lessons time slots loaded successfully.", "success");
                    } else {
                        // If loaded array is empty, re-populate with default times
                        lessonsTimeSlotsArray = [
                            '8:00 PM', '8:30 PM', '9:00 PM', '9:30 PM',
                            '12:00 AM', '12:30 AM', '1:00 AM', '1:30 AM',
                            '2:00 AM', '2:30 AM', '3:00 AM', '3:30 AM', '4:00 AM'
                        ];
                        await saveLessonsTimeSlots(); // Save these defaults
                        displayMessage("No custom lessons time slots found. Using default.", "info");
                    }
                } else {
                    displayMessage("No custom lessons time slots found. Using default.", "info");
                    // Use the default array already defined at the top of the script
                    await saveLessonsTimeSlots(); // Save these defaults
                }
            } catch (error) {
                console.error("Error loading lessons time slots:", error);
                displayMessage("Error loading lessons time slots. Using default.", "error");
                // Fallback to default array if error occurs
                lessonsTimeSlotsArray = [
                    '8:00 PM', '8:30 PM', '9:00 PM', '9:30 PM',
                    '12:00 AM', '12:30 AM', '1:00 AM', '1:30 AM',
                    '2:00 AM', '2:30 AM', '3:00 AM', '3:30 AM', '4:00 AM'
                ];
            }
            console.log("Current lessons time slots:", lessonsTimeSlotsArray);
        }

        // Function to save lessons time slots to Firestore
        async function saveLessonsTimeSlots() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to save lessons time slots.", "warning");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'lessonsTimeSlots');
                await setDoc(docRef, { times: lessonsTimeSlotsArray }, { merge: true });
                displayMessage("Lessons time slots saved successfully!", "success");
            }
            catch (error) {
                console.error("Error saving lessons time slots:", error);
                displayMessage("Error saving lessons time slots.", "error");
            }
        }

        // Function to load shift rates from Firestore
        async function loadShiftRates() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to load shift rates.", "warning");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'shiftRates');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const loadedRates = docSnap.data();
                    shiftRates.am = loadedRates.am || 0;
                    shiftRates.pm = loadedRates.pm || 0;
                    shiftRates.gy = loadedRates.gy || 0;
                    displayMessage("Shift rates loaded successfully.", "success");
                } else {
                    displayMessage("No custom shift rates found. Using default.", "info");
                    shiftRates = { am: 0, pm: 0, gy: 0 }; // Ensure defaults are set
                    await saveShiftRates(); // Save default if none exist
                }
                // Populate input fields with loaded rates
                document.getElementById('am-rate-input').value = shiftRates.am;
                document.getElementById('pm-rate-input').value = shiftRates.pm;
                document.getElementById('gy-rate-input').value = shiftRates.gy;

            } catch (error) {
                console.error("Error loading shift rates:", error);
                displayMessage("Error loading shift rates. Using default.", "error");
                shiftRates = { am: 0, pm: 0, gy: 0 }; // Ensure defaults are set on error
            }
            console.log("Current shift rates:", shiftRates);
        }

        // Function to save shift rates to Firestore
        async function saveShiftRates() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to save shift rates.", "warning");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'shiftRates');
                await setDoc(docRef, shiftRates, { merge: true });
                displayMessage("Shift rates saved successfully!", "success");
            } catch (error) {
                console.error("Error saving shift rates:", error);
                displayMessage("Error saving shift rates.", "error");
            }
        }


        // Helper to convert HH:MM AM/PM to 24-hour for sorting
        function convertTo24Hour(timeStr) {
            const [time, period] = timeStr.split(' ');
            let [hours, minutes] = time.split(':').map(Number);

            if (period && period.toLowerCase() === 'pm' && hours !== 12) {
                hours += 12;
            } else if (period && period.toLowerCase() === 'am' && hours === 12) {
                hours = 0; // 12 AM is 0 hours
            }
            return hours * 60 + minutes; // Convert to minutes for easy comparison
        }

        // Global cache for attendance data
        let attendanceDataCache = {};

        // Load attendance data for a specific date
        // This function is now primarily for initial load or when a single date's data is needed.
        // For batch loading, use fetchAllAttendanceDataForCutoff.
        async function loadAttendanceDataForDate(dateString) {
            if (!isAuthReady || !userId) {
                console.warn("Authentication not ready to load attendance data.");
                return {};
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/dailyAttendance`, dateString);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    attendanceDataCache[dateString] = docSnap.data().data || {};
                    return attendanceDataCache[dateString];
                }
            } catch (error) {
                console.error(`Error loading attendance data for ${dateString}:`, error);
            }
            return {}; // Return empty object if no data or error
        }

        // New function to fetch all attendance data for a given cutoff range
        async function fetchAllAttendanceDataForCutoff(startDate, endDate) {
            if (!isAuthReady || !userId) {
                console.warn("Authentication not ready to fetch all attendance data.");
                return;
            }
            // Validate dates before using them
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error("Invalid startDate or endDate provided to fetchAllAttendanceDataForCutoff:", startDate, endDate);
                displayMessage("Error: Invalid date range for attendance data. Please check your month/year/cutoff selection.", "error");
                return;
            }

            try {
                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/dailyAttendance`);
                // Firestore queries are inclusive for start and end bounds
                const q = query(collectionRef,
                    where('__name__', '>=', startDate.toISOString().split('T')[0]),
                    where('__name__', '<=', endDate.toISOString().split('T')[0])
                );
                const querySnapshot = await getDocs(q); // Use getDocs here
                querySnapshot.forEach((docSnap) => {
                    attendanceDataCache[docSnap.id] = docSnap.data().data || {};
                });
                console.log("All attendance data for cutoff loaded into cache.");
            } catch (error) {
                console.error("Error fetching all attendance data for cutoff:", error);
                displayMessage("Error loading attendance data for the selected period.", "error");
            }
        }

        // New function to fetch all holidays for a given cutoff range
        async function fetchAllHolidaysForCutoff(startDate, endDate) {
            if (!isAuthReady || !userId) {
                console.warn("Authentication not ready to fetch all holidays.");
                return;
            }
            // Validate dates before using them
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error("Invalid startDate or endDate provided to fetchAllHolidaysForCutoff:", startDate, endDate);
                displayMessage("Error: Invalid date range for holiday data. Please check your month/year/cutoff selection.", "error");
                return;
            }

            holidaysCache = {}; // Clear cache before populating for the new range
            try {
                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/holidays`);
                const q = query(collectionRef,
                    where('date', '>=', startDate.toISOString().split('T')[0]),
                    where('date', '<=', endDate.toISOString().split('T')[0]),
                    orderBy('date', 'asc') // Order by date to ensure consistent processing
                );
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((docSnap) => {
                    const data = { id: docSnap.id, ...docSnap.data() };
                    holidaysCache[data.date] = data; // Store by date for quick lookup
                });
                console.log("All holidays for cutoff loaded into cache:", holidaysCache);
            } catch (error) {
                console.error("Error fetching all holidays for cutoff:", error);
                displayMessage("Error loading holiday data for the selected period.", "error");
            }
        }

        // New function to fetch all penalties for a given cutoff range
        async function fetchAllPenaltiesForCutoff(startDate, endDate) {
            if (!isAuthReady || !userId) {
                console.warn("Authentication not ready to fetch all penalties.");
                return;
            }
            // Validate dates before using them
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error("Invalid startDate or endDate provided to fetchAllPenaltiesForCutoff:", startDate, endDate);
                displayMessage("Error: Invalid date range for penalty data. Please check your month/year/cutoff selection.", "error");
                return;
            }

            penaltiesCache = {}; // Clear cache before populating for the new range
            try {
                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/penalties`);
                const q = query(collectionRef,
                    where('date', '>=', startDate.toISOString().split('T')[0]),
                    where('date', '<=', endDate.toISOString().split('T')[0]),
                    orderBy('date', 'asc') // Order by date to ensure consistent processing
                );
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((docSnap) => {
                    const data = { id: docSnap.id, ...docSnap.data() };
                    penaltiesCache[data.date] = data; // Store by date for quick lookup
                });
                console.log("All penalties for cutoff loaded into cache:", penaltiesCache);
            } catch (error) {
                console.error("Error fetching all penalties for cutoff:", error);
                displayMessage("Error loading penalty data for the selected period.", "error");
            }
        }

        // New function to fetch all leaves for a given cutoff range
        async function fetchAllLeavesForCutoff(startDate, endDate) {
            if (!isAuthReady || !userId) {
                console.warn("Authentication not ready to fetch all leaves.");
                return;
            }
            // Validate dates before using them
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error("Invalid startDate or endDate provided to fetchAllLeavesForCutoff:", startDate, endDate);
                displayMessage("Error: Invalid date range for leave data. Please check your month/year/cutoff selection.", "error");
                return;
            }

            leavesCache = {}; // Clear cache before populating for the new range
            try {
                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/leaves`);
                const q = query(collectionRef,
                    where('date', '>=', startDate.toISOString().split('T')[0]),
                    where('date', '<=', endDate.toISOString().split('T')[0]),
                    orderBy('date', 'asc')
                );
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((docSnap) => {
                    const data = { id: docSnap.id, ...docSnap.data() };
                    leavesCache[data.date] = data;
                });
                console.log("All leaves for cutoff loaded into cache:", leavesCache);
            } catch (error) {
                console.error("Error fetching all leaves for cutoff:", error);
                displayMessage("Error loading leave data for the selected period.", "error");
            }
        }

        // New function to fetch all subscribers for a given cutoff range
        async function fetchAllSubscribersForCutoff(startDate, endDate) {
            if (!isAuthReady || !userId) {
                console.warn("Authentication not ready to fetch all subscribers.");
                return;
            }
            // Validate dates before using them
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error("Invalid startDate or endDate provided to fetchAllSubscribersForCutoff:", startDate, endDate);
                displayMessage("Error: Invalid date range for subscriber data. Please check your month/year/cutoff selection.", "error");
                return;
            }

            subscribersCache = {}; // Clear cache before populating for the new range
            try {
                const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/subscribers`);
                const q = query(collectionRef,
                    where('date', '>=', startDate.toISOString().split('T')[0]),
                    where('date', '<=', endDate.toISOString().split('T')[0]),
                    orderBy('date', 'asc')
                );
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((docSnap) => {
                    const data = { id: docSnap.id, ...docSnap.data() };
                    subscribersCache[data.date] = data;
                });
                console.log("All subscribers for cutoff loaded into cache:", subscribersCache);
            } catch (error) {
                console.error("Error fetching all subscribers for cutoff:", error);
                displayMessage("Error loading subscriber data for the selected period.", "error");
            }
        }


        // Save attendance status for a specific cell or perfect attendance checkbox
        async function saveAttendanceStatus(dateString, columnName, status, callingTableBodyId) {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to save attendance data.", "warning");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/dailyAttendance`, dateString);
                if (!attendanceDataCache[dateString]) {
                    attendanceDataCache[dateString] = {};
                }

                // If it's the perfect attendance checkbox, save its state directly
                if (columnName === 'perfectAttendanceChecked') {
                    attendanceDataCache[dateString].perfectAttendanceChecked = status;
                }
                else {
                    attendanceDataCache[dateString][columnName] = status; // Update cache for time slots
                }

                // Update the UI for the calling table
                const specificTableBody = document.getElementById(callingTableBodyId);
                const rowElement = specificTableBody ? specificTableBody.querySelector(`tr[data-date="${dateString}"]`) : null;

                if (rowElement) {
                    const dailyData = attendanceDataCache[dateString]; // Use the updated cache
                    const isLessonsTable = (rowElement.parentElement.id === 'attendance-table-body-lessons');
                    updateCalculatedCellsInRow(rowElement, dailyData, lessonsTimeSlotsArray, isLessonsTable);
                    console.log(`UI updated for ${dateString} - ${columnName} on ${callingTableBodyId}.`);
                } else {
                    console.warn(`Row element for date ${dateString} not found in table ${callingTableBodyId} for immediate UI update.`);
                }

                // If the change came from the Lessons table, also update the Overview table
                if (callingTableBodyId === 'attendance-table-body-lessons') {
                    const overviewTableBody = document.getElementById('attendance-table-body-overview');
                    const overviewRowElement = overviewTableBody ? overviewTableBody.querySelector(`tr[data-date="${dateString}"]`) : null;
                    if (overviewRowElement) {
                        const dailyData = attendanceDataCache[dateString]; // Use the updated cache
                        updateCalculatedCellsInRow(overviewRowElement, dailyData, lessonsTimeSlotsArray, false); // false for overview table
                        console.log(`UI updated for ${dateString} on Overview tab due to Lessons tab change.`);
                    }
                }
                // After saving, update the total salary display for the lessons tab
                updateTotalEarnedDisplay();
                checkPerfectAttendanceBonus(); // Re-check bonus status

                await setDoc(docRef, { data: attendanceDataCache[dateString] }, { merge: true });
                console.log(`Saved ${columnName} for ${dateString}: ${status} to Firestore.`);

            } catch (error) {
                console.error("Error saving attendance status:", error);
                displayMessage("Error saving attendance status.", "error");
            }
        }

        // Status options and their corresponding Tailwind classes
        const STATUS_OPTIONS = [
            { value: '', text: '', colorClass: '' },
            { value: 'Present', text: 'Present', colorClass: 'bg-green-100 text-green-800' },
            { value: 'Missed', text: 'Missed', colorClass: 'bg-red-100 text-red-800' },
            { value: 'Closed', text: 'Closed', colorClass: 'bg-gray-300 text-gray-800' } // New 'Closed' status
        ];

        // Helper to get the current active time slot for highlighting
        function getCurrentActiveTimeSlot(timeSlots) {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTimeInMinutes = currentHour * 60 + currentMinute; // Minutes from midnight (0-1439)

            // Sort time slots to ensure chronological order
            const sortedTimeSlots = [...timeSlots].sort((a, b) => convertTo24Hour(a) - convertTo24Hour(b));

            for (let i = 0; i < sortedTimeSlots.length; i++) {
                const slot = sortedTimeSlots[i];
                const slotStartInMinutes = convertTo24Hour(slot);
                let slotEndInMinutes = slotStartInMinutes + 30; // End time for this 30-min slot

                // Handle slots that cross midnight (e.g., 11:30 PM - 12:00 AM)
                // If the slot starts in the current day and ends in the next day (e.g., 23:30 to 00:00)
                if (slotStartInMinutes >= 23 * 60 + 30 && slotEndInMinutes > 24 * 60) {
                    // Check if current time is within this specific cross-midnight slot
                    // This means current time is after slot start (e.g., 23:30) OR before slot end (e.g., 00:00-00:29)
                    if (currentTimeInMinutes >= slotStartInMinutes || currentTimeInMinutes < (slotEndInMinutes % (24 * 60))) {
                        return slot;
                    }
                } else { // Normal slot, does not cross midnight
                    if (currentTimeInMinutes >= slotStartInMinutes && currentTimeInMinutes < slotEndInMinutes) {
                        return slot;
                    }
                }
            }
            return null; // No active slot found
        }

        // Helper to create a status toggle cell (for Lessons tab)
        function createStatusToggleCell(initialStatus, dateString, columnName, tableBodyId) {
            const cellDiv = document.createElement('div');
            cellDiv.classList.add('status-cell-content'); // Apply common styling for clickable cells
            cellDiv.setAttribute('tabindex', '0'); // Make it focusable for accessibility

            let currentStatusIndex = STATUS_OPTIONS.findIndex(opt => opt.value === initialStatus);
            if (currentStatusIndex === -1) {
                currentStatusIndex = 0; // Default to empty if initial status is not found
            }

            const updateCellAppearance = () => {
                const currentOption = STATUS_OPTIONS[currentStatusIndex];
                cellDiv.textContent = currentOption.text;
                // Remove all previous color classes
                STATUS_OPTIONS.forEach(opt => {
                    if (opt.colorClass) {
                        cellDiv.classList.remove(...opt.colorClass.split(' '));
                    }
                });
                // Add current color class
                if (currentOption.colorClass) {
                    cellDiv.classList.add(...currentOption.colorClass.split(' '));
                }

                // Apply/remove closed-lesson-cell class based on current status
                if (currentOption.value === 'Closed') {
                    cellDiv.classList.add('closed-lesson-cell');
                    // Removed pointer-events: none; so it remains clickable
                } else {
                    cellDiv.classList.remove('closed-lesson-cell');
                }
            };

            updateCellAppearance(); // Set initial appearance

            // Get today's date in local timezone
            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDay = today.getDate();

            // Convert the dateString (which is YYYY-MM-DD from the data) to a local Date object for comparison
            const parts = dateString.split('-');
            const cellDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));

            const isToday = (cellDate.getFullYear() === todayYear &&
                             cellDate.getMonth() === todayMonth &&
                             cellDate.getDate() === todayDay);

            const currentActiveSlot = getCurrentActiveTimeSlot(lessonsTimeSlotsArray);
            const isCurrentTimeSlot = (isToday && columnName === currentActiveSlot);

            if (isCurrentTimeSlot) {
                cellDiv.classList.add('current-time-slot'); // Apply highlighting class
            } else {
                cellDiv.classList.remove('current-time-slot'); // Ensure it's removed if not current
            }

            cellDiv.addEventListener('click', async () => {
                currentStatusIndex = (currentStatusIndex + 1) % STATUS_OPTIONS.length;
                const newStatus = STATUS_OPTIONS[currentStatusIndex].value;
                updateCellAppearance(); // Update UI immediately
                await saveAttendanceStatus(dateString, columnName, newStatus, tableBodyId); // Pass tableBodyId
            });

            return cellDiv;
        }


        // Function to calculate shift totals (AM, PM, GY) and Session Report
        function calculateShiftTotals(dailyAttendanceData, lessonsTimeSlots) {
            let amPresent = 0;
            let amMissed = 0;
            let pmPresent = 0;
            let pmMissed = 0;
            let gyPresent = 0;
            let gyMissed = 0;

            lessonsTimeSlots.forEach(timeSlot => {
                // Convert time to 24-hour format (0-23 hours) for easier comparison
                let [hr, min] = timeSlot.split(' ')[0].split(':').map(Number);
                const period = timeSlot.split(' ')[1];
                if (period && period.toLowerCase() === 'pm' && hr !== 12) hr += 12;
                if (period && period.toLowerCase() === 'am' && hr === 12) hr = 0; // 12 AM is 0 hours

                const timeInHours = hr + min / 60; // e.g., 11.0 for 11:00 AM, 21.5 for 9:30 PM

                const status = dailyAttendanceData[timeSlot] || '';

                // Only count 'Present' and 'Missed'. Ignore 'Closed'.
                if (status === 'Present') {
                    if (timeInHours >= 11 && timeInHours < 21) amPresent++;
                    else if (timeInHours >= 21 || timeInHours < 2) pmPresent++;
                    else if (timeInHours >= 2 && timeInHours < 5) gyPresent++;
                } else if (status === 'Missed') {
                    if (timeInHours >= 11 && timeInHours < 21) amMissed++;
                    else if (timeInHours >= 21 || timeInHours < 2) pmMissed++;
                    else if (timeInHours >= 2 && timeInHours < 5) gyMissed++;
                }
            });

            // Calculate overall totals after iterating through all slots
            const totalPresent = amPresent + pmPresent + gyPresent;
            const totalMissed = amMissed + pmMissed + gyMissed;
            const sessionReport = totalPresent * 2.40; // Changed from 50 to 2.40 pesos per present session

            const results = {
                amPresent,
                amMissed,
                pmPresent,
                pmMissed,
                gyPresent,
                gyMissed,
                totalPresent,
                totalMissed,
                sessionReport: sessionReport.toFixed(2) // Format to 2 decimal places
            };
            return results;
        }

        // Function to update the calculated cells in a specific row
        function updateCalculatedCellsInRow(rowElement, dailyAttendanceData, lessonsTimeSlots, isLessonsTable) {
            const dateString = rowElement.getAttribute('data-date');
            // Use local date for day name
            const localDateForDayName = new Date(dateString + 'T00:00:00'); // Parse as local date
            const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][localDateForDayName.getDay()];
            const isRestDay = restDaysArray.includes(dayName);

            // Check if any time slot for the day is marked as 'Closed'
            const hasClosedSlot = lessonsTimeSlots.some(slot => dailyAttendanceData[slot] === 'Closed');

            try {
                const calculatedTotals = calculateShiftTotals(dailyAttendanceData, lessonsTimeSlots);

                let amAmount = (calculatedTotals.amPresent + calculatedTotals.amMissed) * shiftRates.am;
                let pmAmount = (calculatedTotals.pmPresent + calculatedTotals.pmMissed) * shiftRates.pm;
                let gyAmount = (calculatedTotals.gyPresent + calculatedTotals.gyMissed) * shiftRates.gy;
                const sessionReportValue = parseFloat(calculatedTotals.sessionReport);
                let totalDailyEarn = amAmount + pmAmount + gyAmount + sessionReportValue;

                // Get holiday data for this date from cache
                const holidayData = holidaysCache[dateString];
                let holidayName = '';
                let holidayPercentage = '';
                let holidayRateAmount = 0;

                if (holidayData) {
                    holidayName = holidayData.name;
                    holidayPercentage = `${holidayData.percentage}%`;
                    holidayRateAmount = holidayData.totalAmount;
                    totalDailyEarn += holidayRateAmount; // Add holiday rate to total daily earn
                }

                // Get penalty data for this date from cache
                const penaltyData = penaltiesCache[dateString];
                // Get leave data for this date from cache (only if it's a penalty leave)
                const leaveData = leavesCache[dateString];

                let totalPenaltyAmount = 0;
                let penaltyTypeDisplay = '';
                let penaltyPercentageDisplay = '';

                if (penaltyData) {
                    totalPenaltyAmount += penaltyData.totalAmount;
                    penaltyTypeDisplay = penaltyData.type;
                    penaltyPercentageDisplay = `${penaltyData.percentage}%`;
                }

                if (leaveData && leaveData.status === 'PENALTY') {
                    totalPenaltyAmount += (leaveData.totalAmount || 0);
                    if (penaltyTypeDisplay) {
                        penaltyTypeDisplay += ' & Leave Penalty';
                        penaltyPercentageDisplay += ` & ${leaveData.percentage || 0}%`; // Display leave penalty percentage
                    } else {
                        penaltyTypeDisplay = 'Leave Penalty';
                        penaltyPercentageDisplay = `${leaveData.percentage || 0}%`;
                    }
                }
                totalDailyEarn -= totalPenaltyAmount;

                // Get subscriber data for this date from cache
                const subscriberData = subscribersCache[dateString];
                let freeTrialLessons = 0;
                let subscriptionRate = 0;
                if (subscriberData) {
                    freeTrialLessons = subscriberData.freeTrialLessons || 0;
                    subscriptionRate = freeTrialLessons * 50; // Each trial is 50 pesos
                    totalDailyEarn += subscriptionRate; // Add subscription rate to total daily earn
                }

                // Determine Task Label and Color (now considers hasClosedSlot)
                const { label: taskLabel, colorClass: taskColorClass } = getTaskLabelAndColor(dateString, isRestDay, hasClosedSlot);

                // Update Task column
                const taskCell = rowElement.querySelector('td[data-column="Task"]');
                if (taskCell) {
                    taskCell.textContent = taskLabel;
                    // Remove all task-related color classes before adding the new one
                    taskCell.classList.remove('task-penalty', 'task-holiday', 'task-sick-leave', 'task-vacation-leave', 'task-duty', 'task-closed');
                    if (taskColorClass) {
                        taskCell.classList.add(taskColorClass);
                    }
                }

                if (isLessonsTable) {
                    // Logic for Lessons table specific updates
                    const cellsToUpdate = [
                        { selector: 'td[data-column="AM Shift"]', value: isRestDay ? '' : (calculatedTotals.amPresent + calculatedTotals.amMissed) },
                        { selector: 'td[data-column="PM Shift"]', value: isRestDay ? '' : (calculatedTotals.pmPresent + calculatedTotals.pmMissed) },
                        { selector: 'td[data-column="GY Shift"]', value: isRestDay ? '' : (calculatedTotals.gyPresent + calculatedTotals.gyMissed) },
                        { selector: 'td[data-column="Total"]', value: isRestDay ? '' : `P: ${calculatedTotals.totalPresent} M: ${calculatedTotals.totalMissed}` },
                        { selector: 'td[data-column="Session Report"]', value: isRestDay ? '' : calculatedTotals.sessionReport },
                    ];

                    const amRateCell = rowElement.querySelector('td[data-column="AM RATE"]');
                    if (amRateCell) amRateCell.textContent = isRestDay ? '' : amAmount.toFixed(2);

                    const pmRateCell = rowElement.querySelector('td[data-column="PM RATE"]');
                    if (pmRateCell) pmRateCell.textContent = isRestDay ? '' : pmAmount.toFixed(2);

                    const gyRateCell = rowElement.querySelector('td[data-column="GY RATE"]');
                    if (gyRateCell) gyRateCell.textContent = isRestDay ? '' : gyAmount.toFixed(2);

                    cellsToUpdate.forEach(item => {
                        const cell = rowElement.querySelector(item.selector);
                        if (cell) cell.textContent = item.value;
                    });

                    const totalEarnCell = rowElement.querySelector('td[data-column="Total Earn"]');
                    if (totalEarnCell) totalEarnCell.textContent = isRestDay ? '' : totalDailyEarn.toFixed(2); // Use totalDailyEarn here

                    // Update individual time slot cells for Lessons table
                    lessonsTimeSlots.sort((a, b) => convertTo24Hour(a) - convertTo24Hour(b)).forEach(timeSlot => {
                        const cell = rowElement.querySelector(`td[data-column="${timeSlot}"]`);
                        if (cell) {
                            // Clear existing content and re-create the toggle cell
                            cell.innerHTML = '';
                            if (isRestDay) {
                                cell.classList.add('rest-day-cell');
                                cell.textContent = '';
                            } else {
                                cell.classList.remove('rest-day-cell');
                                const initialStatus = dailyAttendanceData[timeSlot] || '';
                                // Pass the correct tableBodyId to createStatusToggleCell
                                const toggleCell = createStatusToggleCell(initialStatus, dateString, timeSlot, lessonsTableConfig.attendanceTableBodyId);
                                cell.appendChild(toggleCell);
                            }
                        }
                    });

                } else {
                    // Logic for Overview table specific updates
                    const cellsToUpdate = [
                        { selector: 'td[data-column="AM Shift"]', value: isRestDay ? '' : (calculatedTotals.amPresent + calculatedTotals.amMissed) },
                        { selector: 'td[data-column="PM Shift"]', value: isRestDay ? '' : (calculatedTotals.pmPresent + calculatedTotals.pmMissed) },
                        { selector: 'td[data-column="GY Shift"]', value: isRestDay ? '' : (calculatedTotals.gyPresent + calculatedTotals.gyMissed) },
                        { selector: 'td[data-column="AM RATE"]', value: isRestDay ? '' : amAmount.toFixed(2) },
                        { selector: 'td[data-column="PM RATE"]', value: isRestDay ? '' : pmAmount.toFixed(2) },
                        { selector: 'td[data-column="GY RATE"]', value: isRestDay ? '' : gyAmount.toFixed(2) },
                        { selector: 'td[data-column="Total"]', value: isRestDay ? '' : `P: ${calculatedTotals.totalPresent} M: ${calculatedTotals.totalMissed}` },
                        { selector: 'td[data-column="Total Earn"]', value: isRestDay ? '' : totalDailyEarn.toFixed(2) }, // Use totalDailyEarn here
                        { selector: 'td[data-column="Holiday"]', value: isRestDay ? '' : holidayName },
                        { selector: 'td[data-column="Holiday %"]', value: isRestDay ? '' : holidayPercentage },
                        { selector: 'td[data-column="Holiday Rate"]', value: isRestDay ? '' : holidayRateAmount.toFixed(2) },
                        { selector: 'td[data-column="Session Report"]', value: isRestDay ? '' : calculatedTotals.sessionReport },
                        { selector: 'td[data-column="Penalty"]', value: isRestDay ? '' : penaltyTypeDisplay },
                        { selector: 'td[data-column="Percentage"]', value: isRestDay ? '' : penaltyPercentageDisplay },
                        { selector: 'td[data-column="Subscription"]', value: isRestDay ? '' : (freeTrialLessons > 0 ? freeTrialLessons : '') }, // Display blank if zero
                        { selector: 'td[data-column="Subscription Rate"]', value: isRestDay ? '' : (subscriptionRate > 0 ? subscriptionRate.toFixed(2) : '') }, // Display blank if zero
                        { selector: 'td[data-column="TOTAL DAILY RATE"]', value: isRestDay ? '' : totalDailyEarn.toFixed(2) } // Final total with holiday/penalty
                    ];

                    cellsToUpdate.forEach(item => {
                        const cell = rowElement.querySelector(item.selector);
                        if (cell) {
                            cell.textContent = item.value;
                        }
                    });

                    // Handle Perfect Attendance checkbox
                    const perfectAttendanceCell = rowElement.querySelector('td[data-column="Perfect Attendance"]');
                    if (perfectAttendanceCell) {
                        perfectAttendanceCell.innerHTML = ''; // Clear previous content
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-green-600', 'rounded');

                        // Load checked state from dailyAttendanceData
                        checkbox.checked = dailyAttendanceData.perfectAttendanceChecked === true;

                        // Disable if rest day, penalty, or has any closed slot
                        checkbox.disabled = isRestDay || totalPenaltyAmount > 0 || hasClosedSlot;

                        // Add event listener to save state
                        checkbox.addEventListener('change', async () => {
                            await saveAttendanceStatus(dateString, 'perfectAttendanceChecked', checkbox.checked, overviewTableConfig.attendanceTableBodyId);
                        });
                        perfectAttendanceCell.appendChild(checkbox);
                    }

                    // Special handling for Penalty Rate column
                    const penaltyRateCell = rowElement.querySelector('td[data-column="Penalty Rate"]');
                    if (penaltyRateCell) {
                        if (isRestDay) {
                            penaltyRateCell.textContent = '';
                            penaltyRateCell.classList.remove('penalty-rate-red');
                        } else {
                            penaltyRateCell.textContent = totalPenaltyAmount > 0 ? totalPenaltyAmount.toFixed(2) : '';
                            if (totalPenaltyAmount > 0) {
                                penaltyRateCell.classList.add('penalty-rate-red');
                            } else {
                                penaltyRateCell.classList.remove('penalty-rate-red');
                            }
                        }
                    }
                }
            } catch (error) {
                console.error(`Error in updateCalculatedCellsInRow for date ${dateString}:`, error);
                displayMessage(`Error updating calculations for ${dateString}. Check console.`, "error");
            }
        }

        // Helper function to determine the Task column label and its color class
        function getTaskLabelAndColor(dateString, isRestDay, hasClosedSlot) { // Added hasClosedSlot parameter
            const holidayData = holidaysCache[dateString];
            const penaltyData = penaltiesCache[dateString];
            const leaveData = leavesCache[dateString];

            let label = '';
            let colorClass = '';

            if (isRestDay) {
                label = ''; // Blank for rest day
                colorClass = '';
            } else if (hasClosedSlot) { // Check if any slot is closed
                label = 'Closed';
                colorClass = 'task-closed';
            } else if (penaltyData || (leaveData && leaveData.status === 'PENALTY')) {
                label = 'Penalty';
                colorClass = 'task-penalty';
            } else if (holidayData) {
                label = 'Holiday';
                colorClass = 'task-holiday';
            } else if (leaveData && leaveData.status === 'EXCUSED') {
                if (leaveData.type === 'sick') {
                    label = 'Sick Leave';
                    colorClass = 'task-sick-leave';
                } else if (leaveData.type === 'vacation') {
                    label = 'Vacation Leave';
                    colorClass = 'task-vacation-leave';
                }
            } else {
                label = 'DUTY';
                colorClass = 'task-duty';
            }
            return { label, colorClass };
        }

        // Renamed to make it clear this is the core table generation logic
        async function generateAttendanceTable(tableConfig) {
            const timerId = 'generateAttendanceTable-' + tableConfig.idPrefix;
            console.time(timerId);
            const loadingIndicator = document.getElementById('loading-indicator');
            const attendanceTableBody = document.getElementById(tableConfig.attendanceTableBodyId);
            const monthSelect = document.getElementById(tableConfig.monthSelectId);
            const yearSelect = document.getElementById(tableConfig.yearSelectId);
            const cutoffSelect = document.getElementById(tableConfig.cutoffSelectId);
            const isLessonsTableFlag = tableConfig.idPrefix === 'lessons-';

            if (loadingIndicator && isLessonsTableFlag) loadingIndicator.classList.remove('hidden');
            attendanceTableBody.innerHTML = ''; // Clear existing rows

            const selectedMonth = parseInt(monthSelect.value);
            const selectedYear = parseInt(yearSelect.value);
            const selectedCutoff = cutoffSelect.value;

            let startDate, endDate;

            if (selectedCutoff === '1-15') {
                startDate = new Date(Date.UTC(selectedYear, selectedMonth, 1));
                endDate = new Date(Date.UTC(selectedYear, selectedMonth, 15));
            } else { // 16-end
                startDate = new Date(Date.UTC(selectedYear, selectedMonth, 16));
                endDate = new Date(Date.UTC(selectedYear, selectedMonth, getDaysInMonth(selectedYear, selectedMonth)));
            }

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error("Invalid start or end date for table generation:", startDate, endDate);
                displayMessage("Error: Invalid date range for table. Please check your month/year/cutoff selection.", "error");
                if (loadingIndicator && isLessonsTableFlag) loadingIndicator.classList.add('hidden');
                console.timeEnd(timerId);
                return;
            }

            const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            // Get today's date in local timezone
            const today = new Date();
            const todayYear = today.getFullYear();
            const todayMonth = today.getMonth();
            const todayDay = today.getDate();

            const tableHeadRow = attendanceTableBody.previousElementSibling.querySelector('tr');
            tableHeadRow.innerHTML = ''; // Clear existing headers

            const dateTh = document.createElement('th');
            dateTh.scope = 'col';
            dateTh.classList.add('px-6', 'py-3', 'text-left', 'text-xs', 'font-medium', 'text-gray-500', 'uppercase', 'tracking-wider', 'whitespace-nowrap', 'sticky-column-header');
            dateTh.textContent = 'Date';
            tableHeadRow.appendChild(dateTh);

            if (isLessonsTableFlag) {
                lessonsTimeSlotsArray.sort((a, b) => convertTo24Hour(a) - convertTo24Hour(b)).forEach(timeSlot => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.classList.add('px-6', 'py-3', 'text-left', 'text-xs', 'font-medium', 'text-gray-500', 'uppercase', 'tracking-wider', 'whitespace-nowrap');
                    th.innerHTML = `${timeSlot} <button class="delete-time-slot-btn" data-time-slot="${timeSlot}">&times;</button>`;
                    tableHeadRow.appendChild(th);
                });

                const fixedLessonsHeaders = ['AM Shift', 'PM Shift', 'GY Shift', 'AM RATE', 'PM RATE', 'GY RATE', 'Total', 'Total Earn', 'Session Report']; // Removed 'Actions'
                fixedLessonsHeaders.forEach(headerText => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.classList.add('px-6', 'py-3', 'text-left', 'text-xs', 'font-medium', 'text-gray-500', 'uppercase', 'tracking-wider', 'whitespace-nowrap');
                    th.textContent = headerText;
                    th.setAttribute('data-column', headerText);
                    tableHeadRow.appendChild(th);
                });

                tableHeadRow.querySelectorAll('.delete-time-slot-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const timeSlotToDelete = event.target.dataset.timeSlot; // Corrected from data-time-slot to data-timeSlot
                        const confirmDelete = window.confirm(`Are you sure you want to delete the time slot "${timeSlotToDelete}"? This will remove it from all daily records.`);
                        if (!confirmDelete) {
                            displayMessage("Time slot deletion cancelled.", "info");
                            return;
                        }
                        lessonsTimeSlotsArray = lessonsTimeSlotsArray.filter(slot => slot !== timeSlotToDelete);
                        await saveLessonsTimeSlots();
                        // Re-generate both tables as column structure changes
                        await generateAttendanceTable(overviewTableConfig); // Re-generate overview
                        await generateAttendanceTable(lessonsTableConfig); // Re-generate lessons
                        await generateAllDatesList(parseInt(document.getElementById('year-select-list').value), document.getElementById('month-select-list').value); // Re-generate list of dates
                        updateAddDeleteButtonsState();
                        populateHolidayTimeSlots();
                        populatePenaltyTimeSlots();
                        populateLeaveTimeSlots();
                        updateQuickAttendanceBox(); // Update quick attendance box after slot changes
                    });
                });

            } else {
                tableConfig.columnOrder.forEach(headerText => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.classList.add('px-6', 'py-3', 'text-left', 'text-xs', 'font-medium', 'text-gray-500', 'uppercase', 'tracking-wider', 'whitespace-nowrap');
                    if (headerText === 'Task') {
                        th.classList.add('w-64');
                    }
                    th.textContent = headerText;
                    th.setAttribute('data-column', headerText);
                    tableHeadRow.appendChild(th);
                });
            }

            // Fetch all relevant data for the cutoff before rendering rows
            await fetchAllAttendanceDataForCutoff(startDate, endDate);
            await fetchAllHolidaysForCutoff(startDate, endDate);
            await fetchAllPenaltiesForCutoff(startDate, endDate);
            await fetchAllLeavesForCutoff(startDate, endDate);
            await fetchAllSubscribersForCutoff(startDate, endDate);


            for (let d = new Date(startDate); d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
                const row = document.createElement('tr');
                const dateString = d.toISOString().split('T')[0]; // This is the UTC date string from the loop
                row.setAttribute('data-date', dateString);

                // Convert the UTC date 'd' to a local Date object for comparison
                const loopDateLocal = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
                const dayName = daysOfWeek[loopDateLocal.getDay()]; // Get local day name
                const isRestDay = restDaysArray.includes(dayName);

                // Highlight current date row based on local date
                if (loopDateLocal.getFullYear() === todayYear &&
                    loopDateLocal.getMonth() === todayMonth &&
                    loopDateLocal.getDate() === todayDay) {
                    row.classList.add('current-date-row');
                } else {
                    row.classList.remove('current-date-row'); // Ensure it's removed if not current
                }

                const dailyAttendanceData = attendanceDataCache[dateString] || {};
                // Check if any time slot for the day is marked as 'Closed'
                const hasClosedSlot = lessonsTimeSlotsArray.some(slot => dailyAttendanceData[slot] === 'Closed');

                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(dateString);
                dateCell.classList.add('whitespace-nowrap', 'sticky-column');

                if (isRestDay) { // Apply rest-day class to the date cell
                    dateCell.classList.add('rest-day');
                }
                row.appendChild(dateCell);

                if (isLessonsTableFlag) {
                    lessonsTimeSlotsArray.sort((a, b) => convertTo24Hour(a) - convertTo24Hour(b)).forEach(timeSlot => {
                        const cell = document.createElement('td');
                        cell.setAttribute('data-column', timeSlot); // Add data-column for time slots
                        if (isRestDay) {
                            cell.classList.add('rest-day-cell'); // Add class for rest day cells
                            cell.textContent = ''; // Blank out content
                        } else {
                            cell.classList.remove('rest-day-cell');
                            const initialStatus = dailyAttendanceData[timeSlot] || '';
                            const toggleCell = createStatusToggleCell(initialStatus, dateString, timeSlot, tableConfig.attendanceTableBodyId);
                            cell.appendChild(toggleCell);
                        }
                        row.appendChild(cell);
                    });

                    const fixedLessonsColumns = ['AM Shift', 'PM Shift', 'GY Shift', 'AM RATE', 'PM RATE', 'GY RATE', 'Total', 'Total Earn', 'Session Report'];
                    fixedLessonsColumns.forEach(colName => {
                        const cell = document.createElement('td');
                        cell.textContent = '';
                        cell.setAttribute('data-column', colName);
                        if (isRestDay) cell.classList.add('rest-day-cell'); // Apply rest-day-cell to calculated columns too
                        row.appendChild(cell);
                    });

                    attendanceTableBody.appendChild(row);
                    updateCalculatedCellsInRow(row, dailyAttendanceData, lessonsTimeSlotsArray, isLessonsTableFlag);

                } else {
                    tableConfig.columnOrder.forEach(colName => {
                        const cell = document.createElement('td');
                        cell.setAttribute('data-column', colName);

                        if (colName === 'Task') {
                            cell.classList.add('w-64');
                            cell.textContent = '';
                        } else if (colName === 'Progress Indicator') {
                            const progressContent = document.createElement('span');
                            const todayLocal = new Date(); // Get local today
                            todayLocal.setHours(0, 0, 0, 0); // Normalize to start of day

                            const currentDateInLoopLocal = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()); // Convert UTC loop date to local date for comparison
                            currentDateInLoopLocal.setHours(0, 0, 0, 0); // Normalize to start of day

                            if (isRestDay) { // Use the isRestDay variable
                                progressContent.textContent = 'REST DAY';
                                progressContent.classList.add('bg-purple-100', 'text-purple-800', 'font-semibold', 'rounded-md', 'py-1', 'px-2');
                            } else if (currentDateInLoopLocal < todayLocal) {
                                progressContent.textContent = 'Completed';
                                progressContent.classList.add('bg-green-100', 'text-green-800', 'font-semibold', 'rounded-md', 'py-1', 'px-2');
                            } else if (currentDateInLoopLocal.getTime() === todayLocal.getTime()) {
                                progressContent.textContent = 'On Going';
                                progressContent.classList.add('bg-yellow-100', 'text-yellow-800', 'font-semibold', 'rounded-md', 'py-1', 'px-2');
                            } else {
                                progressContent.textContent = 'Upcoming';
                                progressContent.classList.add('bg-blue-100', 'text-blue-800', 'font-semibold', 'rounded-md', 'py-1', 'px-2');
                            }
                            cell.appendChild(progressContent);
                        }
                        // All other columns will be updated by updateCalculatedCellsInRow
                        row.appendChild(cell);
                    });
                    attendanceTableBody.appendChild(row);
                    // After appending the row, update its calculated cells
                    updateCalculatedCellsInRow(row, dailyAttendanceData, lessonsTimeSlotsArray, isLessonsTableFlag);
                }
            }
            if (loadingIndicator && isLessonsTableFlag) loadingIndicator.classList.add('hidden');
            console.timeEnd(timerId);
        }

        // Reusable function to set up an attendance table instance (dropdowns, checkboxes, event listeners)
        function setupAttendanceTableControls(tableConfig) {
            const monthSelect = document.getElementById(tableConfig.monthSelectId);
            const yearSelect = document.getElementById(tableConfig.yearSelectId);
            const cutoffSelect = document.getElementById(tableConfig.cutoffSelectId);
            const restDayCheckboxesDiv = document.getElementById(tableConfig.restDayCheckboxesDivId);

            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            const daysOfWeekFull = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            const currentDayOfMonth = new Date().getDate();

            monthSelect.innerHTML = months.map((month, index) =>
                `<option value="${index}" ${index === currentMonth ? 'selected' : ''}>${month}</option>`
            ).join('');

            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }

            if (currentDayOfMonth <= 15) {
                cutoffSelect.value = '1-15';
            } else {
                cutoffSelect.value = '16-end';
            }

            restDayCheckboxesDiv.innerHTML = daysOfWeekFull.map(day => `
                <div class="flex items-center">
                    <input type="checkbox" id="${tableConfig.idPrefix}restday-${day}" value="${day}" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                    <label for="${tableConfig.idPrefix}restday-${day}" class="ml-1 text-sm text-gray-700">${day.substring(0, 3)}</label>
                </div>
            `).join('');

            function updateAndSaveRestDaysLocal() {
                restDaysArray = Array.from(restDayCheckboxesDiv.querySelectorAll('input[type="checkbox"]:checked'))
                                     .map(checkbox => checkbox.value);
                saveRestDays();
                // Trigger re-generation of both tables as rest days affect row styling and progress indicator
                generateAttendanceTable(overviewTableConfig);
                generateAttendanceTable(lessonsTableConfig);
                generateAllDatesList(parseInt(document.getElementById('year-select-list').value), document.getElementById('month-select-list').value);
                updateQuickAttendanceBox(); // Update quick attendance box after rest day changes
            }

            restDayCheckboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateAndSaveRestDaysLocal);
            });

            updateRestDayCheckboxes(restDayCheckboxesDiv);

            // Event Listeners for dynamic updates - these now trigger the full table generation
            monthSelect.addEventListener('change', () => {
                generateAttendanceTable(tableConfig);
                if (tableConfig.idPrefix === 'lessons-') updateQuickAttendanceBox(); // Update quick attendance box if lessons tab
            });
            yearSelect.addEventListener('change', () => {
                generateAttendanceTable(tableConfig);
                if (tableConfig.idPrefix === 'lessons-') updateQuickAttendanceBox(); // Update quick attendance box if lessons tab
            });
            cutoffSelect.addEventListener('change', () => {
                generateAttendanceTable(tableConfig);
                updateTotalEarnedDisplay();
                checkPerfectAttendanceBonus(); // Re-check bonus when cutoff changes
                if (tableConfig.idPrefix === 'lessons-') updateQuickAttendanceBox(); // Update quick attendance box if lessons tab
            });
        }


        // Function to refresh calculations for all currently displayed table rows
        function refreshAllTableCalculations() {
            console.log("Refreshing all table calculations...");
            const overviewTableBody = document.getElementById('attendance-table-body-overview');
            const lessonsTableBody = document.getElementById('attendance-table-body-lessons');
            const allDatesTableBody = document.getElementById('all-dates-table-body');

            // Update Overview Table
            if (overviewTableBody) {
                overviewTableBody.querySelectorAll('tr[data-date]').forEach(rowElement => {
                    const dateString = rowElement.getAttribute('data-date');
                    const dailyData = attendanceDataCache[dateString] || {};
                    updateCalculatedCellsInRow(rowElement, dailyData, lessonsTimeSlotsArray, false); // false for overview
                });
            }

            // Update Lessons Table
            if (lessonsTableBody) {
                lessonsTableBody.querySelectorAll('tr[data-date]').forEach(rowElement => {
                    const dateString = rowElement.getAttribute('data-date');
                    const dailyData = attendanceDataCache[dateString] || {};
                    updateCalculatedCellsInRow(rowElement, dailyData, lessonsTimeSlotsArray, true); // true for lessons
                });
                updateTotalEarnedDisplay(); // Recalculate total earned for lessons tab
                checkPerfectAttendanceBonus(); // Re-check bonus
                updateQuickAttendanceBox(); // Update quick attendance box after data changes
            }

            // Update List of Date of Year Table
            if (allDatesTableBody) {
                allDatesTableBody.querySelectorAll('tr[data-date]').forEach(rowElement => {
                    const dateString = rowElement.getAttribute('data-date');
                    const dailyData = attendanceDataCache[dateString] || {};
                    updateCalculatedCellsInRow(rowElement, dailyData, lessonsTimeSlotsArray, false);
                });
            }
        }

        // Function to check and display perfect attendance bonus
        async function checkPerfectAttendanceBonus() {
            const bonusBox = document.getElementById('perfect-attendance-bonus-box');
            if (!bonusBox) return;

            const selectedMonth = parseInt(document.getElementById('month-select-lessons').value);
            const selectedYear = parseInt(document.getElementById('year-select-lessons').value);
            const selectedCutoff = document.getElementById('cutoff-select-lessons').value;

            let startDate, endDate;

            if (selectedCutoff === '1-15') {
                startDate = new Date(Date.UTC(selectedYear, selectedMonth, 1));
                endDate = new Date(Date.UTC(selectedYear, selectedMonth, 15));
            } else { // 16-end
                startDate = new Date(Date.UTC(selectedYear, selectedMonth, 16));
                endDate = new Date(Date.UTC(selectedYear, selectedMonth, getDaysInMonth(selectedYear, selectedMonth)));
            }

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                bonusBox.classList.add('hidden');
                return;
            }

            let hasPerfectAttendanceForCutoff = true;
            let bonusApplicable = true; // Flag to check if bonus should be added to total earned

            // Ensure all necessary data is in cache for the cutoff
            await fetchAllAttendanceDataForCutoff(startDate, endDate);
            await fetchAllHolidaysForCutoff(startDate, endDate);
            await fetchAllPenaltiesForCutoff(startDate, endDate);
            await fetchAllLeavesForCutoff(startDate, endDate);

            for (let d = new Date(startDate); d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
                const dateString = d.toISOString().split('T')[0];
                // Use local date for day name
                const localDateForDayName = new Date(dateString + 'T00:00:00'); // Parse as local date
                const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][localDateForDayName.getDay()];
                const isRestDay = restDaysArray.includes(dayName);

                if (isRestDay) {
                    continue; // Skip rest days for perfect attendance check
                }

                const dailyAttendanceData = attendanceDataCache[dateString] || {};
                const penaltyData = penaltiesCache[dateString];
                const leaveData = leavesCache[dateString];

                // Check if any time slot for the day is marked as 'Closed'
                const hasClosedSlot = lessonsTimeSlotsArray.some(slot => dailyAttendanceData[slot] === 'Closed');

                // Check if there's any penalty (including unexcused leave) OR if the day has any closed slot
                const hasPenaltyOrUnexcusedLeaveOrClosedSlot = penaltyData || (leaveData && leaveData.status === 'PENALTY') || hasClosedSlot;

                // Check if the perfect attendance checkbox is NOT checked or if there's any violation
                if (dailyAttendanceData.perfectAttendanceChecked !== true || hasPenaltyOrUnexcusedLeaveOrClosedSlot) {
                    hasPerfectAttendanceForCutoff = false;
                    bonusApplicable = false; // If any day fails, bonus is not applicable
                    break; // No need to check further
                }
            }

            if (hasPerfectAttendanceForCutoff) {
                bonusBox.classList.remove('hidden');
            } else {
                bonusBox.classList.add('hidden');
            }

            // Update total earned based on bonus applicability
            updateTotalEarnedDisplay(bonusApplicable);
        }


        // Function to update rates from input fields and re-render the lessons table
        async function updateRatesAndTable() {
            shiftRates.am = parseFloat(document.getElementById('am-rate-input').value) || 0;
            shiftRates.pm = parseFloat(document.getElementById('pm-rate-input').value) || 0;
            shiftRates.gy = parseFloat(document.getElementById('gy-rate-input').value) || 0;
            console.log("Rates updated:", shiftRates); // Log rates
            await saveShiftRates(); // Save updated rates to Firestore

            // Instead of re-rendering the entire table, iterate and update existing rows
            const lessonsTableBody = document.getElementById('attendance-table-body-lessons');
            if (lessonsTableBody) {
                const rows = lessonsTableBody.querySelectorAll('tr[data-date]');
                console.log(`Attempting to update ${rows.length} rows with new rates.`); // Log row count
                rows.forEach(rowElement => { // Use forEach for cleaner iteration
                    const dateString = rowElement.getAttribute('data-date');
                    const dailyData = attendanceDataCache[dateString] || {}; // Get data from cache
                    updateCalculatedCellsInRow(rowElement, dailyData, lessonsTimeSlotsArray, true); // Pass true for isLessonsTable
                });
                console.log("Finished updating rows for new rates.");
            } else {
                console.warn("Lessons table body not found for rate update.");
            }

            // Also update the Overview table when rates change
            const overviewTableBody = document.getElementById('attendance-table-body-overview');
            if (overviewTableBody) {
                const rows = overviewTableBody.querySelectorAll('tr[data-date]');
                console.log(`Attempting to update ${rows.length} Overview rows with new rates.`);
                rows.forEach(rowElement => {
                    const dateString = rowElement.getAttribute('data-date');
                    const dailyData = attendanceDataCache[dateString] || {};
                    updateCalculatedCellsInRow(rowElement, dailyData, lessonsTimeSlotsArray, false); // Pass false for isLessonsTable
                });
                console.log("Finished updating Overview rows for new rates.");
            } else {
                console.warn("Overview table body not found for rate update.");
            }

            // Update total salary display after rates change
            updateTotalEarnedDisplay();
            checkPerfectAttendanceBonus(); // Re-check bonus
            // Also update penalty/holiday/leave totals in input data forms
            calculateHolidayTotal();
            calculatePenaltyTotal();
            calculateLeaveTotal();
        }

        // Function to update digital clocks
        function updateClocks() {
            const phClockElement = document.getElementById('ph-clock');
            const ilClockElement = document.getElementById('il-clock');

            if (phClockElement) {
                const phTime = new Intl.DateTimeFormat('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true,
                    timeZone: 'Asia/Manila'
                }).format(new Date());
                phClockElement.textContent = phTime;
            }

            if (ilClockElement) {
                const ilTime = new Intl.DateTimeFormat('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true,
                    timeZone: 'Asia/Jerusalem'
                }).format(new Date());
                ilClockElement.textContent = ilTime;
            }
        }

        // Function to generate all dates for the selected year and optionally month in the "List of Date of Year" tab
        async function generateAllDatesList(selectedYear, selectedMonth = null) { // Added selectedMonth parameter
            const allDatesTableBody = document.getElementById('all-dates-table-body');
            let allDatesTableHeader = document.querySelector('#all-dates-table th');
            let allDatesTableHeaderRow = allDatesTableHeader ? allDatesTableHeader.querySelector('tr') : null;

            // If thead or tr don't exist, create them
            if (!allDatesTableHeader) {
                const allDatesTable = document.getElementById('all-dates-table');
                if (allDatesTable) {
                    allDatesTableHeader = document.createElement('thead');
                    allDatesTableHeader.classList.add('bg-gray-50');
                    allDatesTable.prepend(allDatesTableHeader); // Prepend to ensure it's at the top
                }
            }
            if (!allDatesTableHeaderRow && allDatesTableHeader) {
                allDatesTableHeaderRow = document.createElement('tr');
                allDatesTableHeader.appendChild(allDatesTableHeaderRow);
            }

            if (!allDatesTableBody || !allDatesTableHeaderRow) {
                console.error("Required table elements for 'List of Date of Year' not found or could not be created.");
                return;
            }

            allDatesTableBody.innerHTML = ''; // Clear existing table body
            allDatesTableHeaderRow.innerHTML = ''; // Clear existing headers

            // Define the new column headers
            const newColumnHeaders = [
                'Task', 'Progress Indicator', 'AM Shift', 'PM Shift', 'GY Shift',
                'AM RATE', 'PM RATE', 'GY RATE', 'Total', 'Total Earn',
                'Holiday', 'Holiday %', 'Holiday Rate', 'Perfect Attendance',
                'Subscription', 'Subscription Rate', 'Session Report', 'Penalty', 'Percentage',
                'Penalty Rate', 'TOTAL DAILY RATE'
            ];

            // Add Date column header
            const dateTh = document.createElement('th');
            dateTh.scope = 'col';
            dateTh.classList.add('px-6', 'py-3', 'text-left', 'text-xs', 'font-medium', 'text-gray-500', 'uppercase', 'tracking-wider', 'whitespace-nowrap', 'sticky-column-header');
            dateTh.textContent = 'Date';
            allDatesTableHeaderRow.appendChild(dateTh);

            // Add new column headers
            newColumnHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.classList.add('px-6', 'py-3', 'text-left', 'text-xs', 'font-medium', 'text-gray-500', 'uppercase', 'tracking-wider', 'whitespace-nowrap');
                th.textContent = headerText;
                allDatesTableHeaderRow.appendChild(th);
            });


            let startDate, endDate;

            if (selectedMonth !== null && selectedMonth !== '') {
                // Specific month selected
                startDate = new Date(Date.UTC(selectedYear, parseInt(selectedMonth), 1));
                endDate = new Date(Date.UTC(selectedYear, parseInt(selectedMonth), getDaysInMonth(selectedYear, parseInt(selectedMonth))));
            } else {
                // All months (entire year)
                startDate = new Date(Date.UTC(selectedYear, 0, 1)); // January 1st UTC
                endDate = new Date(Date.UTC(selectedYear, 11, 31)); // December 31st UTC
            }

            // Validate dates before proceeding
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error("Invalid start or end date for all dates list generation:", startDate, endDate);
                displayMessage("Error: Invalid year/month selected for the list of dates.", "error");
                return;
            }

            // Fetch all attendance, holiday, penalty, leave, and subscriber data for the entire year/selected month before rendering
            // This is crucial to ensure data is available for all dates in the list
            await fetchAllAttendanceDataForCutoff(startDate, endDate); // AWAIT this call
            await fetchAllHolidaysForCutoff(startDate, endDate); // Fetch holidays
            await fetchAllPenaltiesForCutoff(startDate, endDate); // Fetch penalties
            await fetchAllLeavesForCutoff(startDate, endDate); // Fetch leaves
            await fetchAllSubscribersForCutoff(startDate, endDate); // Fetch subscribers


            for (let d = new Date(startDate); d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
                const row = document.createElement('tr');
                const dateString = d.toISOString().split('T')[0]; // YYYY-MM-DD format
                row.setAttribute('data-date', dateString); // Add data-date attribute to the row
                // Use local date for day name
                const localDateForDayName = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()); // Parse as local date
                const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][localDateForDayName.getDay()]; // Get day name for rest day check using local day
                const isRestDay = restDaysArray.includes(dayName);

                // Get attendance data from cache for this specific date
                const dailyAttendanceData = attendanceDataCache[dateString] || {};
                const hasClosedSlot = lessonsTimeSlotsArray.some(slot => dailyAttendanceData[slot] === 'Closed'); // Check if any slot is closed

                const calculatedTotals = calculateShiftTotals(dailyAttendanceData, lessonsTimeSlotsArray);

                // Get holiday data for this date
                const holidayData = holidaysCache[dateString];
                let holidayName = '';
                let holidayPercentage = '';
                let holidayRateAmount = 0;
                if (holidayData) {
                    holidayName = holidayData.name;
                    holidayPercentage = `${holidayData.percentage}%`;
                    holidayRateAmount = holidayData.totalAmount;
                }

                // Get penalty data for this date
                const penaltyData = penaltiesCache[dateString];
                // Get leave data for this date
                const leaveData = leavesCache[dateString];

                let totalPenaltyAmount = 0;
                let penaltyTypeDisplay = '';
                let penaltyPercentageDisplay = '';

                if (penaltyData) {
                    totalPenaltyAmount += penaltyData.totalAmount;
                    penaltyTypeDisplay = penaltyData.type;
                    penaltyPercentageDisplay = `${penaltyData.percentage}%`;
                }

                if (leaveData && leaveData.status === 'PENALTY') {
                    totalPenaltyAmount += (leaveData.totalAmount || 0);
                    if (penaltyTypeDisplay) {
                        penaltyTypeDisplay += ' & Leave Penalty';
                        penaltyPercentageDisplay += ` & ${leaveData.percentage || 0}%`; // Display leave penalty percentage
                    } else {
                        penaltyTypeDisplay = 'Leave Penalty';
                        penaltyPercentageDisplay = `${leaveData.percentage || 0}%`;
                    }
                }

                let amAmount = (calculatedTotals.amPresent + calculatedTotals.amMissed) * shiftRates.am;
                let pmAmount = (calculatedTotals.pmPresent + calculatedTotals.pmMissed) * shiftRates.pm;
                let gyAmount = (calculatedTotals.gyPresent + calculatedTotals.gyMissed) * shiftRates.gy;
                const sessionReportValue = parseFloat(calculatedTotals.sessionReport);
                let totalDailyEarn = amAmount + pmAmount + gyAmount + sessionReportValue;

                // Add holiday rate to total daily earn
                totalDailyEarn += holidayRateAmount;
                // Subtract total penalties (regular + leave) from total daily earn
                totalDailyEarn -= totalPenaltyAmount;

                // Add subscription rate to total daily earn
                const subscriberData = subscribersCache[dateString];
                let subscriptionRate = 0;
                if (subscriberData) {
                    subscriptionRate = (subscriberData.freeTrialLessons || 0) * 50;
                    totalDailyEarn += subscriptionRate;
                }

                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(dateString); // Use formatDate for consistent display
                dateCell.classList.add('whitespace-nowrap', 'sticky-column'); // Keep consistent styling and make sticky

                // Add 'rest-day' class if it's a rest day
                if (isRestDay) {
                    dateCell.classList.add('rest-day');
                }
                row.appendChild(dateCell);

                // Add cells for the new columns, populating with data if available
                newColumnHeaders.forEach(colName => {
                    const cell = document.createElement('td');
                    cell.classList.add('whitespace-nowrap'); // Ensure consistent styling

                    if (colName === 'Task') {
                        cell.classList.add('w-64');
                        const { label: taskLabel, colorClass: taskColorClass } = getTaskLabelAndColor(dateString, isRestDay, hasClosedSlot);
                        cell.textContent = taskLabel;
                        if (taskColorClass) {
                            cell.classList.add(taskColorClass);
                        }
                    } else if (colName === 'Progress Indicator') {
                        const progressContent = document.createElement('span');
                        const todayLocal = new Date(); // Get local today
                        todayLocal.setHours(0, 0, 0, 0); // Normalize to start of day

                        const currentDateInLoopLocal = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()); // Convert UTC loop date to local date for comparison
                        currentDateInLoopLocal.setHours(0, 0, 0, 0); // Normalize to start of day

                        if (isRestDay) {
                            progressContent.textContent = 'REST DAY';
                            progressContent.classList.add('bg-purple-100', 'text-purple-800', 'font-semibold', 'rounded-md', 'py-1', 'px-2');
                        } else if (currentDateInLoopLocal < todayLocal) {
                            progressContent.textContent = 'Completed';
                            progressContent.classList.add('bg-green-100', 'text-green-800', 'font-semibold', 'rounded-md', 'py-1', 'px-2');
                        } else if (currentDateInLoopLocal.getTime() === todayLocal.getTime()) {
                            progressContent.textContent = 'On Going';
                            progressContent.classList.add('bg-yellow-100', 'text-yellow-800', 'font-semibold', 'rounded-md', 'py-1', 'px-2');
                        } else {
                            progressContent.textContent = 'Upcoming';
                            progressContent.classList.add('bg-blue-100', 'text-blue-800', 'font-semibold', 'rounded-md', 'py-1', 'px-2');
                        }
                        cell.appendChild(progressContent);
                    } else if (isRestDay) { // If it's a rest day, blank out all other work-related columns
                        cell.textContent = '';
                    } else if (colName === 'AM Shift') {
                        cell.textContent = calculatedTotals.amPresent + calculatedTotals.amMissed;
                    } else if (colName === 'PM Shift') {
                        cell.textContent = calculatedTotals.pmPresent + calculatedTotals.pmMissed;
                    } else if (colName === 'GY Shift') {
                        cell.textContent = calculatedTotals.gyPresent + calculatedTotals.gyMissed;
                    } else if (colName === 'AM RATE') {
                        cell.textContent = amAmount.toFixed(2);
                    } else if (colName === 'PM RATE') {
                        cell.textContent = pmAmount.toFixed(2);
                    } else if (colName === 'GY RATE') {
                        cell.textContent = gyAmount.toFixed(2);
                    } else if (colName === 'Total') {
                        cell.textContent = `P: ${calculatedTotals.totalPresent} M: ${calculatedTotals.totalMissed}`;
                    } else if (colName === 'Session Report') {
                        cell.textContent = calculatedTotals.sessionReport;
                    } else if (colName === 'Total Earn') {
                        cell.textContent = totalDailyEarn.toFixed(2);
                    } else if (colName === 'Holiday') {
                        cell.textContent = holidayData ? holidayData.name : '';
                    } else if (colName === 'Holiday %') {
                        cell.textContent = holidayData ? `${holidayData.percentage}%` : '';
                    } else if (colName === 'Holiday Rate') {
                        cell.textContent = holidayData ? holidayData.totalAmount.toFixed(2) : '';
                    } else if (colName === 'Perfect Attendance') {
                        cell.innerHTML = ''; // Clear existing content
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-green-600', 'rounded');

                        // Load checked state from dailyAttendanceData
                        checkbox.checked = dailyAttendanceData.perfectAttendanceChecked === true;

                        // Disable if rest day, penalty, or has any closed slot
                        checkbox.disabled = isRestDay || totalPenaltyAmount > 0 || hasClosedSlot;

                        // Add event listener to save state
                        checkbox.addEventListener('change', async () => {
                            await saveAttendanceStatus(dateString, 'perfectAttendanceChecked', checkbox.checked, 'all-dates-table-body'); // Use this table's ID
                        });
                        cell.appendChild(checkbox);
                    } else if (colName === 'Penalty') {
                        cell.textContent = penaltyTypeDisplay;
                    } else if (colName === 'Percentage') {
                        cell.textContent = penaltyPercentageDisplay;
                    } else if (colName === 'Subscription') {
                        cell.textContent = subscriberData && subscriberData.freeTrialLessons > 0 ? subscriberData.freeTrialLessons : '';
                    } else if (colName === 'Subscription Rate') {
                        cell.textContent = subscriberData && (subscriberData.freeTrialLessons || 0) * 50 > 0 ? ((subscriberData.freeTrialLessons || 0) * 50).toFixed(2) : '';
                    } else if (colName === 'Penalty Rate') {
                        if (totalPenaltyAmount > 0) {
                            cell.textContent = totalPenaltyAmount.toFixed(2);
                            cell.classList.add('penalty-rate-red');
                        } else {
                            cell.textContent = '';
                            cell.classList.remove('penalty-rate-red');
                        }
                    } else if (colName === 'TOTAL DAILY RATE') {
                        cell.textContent = totalDailyEarn.toFixed(2);
                    }
                    else {
                        cell.textContent = ''; // Default for other columns
                    }
                    row.appendChild(cell);
                });
                allDatesTableBody.appendChild(row);
            }
        }

        // Setup function for the "List of Date of Year" tab
        async function setupListOfDatesTable() { // Made async
            const yearSelectList = document.getElementById('year-select-list');
            const monthSelectList = document.getElementById('month-select-list'); // New month select
            const currentYear = new Date().getFullYear();
            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];

            // Populate Year dropdown (e.g., current year +/- 5 years)
            yearSelectList.innerHTML = ''; // Clear existing options
            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) {
                    option.selected = true;
                }
                yearSelectList.appendChild(option);
            }

            // Populate Month dropdown
            monthSelectList.innerHTML = '<option value="">-- All Months --</option>' + months.map((month, index) =>
                `<option value="${index}">${month}</option>`
            ).join('');

            // Event listener for year change
            yearSelectList.addEventListener('change', async (event) => { // Made async
                await generateAllDatesList(parseInt(event.target.value), monthSelectList.value);
            });

            // Event listener for month change
            monthSelectList.addEventListener('change', async (event) => { // Made async
                await generateAllDatesList(parseInt(yearSelectList.value), event.target.value);
            });

            // Initial generation of the list for the current year (and no specific month selected)
            await generateAllDatesList(currentYear, ''); // AWAIT this call, pass empty string for all months
            // After initial generation, ensure calculations are refreshed in case other data loaded first
            refreshAllTableCalculations(); // <--- IMPORTANT ADDITION
        }

        // Function to calculate and update the total earned display for the Lessons tab
        async function updateTotalEarnedDisplay(includeBonus = false) { // Added includeBonus parameter
            const totalSalaryElement = document.getElementById('lessons-total-salary');
            if (!totalSalaryElement) return;

            const selectedMonth = parseInt(document.getElementById('month-select-lessons').value);
            const selectedYear = parseInt(document.getElementById('year-select-lessons').value);
            const selectedCutoff = document.getElementById('cutoff-select-lessons').value;

            let startDate, endDate;

            if (selectedCutoff === '1-15') {
                startDate = new Date(Date.UTC(selectedYear, selectedMonth, 1));
                endDate = new Date(Date.UTC(selectedYear, selectedMonth, 15));
            } else { // 16-end
                startDate = new Date(Date.UTC(selectedYear, selectedMonth, 16));
                endDate = new Date(Date.UTC(selectedYear, selectedMonth, getDaysInMonth(selectedYear, selectedMonth)));
            }

            // Validate dates before proceeding
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                console.error("Invalid start or end date for total earned display:", startDate, endDate);
                totalSalaryElement.textContent = `PHP 0.00`; // Reset display on error
                return;
            }

            let totalEarnedSum = 0;

            // Ensure attendance, holiday, penalty, leave, and subscriber data for the current cutoff is loaded into cache
            await fetchAllAttendanceDataForCutoff(startDate, endDate);
            await fetchAllHolidaysForCutoff(startDate, endDate);
            await fetchAllPenaltiesForCutoff(startDate, endDate);
            await fetchAllLeavesForCutoff(startDate, endDate);
            await fetchAllSubscribersForCutoff(startDate, endDate);

            // Iterate through the dates in the current cutoff
            for (let d = new Date(startDate); d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
                const dateString = d.toISOString().split('T')[0];
                // Use local date for day name
                const localDateForDayName = new Date(dateString + 'T00:00:00'); // Parse as local date
                const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][localDateForDayName.getDay()];
                const isRestDay = restDaysArray.includes(dayName);

                if (isRestDay) { // Skip calculations for rest days for total earned
                    continue;
                }

                const dailyAttendanceData = attendanceDataCache[dateString] || {};

                const calculatedTotals = calculateShiftTotals(dailyAttendanceData, lessonsTimeSlotsArray);

                let amAmount = (calculatedTotals.amPresent + calculatedTotals.amMissed) * shiftRates.am;
                let pmAmount = (calculatedTotals.pmPresent + calculatedTotals.pmMissed) * shiftRates.pm;
                let gyAmount = (calculatedTotals.gyPresent + calculatedTotals.gyMissed) * shiftRates.gy;
                const sessionReportValue = parseFloat(calculatedTotals.sessionReport);
                let dailyTotalEarn = amAmount + pmAmount + gyAmount + sessionReportValue;

                // Add holiday rate to total daily earn
                const holidayData = holidaysCache[dateString];
                if (holidayData) {
                    dailyTotalEarn += holidayData.totalAmount;
                }

                // Subtract penalties (regular + leave) from total daily earn
                const penaltyData = penaltiesCache[dateString];
                const leaveData = leavesCache[dateString];

                let totalPenaltyAmount = 0;
                if (penaltyData) {
                    totalPenaltyAmount += penaltyData.totalAmount;
                }
                if (leaveData && leaveData.status === 'PENALTY') {
                    totalPenaltyAmount += (leaveData.totalAmount || 0);
                }
                dailyTotalEarn -= totalPenaltyAmount;

                // Add subscription rate to total daily earn
                const subscriberData = subscribersCache[dateString];
                let subscriptionRate = 0;
                if (subscriberData) {
                    subscriptionRate = (subscriberData.freeTrialLessons || 0) * 50;
                    dailyTotalEarn += subscriptionRate;
                }

                totalEarnedSum += dailyTotalEarn;
            }

            // Add perfect attendance bonus if applicable
            if (includeBonus) {
                totalEarnedSum += 250;
            }

            totalSalaryElement.textContent = `PHP ${totalEarnedSum.toFixed(2)}`;
        }

        // --- New JavaScript for Input Data Tab (Moved to global scope) ---

        function getShiftForTimeSlot(timeSlot) {
            let [hr, min] = timeSlot.split(' ')[0].split(':').map(Number);
            const period = timeSlot.split(' ')[1];
            if (period && period.toLowerCase() === 'pm' && hr !== 12) hr += 12;
            if (period && period.toLowerCase() === 'am' && hr === 12) hr = 0; // 12 AM is 0 hours
            const timeInHours = hr + min / 60;

            if (timeInHours >= 11 && timeInHours < 21) {
                return 'am';
            } else if (timeInHours >= 21 || timeInHours < 2) {
                return 'pm';
            } else if (timeInHours >= 2 && timeInHours < 5) {
                return 'gy';
            }
            return null; // Should not happen if time slots are valid
        }

        let selectedHolidayTimeSlots = new Set(); // To keep track of selected time slots for holiday
        const holidayRateInput = document.getElementById('holiday-rate');
        const holidayTotalInput = document.getElementById('holiday-total');
        const holidayLessonSlotsContainer = document.getElementById('holiday-lesson-slots');
        const holidayListBox = document.getElementById('holiday-list-container');

        function calculateHolidayTotal() {
            let totalHolidayAmount = 0;
            const holidayPercentage = parseFloat(holidayRateInput.value) / 100 || 0;

            selectedHolidayTimeSlots.forEach(timeSlot => {
                const shift = getShiftForTimeSlot(timeSlot);
                let rate = 0;
                if (shift === 'am') rate = shiftRates.am;
                else if (shift === 'pm') rate = shiftRates.pm;
                else if (shift === 'gy') rate = shiftRates.gy;

                totalHolidayAmount += rate * holidayPercentage;
            });
            holidayTotalInput.value = totalHolidayAmount.toFixed(2);
        }

        function populateHolidayTimeSlots() {
            holidayLessonSlotsContainer.innerHTML = ''; // Clear existing elements
            if (lessonsTimeSlotsArray.length === 0) {
                holidayLessonSlotsContainer.innerHTML = '<p class="text-gray-500">No time slots available. Please add in Lessons tab.</p>';
                return;
            }

            lessonsTimeSlotsArray.sort((a, b) => convertTo24Hour(a) - convertTo24Hour(b)).forEach(timeSlot => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'gap-2'); // Tailwind classes for layout

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `holiday-slot-${timeSlot.replace(/[^a-zA-Z0-9]/g, '-')}`; // Create a valid ID
                checkbox.value = timeSlot;
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-blue-600', 'rounded', 'focus:ring-blue-500');

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = timeSlot;
                label.classList.add('text-gray-700');

                // Set initial checked state based on selectedHolidayTimeSlots
                if (selectedHolidayTimeSlots.has(timeSlot)) {
                    checkbox.checked = true;
                }

                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedHolidayTimeSlots.add(timeSlot);
                    } else {
                        selectedHolidayTimeSlots.delete(timeSlot);
                    }
                    calculateHolidayTotal(); // Recalculate total on checkbox change
                });

                div.appendChild(checkbox);
                div.appendChild(label);
                holidayLessonSlotsContainer.appendChild(div);
            });
        }

        function renderHolidays(holidays) {
            holidayListBox.innerHTML = ''; // Clear existing list
            if (holidays.length === 0) {
                holidayListBox.innerHTML = '<p class="text-gray-500">No holidays recorded yet.</p>';
                return;
            }
            holidays.forEach((holiday, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('data-list-item');
                itemDiv.innerHTML = `
                    <span>
                        (${index + 1}) ${formatDate(holiday.date)} - ${holiday.name} - ${holiday.percentage}% - PHP ${holiday.totalAmount.toFixed(2)}
                    </span>
                    <span class="delete-icon" data-id="${holiday.id}" data-type="holiday">&times;</span>
                `;
                holidayListBox.appendChild(itemDiv);
            });
        }

        async function loadHolidays() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to load holidays.", "warning");
                return;
            }
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/holidays`), orderBy('date', 'asc'));
            onSnapshot(q, (snapshot) => {
                const holidays = [];
                holidaysCache = {}; // Clear cache before populating
                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    holidays.push(data);
                    holidaysCache[data.date] = data; // Populate cache
                });
                renderHolidays(holidays);
                refreshAllTableCalculations(); // <--- IMPORTANT CHANGE
                updateUpcomingEvents(); // Update upcoming events box
            }, (error) => {
                console.error("Error fetching holidays:", error);
                displayMessage("Error loading holidays.", "error");
            });
        }

        async function deleteHoliday(id) {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to delete holiday.", "warning");
                return;
            }
            const confirmDelete = window.confirm("Are you sure you want to delete this holiday entry?");
            if (!confirmDelete) {
                displayMessage("Holiday deletion cancelled.", "info");
                return;
            }

            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/holidays`, id));
                displayMessage("Holiday deleted successfully!", "success");
                // The onSnapshot listener in loadHolidays will automatically re-render the list and tables
            } catch (error) {
                console.error("Error deleting holiday:", error);
                displayMessage("Error deleting holiday.", "error");
            }
        }

        const holidayDataForm = document.getElementById('holiday-data-form');
        holidayDataForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const holidayDate = document.getElementById('holiday-date').value;
            const holidayName = document.getElementById('holiday-name').value;
            const holidayRate = parseFloat(holidayRateInput.value);
            const totalHolidayAmount = parseFloat(holidayTotalInput.value);

            if (!holidayDate || !holidayName || isNaN(holidayRate) || selectedHolidayTimeSlots.size === 0) {
                displayMessage("Please fill all holiday fields correctly and select at least one lesson slot.", "error");
                return;
            }
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to save holiday.", "warning");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/holidays`), {
                    date: holidayDate,
                    name: holidayName,
                    percentage: holidayRate, // Changed from 'rate' to 'percentage' for clarity
                    selectedLessons: Array.from(selectedHolidayTimeSlots), // Store selected time slots
                    totalAmount: totalHolidayAmount,
                    timestamp: new Date().toISOString()
                });
                displayMessage("Holiday data submitted and saved!", "success");
                holidayDataForm.reset(); // Clear form
                selectedHolidayTimeSlots.clear(); // Clear selected slots
                populateHolidayTimeSlots(); // Re-populate checkboxes to reflect cleared state
                calculateHolidayTotal(); // Reset total holiday display
            } catch (error) {
                console.error("Error saving holiday:", error);
                displayMessage("Error saving holiday.", "error");
            }
        });

        // Event listeners for holiday form
        holidayRateInput.addEventListener('input', calculateHolidayTotal);
        // Initial population when holiday form is first displayed (handled by displayCategoryForm)

        // Event listener for delete icons on the holiday list
        holidayListBox.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-icon') && event.target.dataset.type === 'holiday') {
                const id = event.target.dataset.id;
                deleteHoliday(id);
            }
        });


        // --- Leave Form Logic (Moved to global scope) ---
        let selectedLeaveTimeSlots = new Set(); // To keep track of selected time slots for leave penalty
        const leaveDataForm = document.getElementById('leave-data-form');
        const leaveTypeSelect = document.getElementById('leave-type');
        const vacationLeaveQuestions = document.getElementById('vacation-leave-questions');
        const sickLeaveQuestions = document.getElementById('sick-leave-questions');
        const leavePenaltyDetails = document.getElementById('leave-penalty-details');
        const leaveLessonSlotsContainer = document.getElementById('leave-lesson-slots');
        const leaveTotalPenaltyInput = document.getElementById('leave-total-penalty');
        const leavePenaltyPercentageInput = document.getElementById('leave-penalty-percentage'); // New input
        const leaveListBox = document.getElementById('leave-list-container');

        function calculateLeaveTotal() {
            let totalLeavePenaltyAmount = 0;
            let leavePenaltyPercentage = parseFloat(leavePenaltyPercentageInput.value) / 100 || 0;

            // Enforce min 0%
            if (leavePenaltyPercentage < 0) {
                leavePenaltyPercentage = 0;
                leavePenaltyPercentageInput.value = 0; // Update input field
            }

            selectedLeaveTimeSlots.forEach(timeSlot => {
                const shift = getShiftForTimeSlot(timeSlot);
                let rate = 0;
                if (shift === 'am') rate = shiftRates.am;
                else if (shift === 'pm') rate = shiftRates.pm;
                else if (shift === 'gy') rate = shiftRates.gy;

                totalLeavePenaltyAmount += rate * leavePenaltyPercentage; // Apply percentage
            });
            leaveTotalPenaltyInput.value = totalLeavePenaltyAmount.toFixed(2);
        }

        function populateLeaveTimeSlots() {
            leaveLessonSlotsContainer.innerHTML = ''; // Clear existing elements
            if (lessonsTimeSlotsArray.length === 0) {
                leaveLessonSlotsContainer.innerHTML = '<p class="text-gray-500">No time slots available. Please add in Lessons tab.</p>';
                return;
            }

            lessonsTimeSlotsArray.sort((a, b) => convertTo24Hour(a) - convertTo24Hour(b)).forEach(timeSlot => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'gap-2'); // Tailwind classes for layout

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `leave-slot-${timeSlot.replace(/[^a-zA-Z0-9]/g, '-')}`; // Create a valid ID
                checkbox.value = timeSlot;
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-blue-600', 'rounded', 'focus:ring-blue-500');

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = timeSlot;
                label.classList.add('text-gray-700');

                // Set initial checked state based on selectedLeaveTimeSlots
                if (selectedLeaveTimeSlots.has(timeSlot)) {
                    checkbox.checked = true;
                }

                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedLeaveTimeSlots.add(timeSlot);
                    } else {
                        selectedLeaveTimeSlots.delete(timeSlot);
                    }
                    calculateLeaveTotal(); // Recalculate total on checkbox change
                });

                div.appendChild(checkbox);
                div.appendChild(label);
                leaveLessonSlotsContainer.appendChild(div);
            });
        }

        function toggleLeaveQuestions() {
            vacationLeaveQuestions.classList.add('hidden');
            sickLeaveQuestions.classList.add('hidden');
            leavePenaltyDetails.classList.add('hidden'); // Hide penalty details by default

            // Reset radio buttons and selected slots when leave type changes
            document.querySelectorAll('input[name="vacation-7-days"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('input[name="sick-leave-medcert"]').forEach(radio => radio.checked = false);
            selectedLeaveTimeSlots.clear();
            populateLeaveTimeSlots(); // Re-populate to clear checked states
            leavePenaltyPercentageInput.value = 0; // Reset percentage input
            calculateLeaveTotal(); // Reset total

            if (leaveTypeSelect.value === 'vacation') {
                vacationLeaveQuestions.classList.remove('hidden');
            } else if (leaveTypeSelect.value === 'sick') {
                sickLeaveQuestions.classList.remove('hidden');
            }
        }
        leaveTypeSelect.addEventListener('change', toggleLeaveQuestions);

        // Event listeners for vacation leave radio buttons
        document.querySelectorAll('input[name="vacation-7-days"]').forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'yes') { // PENALTY
                    leavePenaltyDetails.classList.remove('hidden');
                    populateLeaveTimeSlots();
                } else { // EXCUSED
                    leavePenaltyDetails.classList.add('hidden');
                    selectedLeaveTimeSlots.clear(); // Clear selected slots if excused
                    populateLeaveTimeSlots(); // Re-populate to clear checked states
                }
                calculateLeaveTotal(); // Recalculate total on radio change
            });
        });

        // Event listeners for sick leave radio buttons
        document.querySelectorAll('input[name="sick-leave-medcert"]').forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'no') { // PENALTY
                    leavePenaltyDetails.classList.remove('hidden');
                    populateLeaveTimeSlots();
                } else { // EXCUSED
                    leavePenaltyDetails.classList.add('hidden');
                    selectedLeaveTimeSlots.clear(); // Clear selected slots if excused
                    populateLeaveTimeSlots(); // Re-populate to clear checked states
                }
                calculateLeaveTotal(); // Recalculate total on radio change
            });
        });

        // Event listener for leave penalty percentage input
        leavePenaltyPercentageInput.addEventListener('input', calculateLeaveTotal);


        function renderLeaves(leaves) {
            leaveListBox.innerHTML = '';
            if (leaves.length === 0) {
                leaveListBox.innerHTML = '<p class="text-gray-500">No leaves recorded yet.</p>';
                return;
            }
            leaves.forEach((leave, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('data-list-item');
                const statusClass = leave.status === 'PENALTY' ? 'penalty-status' : '';
                let penaltyInfo = '';
                if (leave.status === 'PENALTY' && leave.totalAmount !== undefined) {
                    penaltyInfo = ` (Penalty: PHP ${leave.totalAmount.toFixed(2)}`;
                    if (leave.percentage !== undefined) {
                        penaltyInfo += `, ${leave.percentage}%)`;
                    } else {
                        penaltyInfo += `)`;
                    }
                }
                itemDiv.innerHTML = `
                    <span>
                        (${index + 1}) ${formatDate(leave.date)} - ${leave.type === 'vacation' ? 'Vacation Leave' : 'Sick Leave'} - <span class="${statusClass}">${leave.status}</span>${penaltyInfo}
                    </span>
                    <span class="delete-icon" data-id="${leave.id}" data-type="leave">&times;</span>
                `;
                leaveListBox.appendChild(itemDiv);
            });
        }

        async function loadLeaves() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to load leaves.", "warning");
                return;
            }
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/leaves`), orderBy('date', 'asc'));
            onSnapshot(q, (snapshot) => {
                const leaves = [];
                leavesCache = {}; // Clear cache before populating
                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    leaves.push(data);
                    leavesCache[data.date] = data; // Populate cache
                });
                renderLeaves(leaves);
                refreshAllTableCalculations(); // <--- IMPORTANT CHANGE
                updateUpcomingEvents(); // Update upcoming events box
            }, (error) => {
                console.error("Error fetching leaves:", error);
                displayMessage("Error loading leaves.", "error");
            });
        }

        async function deleteLeave(id) {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to delete leave.", "warning");
                return;
            }
            const confirmDelete = window.confirm("Are you sure you want to delete this leave entry?");
            if (!confirmDelete) {
                displayMessage("Leave deletion cancelled.", "info");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/leaves`, id));
                displayMessage("Leave deleted successfully!", "success");
            } catch (error) {
                console.error("Error deleting leave:", error);
                displayMessage("Error deleting leave.", "error");
            }
        }

        leaveDataForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const leaveDate = document.getElementById('leave-date').value;
            const leaveType = leaveTypeSelect.value;
            let leaveStatus = '';
            let totalLeavePenalty = 0;
            let selectedSlotsForLeave = [];
            let leavePenaltyPercentage = 0; // New variable

            if (!leaveDate) {
                displayMessage("Please select a date for the leave.", "error");
                return;
            }

            if (leaveType === 'vacation') {
                const within7Days = document.querySelector('input[name="vacation-7-days"]:checked');
                if (!within7Days) {
                    displayMessage("Please answer the vacation leave question.", "error");
                    return;
                }
                leaveStatus = within7Days.value === 'yes' ? 'PENALTY' : 'EXCUSED';
            } else if (leaveType === 'sick') {
                const medCertSubmitted = document.querySelector('input[name="sick-leave-medcert"]:checked');
                if (!medCertSubmitted) {
                    displayMessage("Please answer the sick leave question.", "error");
                    return;
                }
                leaveStatus = medCertSubmitted.value === 'yes' ? 'EXCUSED' : 'PENALTY';
            } else {
                displayMessage("Please select a type of leave.", "error");
                return;
            }

            if (leaveStatus === 'PENALTY') {
                leavePenaltyPercentage = parseFloat(leavePenaltyPercentageInput.value); // Get percentage
                if (isNaN(leavePenaltyPercentage) || leavePenaltyPercentage < 0 || leavePenaltyPercentage > 100) {
                    displayMessage("Please enter a valid leave penalty percentage (0-100).", "error");
                    return;
                }
                totalLeavePenalty = parseFloat(leaveTotalPenaltyInput.value);
                selectedSlotsForLeave = Array.from(selectedLeaveTimeSlots);
                if (selectedSlotsForLeave.length === 0) {
                    displayMessage("Please select at least one lesson slot for penalty leave.", "error");
                    return;
                }
            }

            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to save leave.", "warning");
                return;;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/leaves`), {
                    date: leaveDate,
                    type: leaveType,
                    status: leaveStatus,
                    percentage: leavePenaltyPercentage, // Save the percentage
                    selectedLessons: selectedSlotsForLeave, // Only populate if penalty
                    totalAmount: totalLeavePenalty, // Only populate if penalty
                    timestamp: new Date().toISOString()
                });
                displayMessage("Leave data submitted and saved!", "success");
                leaveDataForm.reset(); // Clear form
                toggleLeaveQuestions(); // Hide questions and penalty details after reset
                selectedLeaveTimeSlots.clear(); // Clear selected slots
                populateLeaveTimeSlots(); // Re-populate to reflect cleared state
                calculateLeaveTotal(); // Reset total
            } catch (error) {
                console.error("Error saving leave:", error);
                displayMessage("Error saving leave.", "error");
            }
        });

        leaveListBox.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-icon') && event.target.dataset.type === 'leave') {
                const id = event.target.dataset.id;
                deleteLeave(id);
            }
        });


        // --- Penalty Form Logic (Moved to global scope) ---
        let selectedPenaltyTimeSlots = new Set(); // To keep track of selected time slots for penalty
        const penaltyDataForm = document.getElementById('penalty-data-form');
        const penaltyPercentageInput = document.getElementById('penalty-percentage');
        const penaltyLessonSlotsContainer = document.getElementById('penalty-lesson-slots');
        const penaltyTotalInput = document.getElementById('penalty-total');
        const penaltyListBox = document.getElementById('penalty-list-container');

        function calculatePenaltyTotal() {
            let totalPenaltyAmount = 0;
            let penaltyPercentage = parseFloat(penaltyPercentageInput.value) / 100 || 0;

            // Enforce min 0%
            if (penaltyPercentage < 0) {
                penaltyPercentage = 0;
                penaltyPercentageInput.value = 0; // Update input field
            }

            selectedPenaltyTimeSlots.forEach(timeSlot => {
                const shift = getShiftForTimeSlot(timeSlot);
                let rate = 0;
                if (shift === 'am') rate = shiftRates.am;
                else if (shift === 'pm') rate = shiftRates.pm;
                else if (shift === 'gy') rate = shiftRates.gy;

                totalPenaltyAmount += rate * penaltyPercentage;
            });
            penaltyTotalInput.value = totalPenaltyAmount.toFixed(2);
        }

        function populatePenaltyTimeSlots() {
            penaltyLessonSlotsContainer.innerHTML = ''; // Clear existing elements
            if (lessonsTimeSlotsArray.length === 0) {
                penaltyLessonSlotsContainer.innerHTML = '<p class="text-gray-500">No time slots available. Please add in Lessons tab.</p>';
                return;
            }

            lessonsTimeSlotsArray.sort((a, b) => convertTo24Hour(a) - convertTo24Hour(b)).forEach(timeSlot => {
                const div = document.createElement('div');
                div.classList.add('flex', 'items-center', 'gap-2'); // Tailwind classes for layout

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `penalty-slot-${timeSlot.replace(/[^a-zA-Z0-9]/g, '-')}`; // Create a valid ID
                checkbox.value = timeSlot;
                checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-blue-600', 'rounded', 'focus:ring-blue-500');

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = timeSlot;
                label.classList.add('text-gray-700');

                // Set initial checked state based on selectedPenaltyTimeSlots
                if (selectedPenaltyTimeSlots.has(timeSlot)) {
                    checkbox.checked = true;
                }

                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedPenaltyTimeSlots.add(timeSlot);
                    } else {
                        selectedPenaltyTimeSlots.delete(timeSlot);
                    }
                    calculatePenaltyTotal(); // Recalculate total on checkbox change
                });

                div.appendChild(checkbox);
                div.appendChild(label);
                penaltyLessonSlotsContainer.appendChild(div);
            });
        }

        function renderPenalties(penalties) {
            penaltyListBox.innerHTML = '';
            if (penalties.length === 0) {
                penaltyListBox.innerHTML = '<p class="text-gray-500">No penalties recorded yet.</p>';
                return;
            }
            penalties.forEach((penalty, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('data-list-item');
                itemDiv.innerHTML = `
                    <span>
                        (${index + 1}) ${formatDate(penalty.date)} - ${penalty.type === 'skipped' ? 'Skipped' : 'Canceled'} - <span class="penalty-status">PHP ${penalty.totalAmount.toFixed(2)}</span>
                    </span>
                    <span class="delete-icon" data-id="${penalty.id}" data-type="penalty">&times;</span>
                `;
                penaltyListBox.appendChild(itemDiv);
            });
        }

        async function loadPenalties() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to load penalties.", "warning");
                return;
            }
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/penalties`), orderBy('date', 'asc'));
            onSnapshot(q, (snapshot) => {
                const penalties = [];
                penaltiesCache = {}; // Clear cache before populating
                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    penalties.push(data);
                    penaltiesCache[data.date] = data; // Populate cache
                });
                renderPenalties(penalties);
                refreshAllTableCalculations(); // <--- IMPORTANT CHANGE
            }, (error) => {
                console.error("Error fetching penalties:", error);
                displayMessage("Error loading penalties.", "error");
            });
        }

        async function deletePenalty(id) {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to delete penalty.", "warning");
                return;
            }
            const confirmDelete = window.confirm("Are you sure you want to delete this penalty entry?");
            if (!confirmDelete) {
                displayMessage("Penalty deletion cancelled.", "info");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/penalties`, id));
                displayMessage("Penalty deleted successfully!", "success");
            }
            catch (error) {
                console.error("Error deleting penalty:", error);
                displayMessage("Error deleting penalty.", "error");
            }
        }

        // Event listeners for penalty form
        penaltyPercentageInput.addEventListener('input', calculatePenaltyTotal);
        // Initial population when penalty form is first displayed (handled by displayCategoryForm)

        penaltyDataForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const penaltyDate = document.getElementById('penalty-date').value;
            const penaltyType = document.getElementById('penalty-type').value;
            const penaltyPercentage = parseFloat(penaltyPercentageInput.value);
            const penaltyTotal = parseFloat(penaltyTotalInput.value);

            if (!penaltyDate) {
                displayMessage("Please select a date for the penalty.", "error");
                return;
            }
            if (!penaltyType || isNaN(penaltyPercentage) || selectedPenaltyTimeSlots.size === 0) {
                displayMessage("Please select penalty type, percentage, and at least one lesson slot.", "error");
                return;
            }
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to save penalty.", "warning");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/penalties`), {
                    date: penaltyDate,
                    type: penaltyType,
                    percentage: penaltyPercentage,
                    selectedLessons: Array.from(selectedPenaltyTimeSlots), // Store selected time slots
                    totalAmount: penaltyTotal,
                    timestamp: new Date().toISOString()
                });
                displayMessage("Penalty data submitted and saved!", "success");
                penaltyDataForm.reset(); // Clear form
                selectedPenaltyTimeSlots.clear(); // Clear selected slots
                populatePenaltyTimeSlots(); // Re-populate checkboxes to reflect cleared state
                calculatePenaltyTotal(); // Reset total penalty display
            } catch (error) {
                console.error("Error saving penalty:", error);
                displayMessage("Error saving penalty.", "error");
            }
        });

        penaltyListBox.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-icon') && event.target.dataset.type === 'penalty') {
                const id = event.target.dataset.id;
                deletePenalty(id);
            }
        });


        // --- Subscriber Form Logic (Moved to global scope) ---
        const subscriberDataForm = document.getElementById('subscriber-data-form');
        const subscriberListBox = document.getElementById('subscriber-list-container');

        function renderSubscribers(subscribers) {
            subscriberListBox.innerHTML = '';
            if (subscribers.length === 0) {
                subscriberListBox.innerHTML = '<p class="text-gray-500">No subscriptions recorded yet.</p>';
                return;
            }
            subscribers.forEach((subscriber, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('data-list-item');
                itemDiv.innerHTML = `
                    <span>
                        (${index + 1}) ${formatDate(subscriber.date)} - Free Trials: ${subscriber.freeTrialLessons}
                    </span>
                    <span class="delete-icon" data-id="${subscriber.id}" data-type="subscriber">&times;</span>
                `;
                subscriberListBox.appendChild(itemDiv);
            });
        }

        async function loadSubscribers() {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to load subscribers.", "warning");
                return;
            }
            const q = query(collection(db, `artifacts/${appId}/users/${userId}/subscribers`), orderBy('date', 'asc'));
            onSnapshot(q, (snapshot) => {
                const subscribers = [];
                subscribersCache = {}; // Clear cache before populating
                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    subscribers.push(data);
                    subscribersCache[data.date] = data; // Populate cache
                });
                renderSubscribers(subscribers);
                refreshAllTableCalculations(); // <--- IMPORTANT CHANGE
            }, (error) => {
                console.error("Error fetching subscribers:", error);
                displayMessage("Error loading subscribers.", "error");
            });
        }

        async function deleteSubscriber(id) {
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to delete subscriber.", "warning");
                return;
            }
            const confirmDelete = window.confirm("Are you sure you want to delete this subscriber entry?");
            if (!confirmDelete) {
                displayMessage("Subscriber deletion cancelled.", "info");
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/subscribers`, id));
                displayMessage("Subscriber deleted successfully!", "success");
            } catch (error) {
                console.error("Error deleting subscriber:", error);
                displayMessage("Error deleting subscriber.", "error");
            }
        }

        subscriberDataForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const subscriberDate = document.getElementById('subscriber-date').value;
            const freeTrialLessons = parseInt(document.getElementById('free-trial-lessons').value);

            if (!subscriberDate || isNaN(freeTrialLessons) || freeTrialLessons < 0) {
                displayMessage("Please fill all subscriber fields correctly.", "error");
                return;
            }
            if (!isAuthReady || !userId) {
                displayMessage("Authentication not ready to save subscriber.", "warning");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/subscribers`), {
                    date: subscriberDate,
                    freeTrialLessons: freeTrialLessons,
                    timestamp: new Date().toISOString()
                });
                displayMessage("Subscriber data submitted and saved!", "success");
                subscriberDataForm.reset(); // Clear form
            } catch (error) {
                console.error("Error saving subscriber:", error);
                displayMessage("Error saving subscriber.", "error");
            }
        });

        subscriberListBox.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-icon') && event.target.dataset.type === 'subscriber') {
                const id = event.target.dataset.id;
                deleteSubscriber(id);
            }
        });


        // --- Quick Attendance Box Logic ---
        const currentActiveSlotDisplay = document.getElementById('current-active-slot-display');
        const quickPresentBtn = document.getElementById('quick-present-btn');
        const quickMissedBtn = document.getElementById('quick-missed-btn');
        const quickClosedBtn = document.getElementById('quick-closed-btn');

        function updateQuickAttendanceBox() {
            const today = new Date();
            const todayDateStringLocal = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][today.getDay()]; // Get local day name
            const isTodayRestDay = restDaysArray.includes(dayName);

            const currentActiveSlot = getCurrentActiveTimeSlot(lessonsTimeSlotsArray);
            currentActiveSlotDisplay.textContent = currentActiveSlot || '--:-- --';

            // Check if today is a rest day, holiday, or has a penalty/leave
            const holidayData = holidaysCache[todayDateStringLocal]; // Use local date string for cache lookup
            const penaltyData = penaltiesCache[todayDateStringLocal]; // Use local date string for cache lookup
            const leaveData = leavesCache[todayDateStringLocal]; // Use local date string for cache lookup
            const hasPenaltyOrLeave = penaltyData || (leaveData && leaveData.status === 'PENALTY');

            const disableButtons = !currentActiveSlot || isTodayRestDay || holidayData || hasPenaltyOrLeave;

            quickPresentBtn.disabled = disableButtons;
            quickMissedBtn.disabled = disableButtons;
            quickClosedBtn.disabled = disableButtons;

            // If disabled, also update the displayed status in the quick attendance box
            if (disableButtons) {
                if (isTodayRestDay) {
                    currentActiveSlotDisplay.textContent = 'REST DAY';
                } else if (holidayData) {
                    currentActiveSlotDisplay.textContent = 'HOLIDAY';
                } else if (hasPenaltyOrLeave) {
                    currentActiveSlotDisplay.textContent = 'PENALTY/LEAVE';
                } else if (!currentActiveSlot) {
                    currentActiveSlotDisplay.textContent = 'NO ACTIVE SLOT';
                }
            }
        }

        quickPresentBtn.addEventListener('click', async () => {
            const currentActiveSlot = getCurrentActiveTimeSlot(lessonsTimeSlotsArray);
            const today = new Date();
            const todayDateStringLocal = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            if (currentActiveSlot) {
                await saveAttendanceStatus(todayDateStringLocal, currentActiveSlot, 'Present', lessonsTableConfig.attendanceTableBodyId);
            }
        });

        quickMissedBtn.addEventListener('click', async () => {
            const currentActiveSlot = getCurrentActiveTimeSlot(lessonsTimeSlotsArray);
            const today = new Date();
            const todayDateStringLocal = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            if (currentActiveSlot) {
                await saveAttendanceStatus(todayDateStringLocal, currentActiveSlot, 'Missed', lessonsTableConfig.attendanceTableBodyId);
            }
        });

        quickClosedBtn.addEventListener('click', async () => {
            const currentActiveSlot = getCurrentActiveTimeSlot(lessonsTimeSlotsArray);
            const today = new Date();
            const todayDateStringLocal = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            if (currentActiveSlot) {
                await saveAttendanceStatus(todayDateStringLocal, currentActiveSlot, 'Closed', lessonsTableConfig.attendanceTableBodyId);
            }
        });
        // --- End of Quick Attendance Box Logic ---

        // --- Upcoming Events Box Logic ---
        const upcomingEventsList = document.getElementById('upcoming-events-list');

        function updateUpcomingEvents() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of today for comparison

            const upcoming = [];

            // Check holidays
            for (const dateString in holidaysCache) {
                const holiday = holidaysCache[dateString];
                const holidayDate = new Date(holiday.date + 'T00:00:00'); // Parse as UTC date
                if (holidayDate >= today) {
                    const diffTime = holidayDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Calculate remaining days
                    upcoming.push({
                        date: holiday.date,
                        name: holiday.name,
                        type: 'Holiday',
                        remainingDays: diffDays
                    });
                }
            }

            // Check vacation leaves (only 'EXCUSED' ones)
            for (const dateString in leavesCache) {
                const leave = leavesCache[dateString];
                // Only consider vacation leaves that are 'EXCUSED'
                if (leave.type === 'vacation' && leave.status === 'EXCUSED') {
                    const leaveDate = new Date(leave.date + 'T00:00:00'); // Parse as UTC date
                    if (leaveDate >= today) {
                        const diffTime = leaveDate.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Calculate remaining days
                        upcoming.push({
                            date: leave.date,
                            name: 'Vacation Leave',
                            type: 'Leave',
                            remainingDays: diffDays
                        });
                    }
                }
            }

            // Sort upcoming events by date
            upcoming.sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());

            upcomingEventsList.innerHTML = ''; // Clear previous content

            if (upcoming.length === 0) {
                upcomingEventsList.innerHTML = '<p class="text-gray-600">No upcoming events found.</p>';
            } else {
                upcoming.forEach(event => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('flex', 'justify-between', 'items-center', 'py-2', 'px-4', 'bg-white', 'rounded-md', 'shadow-sm');
                    // Added distinction for Leave or Holiday
                    itemDiv.innerHTML = `
                        <div>
                            <span class="font-semibold">${formatDate(event.date)}</span> -
                            <span class="text-gray-700">${event.name} (${event.type})</span>
                        </div>
                        <span class="text-blue-600 font-bold">${event.remainingDays} day${event.remainingDays === 1 ? '' : 's'} left</span>
                    `;
                    upcomingEventsList.appendChild(itemDiv);
                });
            }
        }
        // --- End of Upcoming Events Box Logic ---


        // Wait for auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id').textContent = userId; // Update user ID display
                isAuthReady = true;
                console.log(" User authenticated:", userId);
                await loadRestDays(); // Load rest days first
                await loadLessonsTimeSlots(); // Load lessons time slots
                await loadShiftRates(); // Load shift rates

                // Initialize table controls (dropdowns, checkboxes, their event listeners)
                setupAttendanceTableControls(overviewTableConfig);
                setupAttendanceTableControls(lessonsTableConfig);

                // Initial generation of tables after controls are set up and data loaded
                await generateAttendanceTable(overviewTableConfig);
                await generateAttendanceTable(lessonsTableConfig);

                // Initialize List of Date of Year tab
                await setupListOfDatesTable(); // This will call generateAllDatesList initially

                // Set up onSnapshot listeners for data changes. These will now trigger refreshAllTableCalculations.
                loadHolidays(); // This function now contains the onSnapshot listener
                loadLeaves();   // This function now contains the onSnapshot listener
                loadPenalties(); // This function now contains the onSnapshot listener
                loadSubscribers(); // This function now contains the onSnapshot listener

                // Time slot management for Lessons tab
                const hourSelect = document.getElementById('hour-select');
                const minuteSelect = document.getElementById('minute-select');
                const ampmSelect = document.getElementById('ampm-select');
                const addTimeSlotBtn = document.getElementById('add-time-slot-btn');
                const deleteTimeSlotBtn = document.getElementById('delete-time-slot-btn');

                // Populate hour dropdown (1-12)
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = String(i).padStart(2, '0');
                    option.textContent = String(i);
                    hourSelect.appendChild(option);
                }

                function getSelectedTimeSlot() {
                    const hour = hourSelect.value;
                    const minute = minuteSelect.value;
                    const ampm = ampmSelect.value;
                    return `${hour}:${minute} ${ampm}`;
                }

                function updateAddDeleteButtonsState() {
                    const selectedTime = getSelectedTimeSlot();
                    const exists = lessonsTimeSlotsArray.includes(selectedTime);
                    addTimeSlotBtn.disabled = exists;
                    deleteTimeSlotBtn.disabled = !exists;
                }

                // Add event listeners for dropdown changes to update button states
                hourSelect.addEventListener('change', updateAddDeleteButtonsState);
                minuteSelect.addEventListener('change', updateAddDeleteButtonsState);
                ampmSelect.addEventListener('change', updateAddDeleteButtonsState);

                addTimeSlotBtn.addEventListener('click', async () => {
                    const newTime = getSelectedTimeSlot();
                    if (!lessonsTimeSlotsArray.includes(newTime)) {
                        lessonsTimeSlotsArray.push(newTime);
                        lessonsTimeSlotsArray.sort((a, b) => convertTo24Hour(a) - convertTo24Hour(b)); // Sort chronologically
                        await saveLessonsTimeSlots();
                        // Re-initialize the lessons table to reflect the new column
                        await generateAttendanceTable(lessonsTableConfig);
                        // Also re-initialize the overview table to ensure calculations are fresh
                        await generateAttendanceTable(overviewTableConfig);
                        // Also re-generate the list of dates of year to reflect new columns
                        await generateAllDatesList(parseInt(document.getElementById('year-select-list').value), document.getElementById('month-select-list').value);
                        updateAddDeleteButtonsState(); // Update button states after addition
                        populateHolidayTimeSlots();
                        populatePenaltyTimeSlots();
                        populateLeaveTimeSlots();
                        updateQuickAttendanceBox(); // Update quick attendance box after slot changes
                    } else {
                        displayMessage("Time slot already exists.", "info");
                    }
                });

                deleteTimeSlotBtn.addEventListener('click', async () => {
                    const timeToDelete = getSelectedTimeSlot();
                    if (lessonsTimeSlotsArray.includes(timeToDelete)) {
                        const confirmDelete = window.confirm(`Are you sure you want to delete the time slot "${timeToDelete}"? This will remove it from all daily records.`);
                        if (!confirmDelete) {
                            displayMessage("Time slot deletion cancelled.", "info");
                            return;
                        }
                        lessonsTimeSlotsArray = lessonsTimeSlotsArray.filter(slot => slot !== timeToDelete);
                        await saveLessonsTimeSlots();
                        // Re-initialize the lessons table to reflect the removed column
                        await generateAttendanceTable(lessonsTableConfig);
                        // Also re-initialize the overview table to ensure calculations are fresh
                        await generateAttendanceTable(overviewTableConfig);
                        // Also re-generate the list of dates of year to reflect removed columns
                        await generateAllDatesList(parseInt(document.getElementById('year-select-list').value), document.getElementById('month-select-list').value);
                        updateAddDeleteButtonsState(); // Update button states after deletion
                        populateHolidayTimeSlots();
                        populatePenaltyTimeSlots();
                        populateLeaveTimeSlots();
                        updateQuickAttendanceBox(); // Update quick attendance box after slot changes
                    } else {
                        displayMessage("Time slot does not exist.", "warning");
                    }
                });

                // Add event listeners for rate input fields
                document.getElementById('am-rate-input').addEventListener('input', updateRatesAndTable);
                document.getElementById('pm-rate-input').addEventListener('input', updateRatesAndTable);
                document.getElementById('gy-rate-input').addEventListener('input', updateRatesAndTable);

                // Initial update of button states after all elements are populated
                updateAddDeleteButtonsState();
                updateQuickAttendanceBox(); // Initial call for quick attendance box
                setInterval(updateQuickAttendanceBox, 60 * 1000); // Update quick attendance box every minute

                // Initial call to update upcoming events box
                updateUpcomingEvents();
                // Update upcoming events every hour (or more frequently if needed)
                setInterval(updateUpcomingEvents, 60 * 60 * 1000);

            } else {
                console.error(" User is not authenticated. Data persistence will not work.");
                document.getElementById('user-id').textContent = 'Authentication Failed';
                isAuthReady = true;
                // Default rest days if not authenticated
                restDaysArray = ['Saturday', 'Sunday'];
                lessonsTimeSlotsArray = [ // Default for unauthenticated state
                    '8:00 PM', '8:30 PM', '9:00 PM', '9:30 PM',
                    '12:00 AM', '12:30 AM', '1:00 AM', '1:30 AM',
                    '2:00 AM', '2:30 AM', '3:00 AM', '3:30 AM', '4:00 AM'
                ];
                // Default rates for unauthenticated state
                shiftRates = { am: 0, pm: 0, gy: 0 };
                // Ensure input fields are reset or show defaults
                document.getElementById('am-rate-input').value = shiftRates.am;
                document.getElementById('pm-rate-input').value = shiftRates.pm;
                document.getElementById('gy-rate-input').value = shiftRates.gy;


                // Initialize Overview attendance table even if not authenticated
                setupAttendanceTableControls(overviewTableConfig);
                setupAttendanceTableControls(lessonsTableConfig);
                await generateAttendanceTable(overviewTableConfig); // Generate with default/empty data
                await generateAttendanceTable(lessonsTableConfig); // Generate with default/empty data
                await setupListOfDatesTable(); // Generate with default/empty data

                // Disable time slot management and rate buttons/inputs if not authenticated
                document.getElementById('add-time-slot-btn').disabled = true;
                document.getElementById('delete-time-slot-btn').disabled = true;
                document.getElementById('am-rate-input').disabled = true;
                document.getElementById('pm-rate-input').disabled = true;
                document.getElementById('gy-rate-input').disabled = true;
                quickPresentBtn.disabled = true;
                quickMissedBtn.disabled = true;
                quickClosedBtn.disabled = true;
                currentActiveSlotDisplay.textContent = 'Auth Required';

                // Update upcoming events box even if not authenticated (will show "No upcoming events")
                updateUpcomingEvents();
            }
        });

        // Add event listener for navigation links
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const pageContents = document.querySelectorAll('.page-content');
            const dataCategorySelect = document.getElementById('data-category-select');
            const holidayForm = document.getElementById('holiday-form');
            const leaveForm = document.getElementById('leave-form');
            const penaltyForm = document.getElementById('penalty-form');
            const subscriberForm = document.getElementById('subscriber-form');

            function showPage(pageId) {
                pageContents.forEach(page => {
                    page.classList.remove('active');
                });
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });

                const targetPage = document.getElementById(pageId);
                if (targetPage) { // Null check for the target page
                    targetPage.classList.add('active');
                } else {
                    console.warn(`Page with ID '${pageId}' not found.`);
                }

                const targetNavLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
                if (targetNavLink) { // Null check for the navigation link
                    targetNavLink.classList.add('active');
                } else {
                    console.warn(`Navigation link with data-page='${pageId}' not found.`);
                }

                // Specific updates for Input Data tab when it's shown
                if (pageId === 'input-data') {
                    // Trigger the change event on dataCategorySelect to show the correct form
                    // if a value is already selected (e.g., on page load if hash points here)
                    const event = new Event('change');
                    dataCategorySelect.dispatchEvent(event);
                }
            }

            // Function to show/hide input forms based on category selection
            function displayCategoryForm() {
                // Hide all forms first
                holidayForm.classList.add('hidden');
                leaveForm.classList.add('hidden');
                penaltyForm.classList.add('hidden');
                subscriberForm.classList.add('hidden');

                const selectedCategory = dataCategorySelect.value;

                if (selectedCategory === 'holiday') {
                    holidayForm.classList.remove('hidden');
                    populateHolidayTimeSlots();
                    calculateHolidayTotal();
                } else if (selectedCategory === 'leave') {
                    leaveForm.classList.remove('hidden');
                    toggleLeaveQuestions(); // This will also call populateLeaveTimeSlots and calculateLeaveTotal
                } else if (selectedCategory === 'penalty') {
                    penaltyForm.classList.remove('hidden');
                    populatePenaltyTimeSlots();
                    calculatePenaltyTotal();
                } else if (selectedCategory === 'subscriber') {
                    subscriberForm.classList.remove('hidden');
                    // No time slots to populate for subscriber form
                }
            }

            // Event listener for the data category dropdown
            dataCategorySelect.addEventListener('change', displayCategoryForm);


            // Show the initial page based on hash or default to overview
            if (window.location.hash) {
                const initialPage = window.location.hash.substring(1);
                if (document.getElementById(initialPage)) {
                    showPage(initialPage);
                } else {
                    showPage('overview'); // Default to overview
                }
            } else {
                showPage('overview'); // Default to overview
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const pageId = event.target.dataset.page;
                    showPage(pageId);
                });
            });

            // Initialize and update clocks
            updateClocks();
            setInterval(updateClocks, 1000); // Update every second
        });
    </script>
</body>
</html>
